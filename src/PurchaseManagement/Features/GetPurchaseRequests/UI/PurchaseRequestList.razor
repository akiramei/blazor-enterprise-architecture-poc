@page "/purchase-requests"
@using MediatR
@using GetPurchaseRequests.Application
@using Domain.PurchaseManagement.PurchaseRequests
@using Domain.PurchaseManagement.PurchaseRequests.Boundaries
@using Shared.Application
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IFilteringBoundary FilteringBoundary

<PageTitle>購買申請一覧</PageTitle>

<h3>購買申請一覧</h3>

<div class="row mb-3">
    <div class="col-md-6">
        <a href="/purchase-requests/submit" class="btn btn-primary">
            新規購買申請
        </a>
    </div>
    <div class="col-md-6">
        <div class="input-group">
            <select class="form-select" @bind="_statusFilter">
                @if (_filterOptions != null)
                {
                    @foreach (var option in _filterOptions.StatusOptions)
                    {
                        <option value="@(option.Value.HasValue ? ((int)option.Value.Value).ToString() : "")"
                                title="@option.Description">
                            @option.Label
                        </option>
                    }
                }
            </select>
            <button class="btn btn-secondary" @onclick="LoadPurchaseRequests">
                フィルター適用
            </button>
        </div>
    </div>
</div>

@if (_isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">読み込み中...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger" role="alert">
        @_errorMessage
    </div>
}
else if (_purchaseRequests == null || !_purchaseRequests.Any())
{
    <div class="alert alert-info" role="alert">
        購買申請が見つかりませんでした。
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th @onclick='() => SortBy("RequestNumber")' style="cursor: pointer;">
                        申請番号
                        @if (_sortBy == "RequestNumber")
                        {
                            <span>@(_ascending ? "▲" : "▼")</span>
                        }
                    </th>
                    <th @onclick='() => SortBy("Title")' style="cursor: pointer;">
                        タイトル
                        @if (_sortBy == "Title")
                        {
                            <span>@(_ascending ? "▲" : "▼")</span>
                        }
                    </th>
                    <th>申請者</th>
                    <th @onclick='() => SortBy("Status")' style="cursor: pointer;">
                        ステータス
                        @if (_sortBy == "Status")
                        {
                            <span>@(_ascending ? "▲" : "▼")</span>
                        }
                    </th>
                    <th @onclick='() => SortBy("TotalAmount")' style="cursor: pointer;">
                        合計金額
                        @if (_sortBy == "TotalAmount")
                        {
                            <span>@(_ascending ? "▲" : "▼")</span>
                        }
                    </th>
                    <th>承認状況</th>
                    <th @onclick='() => SortBy("CreatedAt")' style="cursor: pointer;">
                        作成日時
                        @if (_sortBy == "CreatedAt")
                        {
                            <span>@(_ascending ? "▲" : "▼")</span>
                        }
                    </th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var request in _purchaseRequests)
                {
                    <tr>
                        <td>@request.RequestNumber</td>
                        <td>@request.Title</td>
                        <td>@request.RequesterName</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(request.Status)">
                                @request.StatusName
                            </span>
                        </td>
                        <td>@request.TotalAmount.ToString("N2") @request.Currency</td>
                        <td>
                            @if (request.ApprovalStepCount > 0)
                            {
                                <span>@request.ApprovedStepCount / @request.ApprovalStepCount</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td>@request.CreatedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</td>
                        <td>
                            <button class="btn btn-sm btn-info" @onclick="() => ViewDetail(request.Id)">
                                詳細
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <nav aria-label="ページネーション">
        <ul class="pagination justify-content-center">
            <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => ChangePage(_currentPage - 1)" disabled="@(_currentPage == 1)">
                    前へ
                </button>
            </li>
            <li class="page-item disabled">
                <span class="page-link">ページ @_currentPage</span>
            </li>
            <li class="page-item @(_purchaseRequests.Count < _pageSize ? "disabled" : "")">
                <button class="page-link" @onclick="() => ChangePage(_currentPage + 1)" disabled="@(_purchaseRequests.Count < _pageSize)">
                    次へ
                </button>
            </li>
        </ul>
    </nav>
}

@code {
    private List<PurchaseRequestListItemDto>? _purchaseRequests;
    private FilterOptions? _filterOptions;
    private bool _isLoading = true;
    private string? _errorMessage;

    private string _statusFilter = string.Empty;
    private int _currentPage = 1;
    private int _pageSize = 20;
    private string _sortBy = "CreatedAt";
    private bool _ascending = false;

    protected override async Task OnInitializedAsync()
    {
        // バウンダリー経由でフィルターオプションを取得
        _filterOptions = FilteringBoundary.GetFilterOptions();
        await LoadPurchaseRequests();
    }

    private async Task LoadPurchaseRequests()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var query = new GetPurchaseRequestsQuery
            {
                Status = string.IsNullOrEmpty(_statusFilter) ? null : int.Parse(_statusFilter),
                PageNumber = _currentPage,
                PageSize = _pageSize,
                SortBy = _sortBy,
                Ascending = _ascending
            };

            var result = await Mediator.Send(query);

            if (result.IsSuccess)
            {
                _purchaseRequests = result.Value;
            }
            else
            {
                _errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"予期しないエラーが発生しました: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SortBy(string field)
    {
        if (_sortBy == field)
        {
            _ascending = !_ascending;
        }
        else
        {
            _sortBy = field;
            _ascending = false;
        }

        await LoadPurchaseRequests();
    }

    private async Task ChangePage(int page)
    {
        _currentPage = page;
        await LoadPurchaseRequests();
    }

    private void ViewDetail(Guid id)
    {
        Navigation.NavigateTo($"/purchase-requests/{id}");
    }

    /// <summary>
    /// ステータスバッジクラス取得（バウンダリー経由）
    /// REFACTORED: ステータス表示ロジックをドメイン層のバウンダリーに委譲
    /// </summary>
    private string GetStatusBadgeClass(int status)
    {
        var statusEnum = (PurchaseRequestStatus)status;
        var displayInfo = FilteringBoundary.GetStatusDisplay(statusEnum);
        return displayInfo.BadgeColorClass;
    }
}
