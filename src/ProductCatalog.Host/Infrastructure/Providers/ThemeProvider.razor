@using ProductCatalog.Host.Infrastructure.Models
@using ProductCatalog.Host.Infrastructure.Stores
@using Microsoft.JSInterop
@implements IAsyncDisposable

<CascadingValue Value="this" IsFixed="false">
    @ChildContent
</CascadingValue>

@code {
    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    [Inject]
    private ILogger<ThemeProvider> Logger { get; set; } = default!;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private ThemeState _state = ThemeState.Default;
    private DotNetObjectReference<ThemeProvider>? _dotNetRef;
    private IJSObjectReference? _themeModule;

    public ThemeState State => _state;

    public event Func<Task>? OnChangeAsync;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // JSモジュールを読み込み（テーマ切り替え用）
                _themeModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./Infrastructure/theme.js");

                _dotNetRef = DotNetObjectReference.Create(this);

                // LocalStorageからテーマ設定を読み込み
                await LoadThemeAsync();

                // システムテーマの変更を監視
                await _themeModule.InvokeVoidAsync("initThemeListener", _dotNetRef);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "テーマの初期化に失敗しました");
            }
        }
    }

    private async Task LoadThemeAsync()
    {
        try
        {
            var savedTheme = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "theme-mode");
            var useSystemTheme = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "use-system-theme");

            var mode = savedTheme switch
            {
                "dark" => ThemeMode.Dark,
                "light" => ThemeMode.Light,
                _ => ThemeMode.Light
            };

            _state = new ThemeState
            {
                Mode = mode,
                UseSystemTheme = useSystemTheme != "false", // デフォルトtrue
                IsLoading = false
            };

            await ApplyThemeAsync();
            await NotifyStateChangedAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "テーマの読み込みに失敗しました");
        }
    }

    /// <summary>
    /// テーマモードを設定
    /// </summary>
    public async Task SetThemeModeAsync(ThemeMode mode)
    {
        try
        {
            _state = _state with { Mode = mode };
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "theme-mode", mode.ToString().ToLower());
            await ApplyThemeAsync();
            await NotifyStateChangedAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "テーマモードの設定に失敗しました");
        }
    }

    /// <summary>
    /// システムテーマ使用の切り替え
    /// </summary>
    public async Task SetUseSystemThemeAsync(bool useSystemTheme)
    {
        try
        {
            _state = _state with { UseSystemTheme = useSystemTheme };
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "use-system-theme", useSystemTheme.ToString().ToLower());
            await ApplyThemeAsync();
            await NotifyStateChangedAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "システムテーマ設定の変更に失敗しました");
        }
    }

    /// <summary>
    /// ダークモードに切り替え
    /// </summary>
    public Task SetDarkModeAsync() => SetThemeModeAsync(ThemeMode.Dark);

    /// <summary>
    /// ライトモードに切り替え
    /// </summary>
    public Task SetLightModeAsync() => SetThemeModeAsync(ThemeMode.Light);

    /// <summary>
    /// テーマを切り替え
    /// </summary>
    public Task ToggleThemeAsync() =>
        SetThemeModeAsync(_state.Mode == ThemeMode.Dark ? ThemeMode.Light : ThemeMode.Dark);

    /// <summary>
    /// テーマをDOMに適用
    /// </summary>
    private async Task ApplyThemeAsync()
    {
        if (_themeModule == null) return;

        try
        {
            var systemPrefersDark = await _themeModule.InvokeAsync<bool>("getSystemPrefersDark");
            var effectiveMode = _state.EffectiveMode(systemPrefersDark);

            await _themeModule.InvokeVoidAsync("applyTheme", effectiveMode.ToString().ToLower());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "テーマの適用に失敗しました");
        }
    }

    /// <summary>
    /// JSから呼ばれるコールバック（システムテーマ変更時）
    /// </summary>
    [JSInvokable]
    public async Task OnSystemThemeChanged(bool prefersDark)
    {
        try
        {
            if (_state.UseSystemTheme)
            {
                await ApplyThemeAsync();
                await NotifyStateChangedAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "システムテーマ変更の処理に失敗しました");
        }
    }

    private async Task NotifyStateChangedAsync()
    {
        StateHasChanged();

        if (OnChangeAsync is null) return;

        foreach (var handler in OnChangeAsync.GetInvocationList().Cast<Func<Task>>())
        {
            try
            {
                await handler();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "状態変更通知中にエラーが発生しました");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_themeModule != null)
        {
            await _themeModule.DisposeAsync();
        }

        _dotNetRef?.Dispose();
    }
}
