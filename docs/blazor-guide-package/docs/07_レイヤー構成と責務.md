# 7. VSA構成と責務

[← 目次に戻る](00_README.md)

---

## 7. VSA構成と責務

### 7.1 フォルダ構造

**Vertical Slice Architecture: モノリシック単一プロジェクト**

```
/src
├── Application/                       # 単一Blazorプロジェクト
│   ├── Program.cs                     # エントリーポイント
│   ├── Features/                      # 機能スライス（19機能）
│   │   ├── CreateProduct/             # 機能スライス1
│   │   │   ├── CreateProductCommand.cs
│   │   │   ├── CreateProductCommandHandler.cs
│   │   │   └── UI/
│   │   │       └── Api/
│   │   │           └── Dtos/
│   │   │
│   │   ├── GetProducts/               # 機能スライス2
│   │   │   ├── GetProductsQuery.cs
│   │   │   ├── GetProductsQueryHandler.cs
│   │   │   └── UI/
│   │   │       ├── Api/
│   │   │       ├── Components/
│   │   │       └── ProductList.razor
│   │   │
│   │   ├── UpdateProduct/             # 機能スライス3
│   │   ├── DeleteProduct/             # 機能スライス4
│   │   ├── GetProductById/            # 機能スライス5
│   │   ├── SearchProducts/            # 機能スライス6
│   │   ├── BulkDeleteProducts/        # 機能スライス7
│   │   ├── BulkUpdateProductPrices/   # 機能スライス8
│   │   ├── ExportProductsToCsv/       # 機能スライス9
│   │   ├── ImportProductsFromCsv/     # 機能スライス10
│   │   └── ... (全19機能)
│   │
│   ├── Shared/                        # BC別共通コード
│   │   ├── ProductCatalog/            # ProductCatalogBC共通
│   │   │   ├── Application/
│   │   │   │   └── DTOs/              # ProductDto等
│   │   │   ├── Infrastructure/
│   │   │   │   └── Persistence/
│   │   │   │       ├── ProductCatalogDbContext.cs
│   │   │   │       ├── Configurations/
│   │   │   │       └── Repositories/
│   │   │   └── UI/
│   │   │       ├── Actions/           # ProductListActions等
│   │   │       └── Store/             # ProductsStore等
│   │   └── PurchaseManagement/        # PurchaseManagementBC共通
│   │
│   ├── Components/                    # Blazor共通コンポーネント
│   │   ├── Layout/
│   │   └── Pages/
│   ├── Hubs/                          # SignalR Hubs
│   └── Infrastructure/                # アプリケーション基盤
│
├── Domain/                            # ドメインプロジェクト（分離）
│   ├── ProductCatalog/
│   │   └── Products/                  # Product集約
│   │       ├── Product.cs
│   │       └── IProductRepository.cs
│   └── PurchaseManagement/
│
└── Shared/                            # グローバル共通（全BC共有）
    ├── Kernel/                        # AggregateRoot, Entity等
    ├── Application/                   # ICommand, IQuery等
    └── Infrastructure/                # Pipeline Behaviors等
```

**重要な構造の違い:**
- **単一Applicationプロジェクト**: すべての機能とインフラを1つのプロジェクトに集約
- **各機能（CreateProduct, GetProducts等）はCommand/Query/Handler + UIのみ**
- **Domain層はプロジェクトとして分離**（純粋なビジネスロジックを保護）
- **Application/Shared/{BC}/に各BCの共通コード**（DbContext, Repository, Store等）
- この構造は「共通ドメインパターン」と呼ばれ、VSAの実用的な変形です

### 7.2 各層の責務詳細（機能スライス内）

#### **UI層 (各機能の UI/)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Dumb Component** | 表示のみ | なし | 状態管理、I/O、ビジネスロジック |
| **Smart Component** | イベント委譲、状態購読 | Actions, Store | I/O、ビジネスロジック |
| **PageActions** | UI手順のオーケストレーション | Store, Dialog, Toast | I/O(Storeに委譲) |
| **Store** | 状態管理、I/O実行 | IServiceScopeFactory, IMediator | ビジネスロジック |
| **State** | 画面状態の単一ソース | なし | ミューテーション |

#### **Application層 (各機能の Application/)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Command** | 書き込み要求の定義 | なし | ロジック |
| **Query** | 読み取り要求の定義 | なし | ロジック |
| **Handler** | ユースケースの実行 | 機能内のRepository, Domain | 他の機能への依存 |
| **Validator** | 入力検証 | なし | ビジネスルール(Domainに委譲) |

#### **Domain層 (各機能の Domain/)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Aggregate** | ビジネスルールの保護 | Value Object | Infrastructure依存、他機能依存 |
| **Entity** | 識別子を持つオブジェクト | Value Object | 直接DB操作 |
| **Value Object** | 不変な値 | なし | ミューテーション |
| **Domain Event** | ドメイン内の出来事 | なし | 外部システム依存 |
| **Repository Interface** | 永続化の抽象 | なし | 実装詳細 |

#### **Infrastructure層 (各機能の Infrastructure/)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Repository** | 集約の永続化 | 機能内のDomain | ビジネスロジック、他機能依存 |
| **ReadDao** | 読み取り最適化 | Dapper/EF | 書き込み |
| **DbContext Configuration** | EF Coreの設定 | 機能内のDomain | 他機能のEntity設定 |

#### **Shared層 (機能間で共有)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Behavior** | 横断的関心事 | 下流のHandler | 特定機能への依存 |
| **Base Classes** | 共通基底クラス | なし | 特定機能への依存 |
| **Outbox** | 統合イベント配信 | Message Broker | 同期処理 |

---

### 7.3 VSAの重要な原則

#### **機能の独立性**

```
✅ 正しい:
- 機能追加時は1つのFeatureフォルダ内のみ変更
- 機能間の直接参照は禁止
- 共通機能はSharedに配置

❌ 間違い:
- CreateProduct から UpdateProduct を直接参照
- 複数の機能フォルダをまたがる変更
```

#### **依存方向**

```
機能内の依存方向:
UI → Application → Domain ← Infrastructure

機能間の依存:
各機能 → Shared のみ許可
各機能 ↔ 他の機能 は禁止
```

---
