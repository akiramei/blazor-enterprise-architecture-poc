# 5. レイヤー構成と責務

[← 目次に戻る](00_README.md)

---

## 5. レイヤー構成と責務

### 5.1 フォルダ構造

```
/src
├── YourApp.Web                    # Blazor UI層
│   ├── Components/
│   │   └── Products/              # 機能別スライス
│   │       ├── Pages/
│   │       │   └── ProductList.razor
│   │       ├── Actions/
│   │       │   └── ProductListActions.cs
│   │       ├── Store/
│   │       │   ├── ProductsStore.cs
│   │       │   └── ProductsState.cs
│   │       └── _Shared/           # Dumbコンポーネント
│   │           └── ProductCard.razor
│   ├── Hubs/
│   │   └── ProductsHub.cs         # SignalR
│   └── Program.cs
│
├── YourApp.Application            # Application層
│   ├── Common/
│   │   ├── Behaviors/             # MediatR Behaviors
│   │   │   ├── LoggingBehavior.cs
│   │   │   ├── ValidationBehavior.cs
│   │   │   ├── AuthorizationBehavior.cs
│   │   │   ├── IdempotencyBehavior.cs
│   │   │   ├── CachingBehavior.cs
│   │   │   └── TransactionBehavior.cs
│   │   └── Interfaces/
│   │       ├── ICommand.cs
│   │       └── IQuery.cs
│   └── Features/
│       └── Products/              # 機能別スライス
│           ├── UseCases/
│           │   ├── DeleteProduct/
│           │   │   ├── DeleteProductCommand.cs
│           │   │   ├── DeleteProductHandler.cs
│           │   │   └── DeleteProductValidator.cs
│           │   └── GetProducts/
│           │       ├── GetProductsQuery.cs
│           │       ├── GetProductsHandler.cs
│           │       └── ProductDto.cs
│           └── Events/
│               ├── ProductDeletedEvent.cs
│               └── ProductDeletedEventHandler.cs
│
├── YourApp.Domain                 # Domain層
│   ├── Common/
│   │   ├── AggregateRoot.cs
│   │   ├── Entity.cs
│   │   ├── ValueObject.cs
│   │   └── DomainEvent.cs
│   └── Products/
│       ├── Product.cs             # 集約ルート
│       ├── ProductId.cs           # Value Object
│       ├── Money.cs
│       ├── ProductImage.cs
│       ├── IProductRepository.cs  # インターフェース
│       └── Events/
│           └── ProductDeletedDomainEvent.cs
│
└── YourApp.Infrastructure         # Infrastructure層
    ├── Persistence/
    │   ├── AppDbContext.cs
    │   ├── Configurations/
    │   │   └── ProductConfiguration.cs
    │   └── Repositories/
    │       └── EfProductRepository.cs
    ├── ReadModels/
    │   └── DapperProductReadDao.cs
    ├── Outbox/
    │   ├── OutboxMessage.cs
    │   └── OutboxDispatcher.cs
    ├── Idempotency/
    │   ├── IdempotencyRecord.cs
    │   └── EfIdempotencyStore.cs
    ├── Inbox/
    │   ├── InboxMessage.cs
    │   └── EfInboxStore.cs
    └── Saga/
        ├── OrderProcessSaga.cs
        └── EfSagaRepository.cs
```

### 5.2 各層の責務詳細

#### **UI層 (YourApp.Web)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Dumb Component** | 表示のみ | なし | 状態管理、I/O、ビジネスロジック |
| **Smart Component** | イベント委譲、状態購読 | Actions, Store | I/O、ビジネスロジック |
| **PageActions** | UI手順のオーケストレーション | Store, Dialog, Toast | I/O(Storeに委譲) |
| **Store** | 状態管理、I/O実行 | IServiceScopeFactory, IMediator | ビジネスロジック |
| **State** | 画面状態の単一ソース | なし | ミューテーション |

#### **Application層 (YourApp.Application)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Command** | 書き込み要求の定義 | なし | ロジック |
| **Query** | 読み取り要求の定義 | なし | ロジック |
| **Handler** | ユースケースの実行 | Repository, Domain | UI依存 |
| **Validator** | 入力検証 | なし | ビジネスルール(Domainに委譲) |
| **Behavior** | 横断的関心事 | 下流のHandler | 特定機能への依存 |

#### **Domain層 (YourApp.Domain)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Aggregate** | ビジネスルールの保護 | Value Object | Infrastructure依存 |
| **Entity** | 識別子を持つオブジェクト | Value Object | 直接DB操作 |
| **Value Object** | 不変な値 | なし | ミューテーション |
| **Domain Event** | ドメイン内の出来事 | なし | 外部システム依存 |
| **Repository Interface** | 永続化の抽象 | なし | 実装詳細 |

#### **Infrastructure層 (YourApp.Infrastructure)**

| コンポーネント | 責務 | 依存先 | 禁止事項 |
|---------------|------|--------|---------|
| **Repository** | 集約の永続化 | DbContext | ビジネスロジック |
| **ReadDao** | 読み取り最適化 | Dapper/EF | 書き込み |
| **DbContext** | データベース管理 | EF Core | ビジネスロジック |
| **Outbox** | 統合イベント配信 | Message Broker | 同期処理 |

---
