# 15. テスト戦略

[← 目次に戻る](00_README.md)

---

## 15. テスト戦略

### 13.1 テストピラミッド

```
        ┌─────────────┐
        │  E2E Tests  │  ← 少数の重要な統合シナリオのみ
        │   (5-10%)   │
        ├─────────────┤
        │ Integration │  ← パイプライン全体とDB連携のテスト
        │    Tests    │
        │   (30%)     │
        ├─────────────┤
        │    Unit     │  ← Domain、Handler、Actionsの単体テスト
        │    Tests    │
        │   (60%)     │
        └─────────────┘
```

### 13.2 Unit Tests

#### **Domain層のテスト**

```csharp
public class ProductTests
{
    [Fact]
    public void Delete_在庫あり_例外()
    {
        // Arrange
        var product = Product.Create(
            ProductId.New(),
            "テスト商品",
            "説明",
            new Money(1000),
            initialStock: 10);
        
        // Act & Assert
        var ex = Assert.Throws<DomainException>(() => product.Delete());
        Assert.Equal("在庫がある商品は削除できません", ex.Message);
    }
    
    [Fact]
    public void ChangeName_空文字_例外()
    {
        // Arrange
        var product = Product.Create(...);
        
        // Act & Assert
        Assert.Throws<DomainException>(() => product.ChangeName(""));
    }
    
    [Fact]
    public void ChangePrice_50%以上の値下げ_公開中は例外()
    {
        // Arrange
        var product = Product.Create(..., price: new Money(1000), ...);
        product.Publish();
        
        // Act & Assert
        var ex = Assert.Throws<DomainException>(() => 
            product.ChangePrice(new Money(400)));
        
        Assert.Contains("50%以上の値下げ", ex.Message);
    }
}
```

#### **Handler層のテスト**

```csharp
public class DeleteProductHandlerTests
{
    [Fact]
    public async Task Handle_商品が存在する_削除成功()
    {
        // Arrange
        var productId = ProductId.New();
        var product = Product.Create(productId, "商品", "説明", new Money(1000), 0);
        
        var repoMock = new Mock<IProductRepository>();
        repoMock.Setup(r => r.GetAsync(productId, It.IsAny<CancellationToken>()))
            .ReturnsAsync(product);
        
        var handler = new DeleteProductHandler(repoMock.Object, Mock.Of<ILogger<DeleteProductHandler>>());
        var command = new DeleteProductCommand(productId.Value);
        
        // Act
        var result = await handler.Handle(command, CancellationToken.None);
        
        // Assert
        Assert.True(result.IsSuccess);
        repoMock.Verify(r => r.SaveAsync(product, It.IsAny<CancellationToken>()), Times.Once);
    }
    
    [Fact]
    public async Task Handle_商品が存在しない_失敗()
    {
        // Arrange
        var repoMock = new Mock<IProductRepository>();
        repoMock.Setup(r => r.GetAsync(It.IsAny<ProductId>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync((Product?)null);
        
        var handler = new DeleteProductHandler(repoMock.Object, Mock.Of<ILogger<DeleteProductHandler>>());
        var command = new DeleteProductCommand(Guid.NewGuid());
        
        // Act
        var result = await handler.Handle(command, CancellationToken.None);
        
        // Assert
        Assert.False(result.IsSuccess);
        Assert.Equal("商品が見つかりません", result.Error);
    }
}
```

#### **PageActionsのテスト**

```csharp
public class ProductListActionsTests
{
    [Fact]
    public async Task DeleteAsync_ユーザーがキャンセル_Storeを呼ばない()
    {
        // Arrange
        var storeMock = new Mock<ProductsStore>(MockBehavior.Strict);
        var confirmMock = new Mock<IConfirmDialog>();
        confirmMock.Setup(x => x.ShowAsync(
            It.IsAny<string>(),
            It.IsAny<string>(),
            It.IsAny<string>(),
            It.IsAny<string>()))
            .ReturnsAsync(false);  // キャンセル
        
        var actions = new ProductListActions(
            storeMock.Object,
            confirmMock.Object,
            Mock.Of<IToast>(),
            Mock.Of<NavigationManager>(),
            Mock.Of<ILogger<ProductListActions>>());
        
        // Act
        await actions.DeleteAsync(Guid.NewGuid());
        
        // Assert
        storeMock.Verify(
            x => x.DeleteAsync(It.IsAny<Guid>(), It.IsAny<CancellationToken>()),
            Times.Never);
    }
}
```

### 13.3 Integration Tests

```csharp
public class DeleteProductIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly WebApplicationFactory<Program> _factory;
    
    public DeleteProductIntegrationTests(WebApplicationFactory<Program> factory)
    {
        _factory = factory;
    }
    
    [Fact]
    public async Task DeleteProduct_エンドツーエンド_成功()
    {
        // Arrange
        using var scope = _factory.Services.CreateScope();
        var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();
        
        var product = Product.Create(
            ProductId.New(),
            "テスト商品",
            "説明",
            new Money(1000),
            0);
        
        context.Products.Add(product);
        await context.SaveChangesAsync();
        
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var command = new DeleteProductCommand(product.Id.Value);
        
        // Act
        var result = await mediator.Send(command);
        
        // Assert
        Assert.True(result.IsSuccess);
        
        var deletedProduct = await context.Products.FindAsync(product.Id);
        Assert.Null(deletedProduct);
    }
}
```

### 13.4 E2E Tests (bUnit)

```csharp
public class ProductListComponentTests : TestContext
{
    [Fact]
    public void ProductList_初期表示_ローディング表示()
    {
        // Arrange
        var storeMock = new Mock<ProductsStore>();
        storeMock.Setup(s => s.GetState())
            .Returns(new ProductsState { IsLoading = true });
        
        Services.AddSingleton(storeMock.Object);
        Services.AddSingleton(Mock.Of<ProductListActions>());
        
        // Act
        var cut = RenderComponent<ProductList>();
        
        // Assert
        cut.Find(".loading-indicator").Should().NotBeNull();
    }
    
    [Fact]
    public void ProductList_削除ボタンクリック_Actionsを呼ぶ()
    {
        // Arrange
        var productId = Guid.NewGuid();
        var actionsMock = new Mock<ProductListActions>();
        
        var storeMock = new Mock<ProductsStore>();
        storeMock.Setup(s => s.GetState())
            .Returns(new ProductsState
            {
                Products = ImmutableList.Create(
                    new ProductDto(productId, "商品", 1000, "JPY", 10, "Published", 1))
            });
        
        Services.AddSingleton(storeMock.Object);
        Services.AddSingleton(actionsMock.Object);
        
        // Act
        var cut = RenderComponent<ProductList>();
        cut.Find(".btn-danger").Click();
        
        // Assert
        actionsMock.Verify(a => a.DeleteAsync(productId, It.IsAny<CancellationToken>()), Times.Once);
    }
}
```

---
