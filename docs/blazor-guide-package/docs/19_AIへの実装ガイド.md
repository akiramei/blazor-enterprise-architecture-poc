# 19. AIã¸ã®å®Ÿè£…ã‚¬ã‚¤ãƒ‰

[â† ç›®æ¬¡ã«æˆ»ã‚‹](00_README.md)

---

## ğŸ¤– ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€AIãŒã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã—ã¦**æ­£ã—ãå®Ÿè£…ã‚’ç”Ÿæˆã™ã‚‹**ãŸã‚ã®å®Ÿè·µçš„ãªæŒ‡é‡ã§ã™ã€‚

---

## ğŸ“‹ å®Ÿè£…ã®åŸºæœ¬ãƒ•ãƒ­ãƒ¼

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç‰¹å®šã™ã‚‹

```mermaid
graph LR
    A[æ©Ÿèƒ½è¦æ±‚ã‚’å—ã‘å–ã‚‹] --> B{æ©Ÿèƒ½ã®æ€§è³ªã¯?}
    B -->|ãƒ‡ãƒ¼ã‚¿å–å¾—| C[å‚ç…§ç³»ãƒ‘ã‚¿ãƒ¼ãƒ³]
    B -->|ãƒ‡ãƒ¼ã‚¿å¤‰æ›´| D[æ›´æ–°ç³»ãƒ‘ã‚¿ãƒ¼ãƒ³]
    C --> E[é©åˆ‡ãªQueryãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ]
    D --> F[é©åˆ‡ãªCommandãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ]
    E --> G[å®Ÿè£…é–‹å§‹]
    F --> G
```

**ä¾‹:**
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œå•†å“ã®ä¾¡æ ¼ã‚’å¤‰æ›´ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã€
AIåˆ¤æ–­: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ â†’ æ›´æ–°ç³»ãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ UpdateProductãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‚ç…§
```

### ã‚¹ãƒ†ãƒƒãƒ—2: å‚ç…§ã™ã¹ããƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®šã™ã‚‹

**ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ±ºã¾ã£ãŸã‚‰ã€å¯¾å¿œã™ã‚‹æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§:**

```
src/ProductCatalog/Features/UpdateProduct/
â”œâ”€â”€ Application/
â”‚   â”œâ”€â”€ UpdateProductCommand.cs      â† Commandã®å®šç¾©ã‚’å­¦ã¶
â”‚   â”œâ”€â”€ UpdateProductHandler.cs      â† ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æµã‚Œã‚’å­¦ã¶
â”‚   â””â”€â”€ UpdateProductValidator.cs    â† å…¥åŠ›æ¤œè¨¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã¶
â”œâ”€â”€ Domain/
â”‚   â””â”€â”€ Product.cs                   â† ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’å­¦ã¶
â”œâ”€â”€ Infrastructure/
â”‚   â””â”€â”€ EfProductRepository.cs       â† æ°¸ç¶šåŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã¶
â””â”€â”€ UI/
    â””â”€â”€ UpdateProductPage.razor      â† UIå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ã¶
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚³ãƒ¼ãƒ‰å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€

**å„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™:**

```csharp
/// <summary>
/// å•†å“æ›´æ–°Command
///
/// ã€ãƒ‘ã‚¿ãƒ¼ãƒ³: æ›´æ–°ç³»Commandã€‘
///
/// ä½¿ç”¨ã‚·ãƒŠãƒªã‚ª:                    â† ã„ã¤ä½¿ã†ã‹
/// - æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®éƒ¨åˆ†çš„ãªå¤‰æ›´ãŒå¿…è¦ãªå ´åˆ
/// - æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ãŒå¿…è¦ãªå ´åˆ
///
/// å®Ÿè£…ã‚¬ã‚¤ãƒ‰:                      â† å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹
/// - å¿…ãšVersionã‚’å«ã‚ã¦æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ã‚’å®Ÿè£…
/// - éƒ¨åˆ†æ›´æ–°ã®å ´åˆã¯ã€å¤‰æ›´ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
///
/// AIå®Ÿè£…æ™‚ã®æ³¨æ„:                  â† AIãŒç‰¹ã«æ³¨æ„ã™ã¹ãã“ã¨
/// - Handlerå†…ã§Entity.ChangeXxx()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶
/// - ç›´æ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤‰æ›´ã—ãªã„
/// </summary>
```

**ã“ã‚Œã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¿…ãšèª­ã‚“ã§ã‹ã‚‰å®Ÿè£…ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚**

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é©ç”¨ã™ã‚‹

**ä¾‹: ã€Œæ³¨æ–‡ï¼ˆOrderï¼‰ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é©ç”¨**

```
å‚ç…§: UpdateProduct/
  â†“ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡º
  â†“
é©ç”¨: UpdateOrder/
  â”œâ”€â”€ UpdateOrderCommand.cs
  â”‚   public sealed record UpdateOrderCommand(
  â”‚       Guid OrderId,
  â”‚       OrderStatus Status,
  â”‚       string ShippingAddress,
  â”‚       long Version  â† æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ç¿’ï¼‰
  â”‚   ) : ICommand<Result>
  â”‚   {
  â”‚       public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
  â”‚       â†‘ å†ªç­‰æ€§ã‚­ãƒ¼ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ç¿’ï¼‰
  â”‚   }
  â”‚
  â”œâ”€â”€ UpdateOrderHandler.cs
  â”‚   public async Task<Result> Handle(UpdateOrderCommand command, CancellationToken ct)
  â”‚   {
  â”‚       var order = await _repository.GetAsync(new OrderId(command.OrderId), ct);
  â”‚
  â”‚       if (order.Version != command.Version)  â† ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ç¿’
  â”‚           return Result.Fail("ç«¶åˆãŒç™ºç”Ÿã—ã¾ã—ãŸ");
  â”‚
  â”‚       order.ChangeStatus(command.Status);    â† Domainãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ç¿’ï¼‰
  â”‚       order.ChangeShippingAddress(command.ShippingAddress);
  â”‚
  â”‚       await _repository.SaveAsync(order, ct);
  â”‚       return Result.Success();
  â”‚   }
  â”‚
  â””â”€â”€ UpdateOrderValidator.cs
      public class UpdateOrderValidator : AbstractValidator<UpdateOrderCommand>
      {
          public UpdateOrderValidator()
          {
              RuleFor(x => x.OrderId).NotEmpty();  â† ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å­¦ç¿’
              RuleFor(x => x.Version).GreaterThan(0);
          }
      }
```

---

## âš ï¸ ã‚ˆãã‚ã‚‹å®Ÿè£…ãƒŸã‚¹ï¼ˆã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

### âŒ ãƒŸã‚¹1: Handlerå†…ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã

**æ‚ªã„ä¾‹:**
```csharp
public async Task<Result> Handle(UpdateProductCommand command, CancellationToken ct)
{
    var product = await _repository.GetAsync(...);

    // âŒ ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒHandlerå†…ã«ï¼
    if (product.Status == ProductStatus.Published && command.Price < product.Price * 0.5m)
    {
        return Result.Fail("å…¬é–‹ä¸­ã®å•†å“ã¯50%ä»¥ä¸Šå€¤ä¸‹ã’ã§ãã¾ã›ã‚“");
    }

    product.Price = command.Price;  // âŒ ç›´æ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¤‰æ›´

    await _repository.SaveAsync(product, ct);
    return Result.Success();
}
```

**è‰¯ã„ä¾‹:**
```csharp
public async Task<Result> Handle(UpdateProductCommand command, CancellationToken ct)
{
    var product = await _repository.GetAsync(...);

    try
    {
        // âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã ã‘
        product.ChangePrice(new Money(command.Price));
    }
    catch (DomainException ex)
    {
        // âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ä¾‹å¤–ã‚’Resultã«å¤‰æ›
        return Result.Fail(ex.Message);
    }

    await _repository.SaveAsync(product, ct);
    return Result.Success();
}
```

**ãªãœï¼Ÿ**
- ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¯**Domainå±¤**ã«å®Ÿè£…ã™ã‚‹
- Handler ã¯**ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ã®ã¿ï¼ˆå–å¾—â†’ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—â†’ä¿å­˜ï¼‰

---

### âŒ ãƒŸã‚¹2: Validatorã§ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’æ¤œè¨¼ã™ã‚‹

**æ‚ªã„ä¾‹:**
```csharp
public class UpdateProductValidator : AbstractValidator<UpdateProductCommand>
{
    public UpdateProductValidator()
    {
        RuleFor(x => x.ProductId).NotEmpty();  // âœ… OKï¼ˆå…¥åŠ›æ¤œè¨¼ï¼‰

        RuleFor(x => x.Price)
            .GreaterThan(0)  // âœ… OKï¼ˆå…¥åŠ›æ¤œè¨¼ï¼‰
            .Must((command, price) =>
            {
                // âŒ ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’Validatorã§æ¤œè¨¼ï¼
                // ã€Œåœ¨åº«ãŒã‚ã‚‹å•†å“ã¯ä¾¡æ ¼ã‚’ä¸‹ã’ã‚‰ã‚Œãªã„ã€ãªã©ã®ãƒ«ãƒ¼ãƒ«
                var product = _repository.GetAsync(...).Result;
                return product.Stock == 0 || price >= product.Price;
            });
    }
}
```

**è‰¯ã„ä¾‹:**
```csharp
public class UpdateProductValidator : AbstractValidator<UpdateProductCommand>
{
    public UpdateProductValidator()
    {
        // âœ… å…¥åŠ›æ¤œè¨¼ã®ã¿
        RuleFor(x => x.ProductId).NotEmpty();
        RuleFor(x => x.Price).GreaterThan(0).WithMessage("ä¾¡æ ¼ã¯0ã‚ˆã‚Šå¤§ãã„å¿…è¦ãŒã‚ã‚Šã¾ã™");
        RuleFor(x => x.Stock).GreaterThanOrEqualTo(0).WithMessage("åœ¨åº«ã¯0ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™");
        RuleFor(x => x.Version).GreaterThan(0);
    }
}

// ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¯Domainå±¤ã§
public sealed class Product : AggregateRoot<ProductId>
{
    public void ChangePrice(Money newPrice)
    {
        // âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«
        if (_status == ProductStatus.Published)
        {
            var discountRate = 1 - (newPrice.Amount / _price.Amount);
            if (discountRate > 0.5m)
                throw new DomainException("å…¬é–‹ä¸­ã®å•†å“ã¯50%ä»¥ä¸Šã®å€¤ä¸‹ã’ã¯ã§ãã¾ã›ã‚“");
        }

        _price = newPrice;
    }
}
```

**ãªãœï¼Ÿ**
- **Validator**: å…¥åŠ›å€¤ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆnullã€ç¯„å›²ã€é•·ã•ãªã©ï¼‰
- **Domain**: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®æ¤œè¨¼ï¼ˆçŠ¶æ…‹ã«å¿œã˜ãŸåˆ¶ç´„ãªã©ï¼‰

---

### âŒ ãƒŸã‚¹3: æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ã‚’å¿˜ã‚Œã‚‹

**æ‚ªã„ä¾‹:**
```csharp
// Commandå®šç¾©
public sealed record UpdateProductCommand(
    Guid ProductId,
    string Name,
    decimal Price
    // âŒ VersionãŒãªã„ï¼
) : ICommand<Result>;

// Handler
public async Task<Result> Handle(UpdateProductCommand command, CancellationToken ct)
{
    var product = await _repository.GetAsync(...);

    // âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ãªã—
    product.ChangeName(command.Name);
    product.ChangePrice(new Money(command.Price));

    await _repository.SaveAsync(product, ct);  // âŒ ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¤‰æ›´ã‚’ä¸Šæ›¸ãã™ã‚‹ãƒªã‚¹ã‚¯
    return Result.Success();
}
```

**è‰¯ã„ä¾‹:**
```csharp
// Commandå®šç¾©
public sealed record UpdateProductCommand(
    Guid ProductId,
    string Name,
    decimal Price,
    long Version  // âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å«ã‚ã‚‹
) : ICommand<Result>;

// Handler
public async Task<Result> Handle(UpdateProductCommand command, CancellationToken ct)
{
    var product = await _repository.GetAsync(...);

    // âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    if (product.Version != command.Version)
    {
        return Result.Fail("ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚");
    }

    product.ChangeName(command.Name);
    product.ChangePrice(new Money(command.Price));

    await _repository.SaveAsync(product, ct);
    return Result.Success();
}
```

---

### âŒ ãƒŸã‚¹4: IdempotencyKeyã‚’å¿˜ã‚Œã‚‹

**æ‚ªã„ä¾‹:**
```csharp
// âŒ IdempotencyKeyãŒãªã„
public sealed record CreateProductCommand(
    string Name,
    string Description,
    decimal Price
) : ICommand<Result<Guid>>;
```

**è‰¯ã„ä¾‹:**
```csharp
// âœ… IdempotencyKeyã‚’å«ã‚ã‚‹
public sealed record CreateProductCommand(
    string Name,
    string Description,
    decimal Price
) : ICommand<Result<Guid>>
{
    public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
}
```

**ãªãœï¼Ÿ**
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©ã§ãƒªãƒˆãƒ©ã‚¤ã•ã‚ŒãŸå ´åˆã®**é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢**
- IdempotencyBehaviorãŒè‡ªå‹•çš„ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹

---

### âŒ ãƒŸã‚¹5: Domainå±¤ã§Infrastructureä¾å­˜ã™ã‚‹

**æ‚ªã„ä¾‹:**
```csharp
// Domainå±¤
public sealed class Product : AggregateRoot<ProductId>
{
    private readonly IProductRepository _repository;  // âŒ Repositoryä¾å­˜
    private readonly IEmailService _emailService;     // âŒ Infrastructureä¾å­˜

    public void Delete()
    {
        if (_stock > 0)
            throw new DomainException("åœ¨åº«ãŒã‚ã‚‹å•†å“ã¯å‰Šé™¤ã§ãã¾ã›ã‚“");

        _isDeleted = true;

        // âŒ Domainå±¤ã‹ã‚‰ç›´æ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        _emailService.SendAsync("admin@example.com", "å•†å“ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ");
    }
}
```

**è‰¯ã„ä¾‹:**
```csharp
// Domainå±¤
public sealed class Product : AggregateRoot<ProductId>
{
    public void Delete()
    {
        if (_stock > 0)
            throw new DomainException("åœ¨åº«ãŒã‚ã‚‹å•†å“ã¯å‰Šé™¤ã§ãã¾ã›ã‚“");

        _isDeleted = true;

        // âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã ã‘
        RaiseDomainEvent(new ProductDeletedDomainEvent(Id, _name));
    }
}

// Applicationå±¤
public sealed class ProductDeletedEventHandler : INotificationHandler<ProductDeletedDomainEvent>
{
    private readonly IEmailService _emailService;

    public async Task Handle(ProductDeletedDomainEvent notification, CancellationToken ct)
    {
        // âœ… Applicationå±¤ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        await _emailService.SendAsync("admin@example.com", "å•†å“ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ");
    }
}
```

**ãªãœï¼Ÿ**
- **Domainå±¤ã¯ç´”ç²‹ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿**
- Infrastructureä¾å­˜ï¼ˆDBã€ãƒ¡ãƒ¼ãƒ«ã€å¤–éƒ¨APIï¼‰ã¯Application/Infrastructureå±¤ã§å‡¦ç†

---

## ğŸ¯ ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### å‚ç…§ç³»ï¼ˆQueryï¼‰ã®å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Queryã¯ `IQuery<TResponse>` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] Queryã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆ`record` ã§å®šç¾©ï¼‰
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¿…è¦ãªå ´åˆã€`ICacheableQuery` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] `GetCacheKey()` ãŒä¸€æ„ãªã‚­ãƒ¼ã‚’è¿”ã—ã¦ã„ã‚‹
- [ ] Handlerã¯ `IRequestHandler<TQuery, TResponse>` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] Handlerã¯**èª­ã¿å–ã‚Šå°‚ç”¨**ï¼ˆRepositoryã® `GetAsync` ã®ã¿å‘¼ã¶ï¼‰
- [ ] è¤‡é›‘ãªã‚¯ã‚¨ãƒªã¯Dapperã§æœ€é©åŒ–ã—ã¦ã„ã‚‹
- [ ] ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆã€Page/PageSizeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹
- [ ] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ã¯`nullè¨±å®¹`ã§ã€nullã®å ´åˆã¯æ¡ä»¶ãªã—

**å‚ç…§å®Ÿè£…:**
- `GetProductsQuery/Handler`
- `GetProductByIdQuery/Handler`
- `SearchProductsQuery/Handler`

---

### æ›´æ–°ç³»ï¼ˆCommandï¼‰ã®å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### Commandå®šç¾©

- [ ] Commandã¯ `ICommand<TResponse>` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] Commandã¯ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆ`record` ã§å®šç¾©ï¼‰
- [ ] **IdempotencyKeyãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ã‚’å«ã‚ã¦ã„ã‚‹
- [ ] æ›´æ–°ã®å ´åˆã€**Versionãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ã‚’å«ã‚ã¦ã„ã‚‹ï¼ˆæ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ï¼‰
- [ ] ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å¿…è¦æœ€å°é™ï¼ˆä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚ãªã„ï¼‰

#### Validator

- [ ] Validatorã¯ `AbstractValidator<TCommand>` ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹
- [ ] å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆ`NotEmpty`, `NotNull`ï¼‰ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ`GreaterThan`, `Length`ï¼‰ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] **ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¯å«ã‚ã¦ã„ãªã„**ï¼ˆDomainå±¤ã«å§”è­²ï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ï¼ˆ`WithMessage`ï¼‰

#### Handler

- [ ] Handlerã¯ `IRequestHandler<TCommand, TResponse>` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] RepositoryçµŒç”±ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å–å¾—ã—ã¦ã„ã‚‹
- [ ] ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€`Result.Fail` ã‚’è¿”ã—ã¦ã„ã‚‹
- [ ] æ›´æ–°ã®å ´åˆã€**Versionãƒã‚§ãƒƒã‚¯**ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹
- [ ] **Domainãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±**ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ï¼ˆç›´æ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ã—ãªã„ï¼‰
- [ ] `DomainException` ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦ `Result.Fail` ã«å¤‰æ›ã—ã¦ã„ã‚‹
- [ ] RepositoryçµŒç”±ã§ä¿å­˜ã—ã¦ã„ã‚‹
- [ ] æˆåŠŸæ™‚ã¯ `Result.Success` ã‚’è¿”ã—ã¦ã„ã‚‹

**å‚ç…§å®Ÿè£…:**
- `CreateProductCommand/Handler/Validator`
- `UpdateProductCommand/Handler/Validator`
- `DeleteProductCommand/Handler/Validator`

---

### Domainå±¤ã®å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### é›†ç´„ãƒ«ãƒ¼ãƒˆï¼ˆAggregateRootï¼‰

- [ ] `AggregateRoot<TId>` ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹
- [ ] ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã™ã¹ã¦ `private` ã§å®šç¾©ã—ã¦ã„ã‚‹
- [ ] å…¬é–‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆgetter ã®ã¿ï¼‰
- [ ] EF Coreç”¨ã® `private` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒã‚ã‚‹
- [ ] ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ`Create`ï¼‰ã§åˆæœŸåŒ–ã—ã¦ã„ã‚‹
- [ ] å¤‰æ›´ç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ`ChangeXxx`ï¼‰ã‚’æä¾›ã—ã¦ã„ã‚‹
- [ ] ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹
- [ ] ãƒ«ãƒ¼ãƒ«é•åæ™‚ã¯ `DomainException` ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¦ã„ã‚‹
- [ ] é‡è¦ãªå¤‰æ›´æ™‚ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã—ã¦ã„ã‚‹ï¼ˆ`RaiseDomainEvent`ï¼‰

#### å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

- [ ] è¦ªé›†ç´„ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆ`private` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
- [ ] å…¬é–‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ `IReadOnlyList` ã§å…¬é–‹
- [ ] è¿½åŠ /å‰Šé™¤ã¯è¦ªé›†ç´„ã®ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ï¼ˆ`AddImage`, `RemoveImage`ï¼‰
- [ ] è¦ªé›†ç´„ãŒä¸å¤‰æ¡ä»¶ã‚’ä¿è­·ã—ã¦ã„ã‚‹

#### Value Object

- [ ] `ValueObject` ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆ`readonly`ï¼‰
- [ ] ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§æ¤œè¨¼ã—ã¦ã„ã‚‹
- [ ] ç­‰ä¾¡æ€§æ¯”è¼ƒã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ï¼ˆ`GetEqualityComponents`ï¼‰

**å‚ç…§å®Ÿè£…:**
- `Product.cs` - é›†ç´„ãƒ«ãƒ¼ãƒˆ
- `ProductImage.cs` - å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- `Money.cs` - Value Object

---

## ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ„ã¿åˆã‚ã›æ–¹

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ä½œæˆ â†’ å–å¾—

```
1. CreateProductCommand ã§å•†å“ã‚’ä½œæˆ
   â†“ æˆåŠŸæ™‚ã« ProductId ã‚’è¿”ã™
2. GetProductByIdQuery ã§ä½œæˆã—ãŸå•†å“ã‚’å–å¾—
   â†“ è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ¤œç´¢ â†’ æ›´æ–°

```
1. SearchProductsQuery ã§æ¡ä»¶ã«åˆã†å•†å“ã‚’æ¤œç´¢
   â†“ å•†å“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå•†å“ã‚’é¸æŠ
   â†“
3. GetProductByIdQuery ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
   â†“ Version ã‚’å–å¾—
4. UpdateProductCommand ã§æ›´æ–°
   â†“ Version ã‚’å«ã‚ã¦æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: çŠ¶æ…‹é·ç§» â†’ é€šçŸ¥

```
1. PublishProductCommand ã§å•†å“ã‚’å…¬é–‹
   â†“ ProductPublishedDomainEvent ãŒç™ºè¡Œã•ã‚Œã‚‹
2. ProductPublishedEventHandler ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
   â†“ SignalRã§å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥
3. UIå´ã§è‡ªå‹•çš„ã«å†èª­ã¿è¾¼ã¿
   â†“ æœ€æ–°ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
```

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: ã€Œãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒã©ã“ã«ã‚ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã€

**æ¢ã—æ–¹:**
1. ã¾ãš**Domainå±¤ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**ã‚’ç¢ºèª
2. è©²å½“ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ`ChangePrice`, `Delete`ãªã©ï¼‰ã‚’è¦‹ã‚‹
3. ãã“ã«ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

### å•é¡Œ2: ã€ŒValidationã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã€

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
1. ValidationBehaviorãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆ`Program.cs`ï¼‰
2. ValidatorãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
3. ValidatorãŒè‡ªå‹•æ¤œå‡ºã•ã‚Œã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆ`FluentValidation.DependencyInjection`ï¼‰ãŒå‚ç…§ã•ã‚Œã¦ã„ã‚‹ã‹

### å•é¡Œ3: ã€Œæ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ãŒå‹•ä½œã—ãªã„ã€

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
1. Commandã« `Version` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã‹
2. Handlerå†…ã§ `Version` ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹
3. EF Coreã®æ§‹æˆã§ `RowVersion` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

### å•é¡Œ4: ã€ŒIdempotencyãŒå‹•ä½œã—ãªã„ã€

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
1. Commandã« `IdempotencyKey` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã‹
2. IdempotencyBehaviorãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹
3. IdempotencyStoreãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹

---

## ğŸ“š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

å®Ÿè£…ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

1. [05_ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ã‚¿ãƒ­ã‚°ä¸€è¦§](05_ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ã‚¿ãƒ­ã‚°ä¸€è¦§.md) ã§å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠŠæ¡
2. [08_å…·ä½“ä¾‹_å•†å“ç®¡ç†æ©Ÿèƒ½](08_å…·ä½“ä¾‹_å•†å“ç®¡ç†æ©Ÿèƒ½.md) ã§å…·ä½“çš„ãªå®Ÿè£…ä¾‹ã‚’å­¦ç¿’
3. [10_Applicationå±¤ã®è©³ç´°è¨­è¨ˆ](10_Applicationå±¤ã®è©³ç´°è¨­è¨ˆ.md) ã§Query/Commandå®Ÿè£…ã‚’å­¦ç¿’
4. [11_Domainå±¤ã®è©³ç´°è¨­è¨ˆ](11_Domainå±¤ã®è©³ç´°è¨­è¨ˆ.md) ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’å­¦ç¿’
5. å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ç†è§£ã‚’æ·±ã‚ã‚‹

---

## ğŸ¢ è¤‡é›‘ãªæ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã®å®Ÿè£…ä¾‹

ã‚·ãƒ³ãƒ—ãƒ«ãªCRUDä»¥å¤–ã®å®Ÿè£…ãŒå¿…è¦ãªå ´åˆã¯ã€**PurchaseManagement BC**ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

### ã„ã¤PurchaseManagementã‚’å‚ç…§ã™ã¹ãã‹

| ã‚·ãƒŠãƒªã‚ª | å‚ç…§å®Ÿè£… | å ´æ‰€ |
|---------|---------|------|
| **æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼** | SubmitPurchaseRequest, ApprovePurchaseRequest, RejectPurchaseRequest | `src/PurchaseManagement/Features/` |
| **çŠ¶æ…‹é·ç§»ç®¡ç†** | PurchaseRequest.cs (Draftâ†’Submittedâ†’Approved) | `src/PurchaseManagement/Shared/Domain/` |
| **ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹èªå¯** | GetPendingApprovals, ApprovePurchaseRequest | `src/PurchaseManagement/Features/` |
| **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»é›†è¨ˆ** | GetDashboardStatistics | `src/PurchaseManagement/Features/` |
| **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰** | UploadAttachment | `src/PurchaseManagement/Features/` |

### å®Ÿè£…æ™‚ã®AIåˆ¤æ–­ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[æ©Ÿèƒ½è¦æ±‚ã‚’å—ã‘å–ã‚‹] --> B{å˜ç´”ãªCRUDã‹?}
    B -->|Yes| C[ProductCatalogã‚’å‚ç…§]
    B -->|No| D{ã©ã‚“ãªè¤‡é›‘æ€§?}

    D -->|æ‰¿èªãƒ•ãƒ­ãƒ¼| E[PurchaseManagement<br/>ApproveRequestå‚ç…§]
    D -->|çŠ¶æ…‹é·ç§»| F[PurchaseManagement<br/>PurchaseRequest.cså‚ç…§]
    D -->|ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†| G[PurchaseManagement<br/>UploadAttachmentå‚ç…§]
    D -->|é›†è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ| H[PurchaseManagement<br/>GetDashboardStatisticså‚ç…§]

    C --> I[å®Ÿè£…é–‹å§‹]
    E --> I
    F --> I
    G --> I
    H --> I
```

### å…·ä½“çš„ãªä½¿ç”¨ä¾‹

**ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚**: ã€ŒçµŒè²»ç”³è«‹ã®æ‰¿èªæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã€

**AIåˆ¤æ–­ãƒ—ãƒ­ã‚»ã‚¹**:
1. âœ… æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¿…è¦ â†’ PurchaseManagementã‚’å‚ç…§
2. âœ… `ApprovePurchaseRequest` ã‚’å‚è€ƒã«å®Ÿè£…
3. âœ… `PurchaseRequest.cs` ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã§çŠ¶æ…‹é·ç§»ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’
4. âœ… `GetPendingApprovals` ã§ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹èªå¯ã‚’å­¦ç¿’

**å‚ç…§ã™ã¹ããƒ•ã‚¡ã‚¤ãƒ«**:
```
src/PurchaseManagement/
â”œâ”€â”€ Features/
â”‚   â”œâ”€â”€ ApprovePurchaseRequest/
â”‚   â”‚   â”œâ”€â”€ Application/
â”‚   â”‚   â”‚   â”œâ”€â”€ ApprovePurchaseRequestCommand.cs
â”‚   â”‚   â”‚   â””â”€â”€ ApprovePurchaseRequestHandler.cs
â”‚   â”œâ”€â”€ GetPendingApprovals/
â”‚   â”‚   â””â”€â”€ Application/
â”‚   â”‚       â””â”€â”€ GetPendingApprovalsHandler.cs
â””â”€â”€ Shared/
    â””â”€â”€ Domain/
        â””â”€â”€ PurchaseRequest.cs  â† çŠ¶æ…‹é·ç§»ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
```

---

**ğŸ¤– ã“ã®ã‚¬ã‚¤ãƒ‰ã«å¾“ãˆã°ã€AIã¯æ­£ã—ãã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ã®å®Ÿè£…ã‚’ç”Ÿæˆã§ãã¾ã™**
