# 6. 全体アーキテクチャ図

[← 目次に戻る](00_README.md)

---

## 6. 全体アーキテクチャ図

### 6.1 VSA構造図

**Vertical Slice Architecture: 機能ごとに垂直に分割**

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  Bounded Context: ProductCatalog                        ┃
┃                                                          ┃
┃  ┌─────────────────┐  ┌─────────────────┐  ┌────────┐  ┃
┃  │ CreateProduct   │  │ UpdateProduct   │  │  ...   │  ┃
┃  │  Feature Slice  │  │  Feature Slice  │  │ Slices │  ┃
┃  ├─────────────────┤  ├─────────────────┤  └────────┘  ┃
┃  │ UI              │  │ UI              │              ┃
┃  │ ┌─────────────┐ │  │ ┌─────────────┐ │              ┃
┃  │ │ Page.razor  │ │  │ │ Page.razor  │ │              ┃
┃  │ │ Store       │ │  │ │ Store       │ │              ┃
┃  │ │ Actions     │ │  │ │ Actions     │ │              ┃
┃  │ └─────────────┘ │  │ └─────────────┘ │              ┃
┃  │       ↓         │  │       ↓         │              ┃
┃  │ Application     │  │ Application     │              ┃
┃  │ ┌─────────────┐ │  │ ┌─────────────┐ │              ┃
┃  │ │ Command     │ │  │ │ Command     │ │              ┃
┃  │ │ Handler     │ │  │ │ Handler     │ │              ┃
┃  │ │ Validator   │ │  │ │ Validator   │ │              ┃
┃  │ └─────────────┘ │  │ └─────────────┘ │              ┃
┃  │       ↓         │  │       ↓         │              ┃
┃  │ Domain          │  │ Domain          │              ┃
┃  │ ┌─────────────┐ │  │ ┌─────────────┐ │              ┃
┃  │ │ Product.cs  │ │  │ │ Product.cs  │ │              ┃
┃  │ │ (Aggregate) │ │  │ │ (Aggregate) │ │              ┃
┃  │ └─────────────┘ │  │ └─────────────┘ │              ┃
┃  │       ↑         │  │       ↑         │              ┃
┃  │ Infrastructure  │  │ Infrastructure  │              ┃
┃  │ ┌─────────────┐ │  │ ┌─────────────┐ │              ┃
┃  │ │ Repository  │ │  │ │ Repository  │ │              ┃
┃  │ │ DbContext   │ │  │ │ DbContext   │ │              ┃
┃  │ └─────────────┘ │  │ └─────────────┘ │              ┃
┃  └─────────────────┘  └─────────────────┘              ┃
┃                                                          ┃
┃  ┌──────────────────────────────────────────────────┐   ┃
┃  │ Shared (機能間で共有する要素)                     │   ┃
┃  │ - Application (MediatR Behaviors)                │   ┃
┃  │ - Domain (AggregateRoot, ValueObject)            │   ┃
┃  │ - Infrastructure (DbContext, Outbox)             │   ┃
┃  └──────────────────────────────────────────────────┘   ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

特徴:
- 各機能スライスは独立したプロジェクト群
- 機能追加時は1つのスライスフォルダのみ変更
- 機能間の依存は禁止、Sharedで共有
```

### 6.2 処理フロー図(Command実行時)

```
┌─────────────┐
│   User      │
│ (クリック)   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  1. Dumb Component                          │
│     EventCallback.InvokeAsync(id)           │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  2. Smart Component (Page)                  │
│     await Actions.DeleteAsync(id)           │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  3. PageActions                             │
│     ・確認ダイアログ表示                      │
│     ・await Store.DeleteAsync(id)           │
│     ・トースト通知                           │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  4. Store                                   │
│     ・SetState(IsLoading = true)            │
│     ・CreateScope()                         │
│     ・IMediator取得                          │
│     ・await mediator.Send(Command)          │
└──────┬──────────────────────────────────────┘
       │
       ▼ (新スコープ内)
┌─────────────────────────────────────────────┐
│  5. MediatR Pipeline                        │
│     ① LoggingBehavior                       │
│     ② ValidationBehavior                    │
│     ③ AuthorizationBehavior                 │
│     ④ IdempotencyBehavior                   │
│     ⑤ TransactionBehavior (Begin)           │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  6. Command Handler (UseCase)               │
│     ・Repository.GetAsync()                 │
│     ・Aggregate.Delete()                    │
│     ・Repository.SaveAsync()                │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  7. Domain Layer                            │
│     ・ビジネスルール検証                      │
│     ・RaiseDomainEvent()                    │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  8. Infrastructure                          │
│     ・EF Core: SaveChanges()                │
│     ・Outbox: 統合イベント記録               │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  9. Transaction Commit                      │
│     ・TransactionBehavior (Commit)          │
│     ・Outbox確定                            │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  10. Event Dispatch                         │
│     ・ドメインイベント同期処理                │
│     ・Outbox Dispatcher (非同期配信)         │
│     ・SignalR: Clients.All.SendAsync()      │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  11. Store (結果反映)                       │
│     ・SetState(IsLoading = false)           │
│     ・await LoadAsync() (再読み込み)         │
│     ・OnChangeAsync?.Invoke()               │
└──────┬──────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────┐
│  12. UI Re-render                           │
│     ・InvokeAsync(StateHasChanged)          │
│     ・Smart/Dumb自動再描画                   │
└─────────────────────────────────────────────┘
```

---
