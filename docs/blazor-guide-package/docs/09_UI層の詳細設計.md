# 9. UIå±¤ã®è©³ç´°è¨­è¨ˆ

[â† ç›®æ¬¡ã«æˆ»ã‚‹](00_README.md)

---

## 9. UIå±¤ã®è©³ç´°è¨­è¨ˆ

### 9.0 WPF/WinFormsã¨ã®æ¯”è¼ƒ

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€WPF/WinFormsçµŒé¨“è€…ãŒBlazorã®UIå±¤ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ç†è§£ã§ãã‚‹ã‚ˆã†ã€æ—¢çŸ¥ã®æ¦‚å¿µã¨ã®å¯¾å¿œé–¢ä¿‚ã‚’èª¬æ˜ã—ã¾ã™ã€‚

#### **å…¨ä½“çš„ãªå¯¾å¿œè¡¨**

| WPF/WinForms | ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆBlazorï¼‰ | ä¸»ãªé•ã„ |
|-------------|-------------------------|---------|
| **UserControl** | **Dumb Component** | ã»ã¼åŒã˜æ¦‚å¿µã€‚è¡¨ç¤ºã®ã¿ã‚’æ‹…å½“ |
| **Window/Form** | **Smart Component** | ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ã¿ã€I/Oã¯å§”è­² |
| **ViewModel** | **Store** + **PageActions** | è²¬å‹™ã‚’2ã¤ã«åˆ†é›¢ï¼ˆå¾Œè¿°ï¼‰ |
| **ICommand** | **PageActions ã®ãƒ¡ã‚½ãƒƒãƒ‰** | ã‚ˆã‚Šæ˜ç¤ºçš„ãªå‘½å |
| **INotifyPropertyChanged** | **Store.OnChangeAsync ã‚¤ãƒ™ãƒ³ãƒˆ** | ä¸å¤‰çŠ¶æ…‹ + ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹• |
| **DataBinding** | **@State.Property** | ä¸€æ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆæ‰‹å‹•ï¼‰ |
| **DependencyProperty** | **[Parameter]** | Componentã¸ã®ãƒ‡ãƒ¼ã‚¿æ¸¡ã— |
| **RoutedEvent** | **EventCallback** | å­â†’è¦ªã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ |

---

#### **ViewModelã®åˆ†å‰²: Store + PageActions**

**é‡è¦ãªé•ã„**: WPFã®ViewModelã¯ã€ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯**Storeï¼ˆçŠ¶æ…‹ç®¡ç†ï¼‰**ã¨**PageActionsï¼ˆUIæ‰‹é †ï¼‰**ã«åˆ†é›¢ã•ã‚Œã¾ã™ã€‚

**WPFã®ViewModelï¼ˆå¾“æ¥ï¼‰**

```csharp
// ViewModelãŒã™ã¹ã¦ã‚’æ‹…å½“
public class ProductListViewModel : INotifyPropertyChanged
{
    // ===== çŠ¶æ…‹ =====
    private ObservableCollection<Product> _products = new();
    public ObservableCollection<Product> Products
    {
        get => _products;
        set { _products = value; OnPropertyChanged(); }
    }

    // ===== ã‚³ãƒãƒ³ãƒ‰ =====
    public ICommand DeleteCommand { get; }

    private async Task DeleteProductAsync(Guid id)
    {
        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        var result = MessageBox.Show("å‰Šé™¤ã—ã¾ã™ã‹?", "ç¢ºèª", MessageBoxButton.YesNo);
        if (result != MessageBoxResult.Yes) return;

        // I/Oå‡¦ç†
        await _productService.DeleteAsync(id);
        Products.Remove(Products.First(p => p.Id == id));
    }

    public event PropertyChangedEventHandler? PropertyChanged;
}
```

**ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆStore + PageActionsï¼‰**

```csharp
// ===== Store: çŠ¶æ…‹ç®¡ç†ã®ã¿ =====
public class ProductsStore
{
    private ProductsState _state = new();
    public event Func<Task>? OnChangeAsync;  // INotifyPropertyChangedã®ä»£æ›¿

    public ProductsState GetState() => _state;

    public async Task<bool> DeleteAsync(Guid id, CancellationToken ct = default)
    {
        // I/Oå‡¦ç†ã¨çŠ¶æ…‹æ›´æ–°
        using var scope = _scopeFactory.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new DeleteProductCommand(id), ct);

        if (result.IsSuccess)
            await LoadAsync(ct);

        return result.IsSuccess;
    }
}

// ===== ä¸å¤‰Stateï¼ˆrecordï¼‰ =====
public record ProductsState
{
    public ImmutableList<ProductDto> Products { get; init; } = ImmutableList<ProductDto>.Empty;
    public bool IsLoading { get; init; }
}

// ===== PageActions: UIæ‰‹é †ã®ã¿ =====
public class ProductListActions
{
    private readonly ProductsStore _store;
    private readonly IConfirmDialog _confirm;  // MessageBoxã®ä»£æ›¿ï¼ˆãƒ†ã‚¹ãƒˆå¯èƒ½ï¼‰

    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        // 1. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        if (!await _confirm.ShowAsync("å‰Šé™¤ã—ã¾ã™ã‹?")) return;

        // 2. I/Oå‡¦ç†ã¯Storeã«å®Œå…¨å§”è­²
        var result = await _store.DeleteAsync(id, ct);

        // 3. çµæœè¡¨ç¤º
        if (result) _toast.Success("å‰Šé™¤ã—ã¾ã—ãŸ");
    }
}
```

**ãªãœåˆ†å‰²ã™ã‚‹ã®ã‹ï¼Ÿ**

| è¦³ç‚¹ | WPFã®ViewModel | Store + PageActions |
|------|---------------|---------------------|
| **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£** | MessageBoxã§ãƒ†ã‚¹ãƒˆå›°é›£ | IConfirmDialogã§ãƒ¢ãƒƒã‚¯å¯èƒ½ |
| **å†åˆ©ç”¨æ€§** | 1ç”»é¢ã«1ViewModel | è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§åŒã˜Storeã‚’å…±æœ‰ |
| **å˜ä¸€è²¬ä»»** | çŠ¶æ…‹ãƒ»UIæ‰‹é †ãƒ»I/OãŒæ··åœ¨ | çŠ¶æ…‹ç®¡ç†ã¨UIæ‰‹é †ã‚’åˆ†é›¢ |
| **ä¸¦è¡Œåˆ¶å¾¡** | ViewModelã§å€‹åˆ¥ç®¡ç† | Storeã§ä¸€å…ƒç®¡ç† |

---

#### **DataBindingã®é•ã„**

**WPFï¼ˆåŒæ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰**

```xml
<!-- XAML -->
<TextBox Text="{Binding ProductName, Mode=TwoWay}" />
<Button Command="{Binding DeleteCommand}" />
```

```csharp
// ViewModel
public string ProductName
{
    get => _productName;
    set
    {
        _productName = value;
        OnPropertyChanged();  // è‡ªå‹•é€šçŸ¥
    }
}
```

**Blazorï¼ˆä¸€æ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° + ã‚¤ãƒ™ãƒ³ãƒˆï¼‰**

```csharp
@* Razor Component *@
<input @bind="productName" />
<button @onclick="Actions.DeleteAsync">å‰Šé™¤</button>

@code {
    private string productName = "";

    // Storeã®çŠ¶æ…‹å¤‰æ›´ã‚’è³¼èª­
    protected override void OnInitialized()
    {
        Store.OnChangeAsync += () => InvokeAsync(StateHasChanged);  // æ‰‹å‹•å†æç”»
    }
}
```

**ä¸»ãªé•ã„:**
- WPF: åŒæ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆè‡ªå‹•ï¼‰
- Blazor: ä¸€æ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° + æ‰‹å‹•å†æç”»ï¼ˆ`StateHasChanged`ï¼‰

---

#### **ICommandã¨PageActionsã®æ¯”è¼ƒ**

**WPFï¼ˆICommandï¼‰**

```csharp
public class ProductListViewModel
{
    public ICommand DeleteCommand { get; }

    public ProductListViewModel()
    {
        DeleteCommand = new RelayCommand<Guid>(
            execute: async id => await DeleteProductAsync(id),
            canExecute: id => id != Guid.Empty
        );
    }
}
```

**Blazorï¼ˆPageActionsï¼‰**

```csharp
public class ProductListActions
{
    // ICommandã®ä»£ã‚ã‚Šã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç›´æ¥å®šç¾©
    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        // ã‚ˆã‚Šæ˜ç¤ºçš„ãªå‘½åãŒå¯èƒ½
        // ICommandã®åˆ¶ç´„ãŒãªã„ãŸã‚æŸ”è»Ÿ
    }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚ˆã‚Šæ˜ç¤ºçš„ãªå‘½åï¼ˆ`DeleteCommand` â†’ `DeleteAsync`ï¼‰
- `CanExecute`ã®ä»£ã‚ã‚Šã«ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§æ¡ä»¶åˆ†å²
- éåŒæœŸå‡¦ç†ãŒã‚ˆã‚Šè‡ªç„¶ï¼ˆ`async Task`ï¼‰

---

#### **ç§»è¡Œã®ãƒã‚¤ãƒ³ãƒˆ**

1. **UserControl â†’ Dumb Component**
   - ã»ã¼ãã®ã¾ã¾ç§»è¡Œå¯èƒ½
   - `DependencyProperty` â†’ `[Parameter]`ã«å¤‰æ›´

2. **ViewModel â†’ Store + PageActions**
   - çŠ¶æ…‹ç®¡ç†éƒ¨åˆ† â†’ `Store`
   - ICommandéƒ¨åˆ† â†’ `PageActions`ã®ãƒ¡ã‚½ãƒƒãƒ‰
   - I/Oå‡¦ç† â†’ `Store`ã«é›†ç´„

3. **DataBinding â†’ æ‰‹å‹•ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°**
   - `{Binding Property}` â†’ `@State.Property`
   - `OnPropertyChanged` â†’ `Store.OnChangeAsync`

4. **ICommand â†’ PageActions ãƒ¡ã‚½ãƒƒãƒ‰**
   - `RelayCommand` â†’ `public async Task`ãƒ¡ã‚½ãƒƒãƒ‰
   - ã‚ˆã‚ŠæŸ”è»Ÿã§æ˜ç¤ºçš„

---

### 9.0.5 çŠ¶æ…‹ç®¡ç†ã®2ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ä¸»ã«**ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®çŠ¶æ…‹ç®¡ç†**ï¼ˆProductsStoreã€ProductListActionsç­‰ï¼‰ã‚’æ‰±ã„ã¾ã™ãŒã€å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯**ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®çŠ¶æ…‹ç®¡ç†**ã‚‚å¿…è¦ã§ã™ã€‚

#### **ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ« vs ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰**

| åˆ†é¡ | è²¬ä»»ç¯„å›² | å®Ÿè£…å ´æ‰€ | ä¾‹ |
|------|---------|---------|-----|
| **ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«** | ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å…±é€š | `Infrastructure/` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ãƒ†ãƒ¼ãƒã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€é€šçŸ¥ |
| **ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰** | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å›ºæœ‰ | `Features/` | Products, Orders, Customers |

#### **ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«çŠ¶æ…‹ç®¡ç†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**

ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦å†åˆ©ç”¨å¯èƒ½ãªå…±é€šåŸºç›¤ã§ã™ï¼š

1. **SessionProvider** - èªè¨¼çŠ¶æ…‹ç®¡ç†ï¼ˆIAppContextã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç‰ˆï¼‰
2. **ThemeProvider** - ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
3. **PreferencesStore** - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼ˆè¨€èªã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã€æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
4. **LayoutStore** - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼‰
5. **NotificationStore** - ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ç®¡ç†

**ğŸ“š è©³ç´°ã‚¬ã‚¤ãƒ‰**: ã“ã‚Œã‚‰ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½¿ã„æ–¹ã¯ **[9.0.6 çŠ¶æ…‹ç®¡ç†ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰ï¼ˆè©³ç´°ï¼‰](#906-çŠ¶æ…‹ç®¡ç†ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰è©³ç´°)** ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ‰±ã†å†…å®¹**

ä»¥é™ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®çŠ¶æ…‹ç®¡ç†**ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦èª¬æ˜ã—ã¾ã™ï¼š

- **Store**: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆProductã€Orderç­‰ï¼‰ã®çŠ¶æ…‹ç®¡ç†
- **PageActions**: ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®UIæ‰‹é †ï¼ˆå•†å“å‰Šé™¤ã€æ³¨æ–‡ä½œæˆç­‰ï¼‰
- **Dumb/Smart Component**: ãƒ‰ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®çŠ¶æ…‹ç®¡ç†ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ä¿å®ˆæ€§ã®é«˜ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

---

### 9.0.6 çŠ¶æ…‹ç®¡ç†ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰ï¼ˆè©³ç´°ï¼‰

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®çŠ¶æ…‹ç®¡ç†ã«ã¤ã„ã¦ã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’äº¤ãˆã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

#### **ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«çŠ¶æ…‹ç®¡ç†ï¼ˆInfrastructureï¼‰ã®å®Ÿè£…**

ä»¥ä¸‹ã®5ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒ `src/ProductCatalog.Web/Infrastructure/` ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

##### **1. SessionProviderï¼ˆèªè¨¼çŠ¶æ…‹ç®¡ç†ï¼‰ã®ä½¿ã„æ–¹**

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**

`Routes.razor` ã§æ—¢ã«è¨­å®šæ¸ˆã¿ï¼š

```razor
<SessionProvider>
    <ThemeProvider>
        <Router AppAssembly="typeof(Program).Assembly">
            <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        </Router>
    </ThemeProvider>
</SessionProvider>
```

**ä½¿ç”¨æ–¹æ³•**

```razor
@page "/dashboard"

@code {
    [CascadingParameter]
    private SessionProvider SessionProvider { get; set; } = default!;

    protected override void OnInitialized()
    {
        var session = SessionProvider.State;

        if (session.IsAuthenticated)
        {
            var userId = session.UserId;
            var userName = session.UserName;
            var email = session.Email;

            // ãƒ­ãƒ¼ãƒ«åˆ¤å®š
            if (session.IsInRole("Admin"))
            {
                // ç®¡ç†è€…å°‚ç”¨å‡¦ç†
            }

            // è¤‡æ•°ãƒ­ãƒ¼ãƒ«åˆ¤å®š
            if (session.IsInAnyRole("Admin", "Manager"))
            {
                // ç®¡ç†è€…ã¾ãŸã¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å°‚ç”¨å‡¦ç†
            }
        }
    }
}
```

**ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è¡¨ç¤º**

```razor
@if (SessionProvider.State.IsInRole("Admin"))
{
    <div class="admin-panel">
        <button @onclick="DeleteAllAsync">å…¨å‰Šé™¤ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</button>
    </div>
}
```

##### **2. ThemeProviderï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼‰ã®ä½¿ã„æ–¹**

```razor
@code {
    [CascadingParameter]
    private ThemeProvider ThemeProvider { get; set; } = default!;

    private async Task ToggleTheme()
    {
        await ThemeProvider.ToggleThemeAsync();
    }

    private async Task SetDarkMode()
    {
        await ThemeProvider.SetDarkModeAsync();
    }

    private async Task SetLightMode()
    {
        await ThemeProvider.SetLightModeAsync();
    }

    private bool IsDarkMode => ThemeProvider.State.Mode == ThemeMode.Dark;
}
```

**UIä¾‹**

```razor
<div class="theme-toggle">
    <button @onclick="ToggleTheme">
        @if (ThemeProvider.State.Mode == ThemeMode.Dark)
        {
            <span>ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
        }
        else
        {
            <span>â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</span>
        }
    </button>
</div>
```

##### **3. PreferencesStoreï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç®¡ç†ï¼‰ã®ä½¿ã„æ–¹**

**DIç™»éŒ²ï¼ˆProgram.csï¼‰**

```csharp
builder.Services.AddScoped<PreferencesStore>();
```

**ä½¿ç”¨æ–¹æ³•**

```razor
@inject PreferencesStore PreferencesStore

@code {
    protected override async Task OnInitializedAsync()
    {
        // LocalStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        await PreferencesStore.InitializeAsync();

        // çŠ¶æ…‹å¤‰æ›´ã‚’è³¼èª­
        PreferencesStore.OnChangeAsync += StateHasChanged;
    }

    private async Task ChangeCulture(string culture)
    {
        await PreferencesStore.SetCultureAsync(culture);
    }

    private async Task ChangeTimeZone(string timeZoneId)
    {
        await PreferencesStore.SetTimeZoneAsync(timeZoneId);
    }

    private PreferencesState Prefs => PreferencesStore.GetState();
}
```

##### **4. LayoutStoreï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ç®¡ç†ï¼‰ã®ä½¿ã„æ–¹**

**DIç™»éŒ²ï¼ˆProgram.csï¼‰**

```csharp
builder.Services.AddScoped<LayoutStore>();
```

**ä½¿ç”¨æ–¹æ³•**

```razor
@inject LayoutStore LayoutStore

@code {
    protected override async Task OnInitializedAsync()
    {
        await LayoutStore.InitializeAsync();
        LayoutStore.OnChangeAsync += StateHasChanged;
    }

    private async Task ToggleSidebar()
    {
        await LayoutStore.ToggleSidebarAsync();
    }

    private async Task ToggleSidebarPin()
    {
        await LayoutStore.ToggleSidebarPinAsync();
    }

    private LayoutState Layout => LayoutStore.GetState();
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆUI**

```razor
<div class="main-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar @(Layout.IsSidebarOpen ? "open" : "closed")
                          @(Layout.IsSidebarPinned ? "pinned" : "")">
        <div class="sidebar-header">
            <button @onclick="ToggleSidebarPin">
                @if (Layout.IsSidebarPinned)
                {
                    <span>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚è§£é™¤</span>
                }
                else
                {
                    <span>ğŸ“ ãƒ”ãƒ³ç•™ã‚</span>
                }
            </button>
        </div>
        <nav>
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        </nav>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <header>
            <button @onclick="ToggleSidebar">â˜°</button>
            <h1>@Title</h1>
        </header>
        <div class="content">
            @ChildContent
        </div>
    </main>
</div>

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public RenderFragment? ChildContent { get; set; }
}
```

##### **5. NotificationStoreï¼ˆé€šçŸ¥ç®¡ç†ï¼‰ã®ä½¿ã„æ–¹**

**DIç™»éŒ²ï¼ˆProgram.csï¼‰**

```csharp
builder.Services.AddScoped<NotificationStore>();
```

**ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥**

```razor
@inject NotificationStore NotificationStore

@code {
    private async Task SaveAsync()
    {
        try
        {
            // ä¿å­˜å‡¦ç†
            await SaveDataAsync();

            // æˆåŠŸé€šçŸ¥
            await NotificationStore.ShowSuccessAsync(
                "ä¿å­˜å®Œäº†",
                "ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        }
        catch (Exception ex)
        {
            // ã‚¨ãƒ©ãƒ¼é€šçŸ¥
            await NotificationStore.ShowErrorAsync(
                "ä¿å­˜å¤±æ•—",
                $"ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {ex.Message}");
        }
    }
}
```

**ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°**

```razor
@code {
    private async Task DeleteWithConfirm(Guid id)
    {
        await NotificationStore.ShowConfirmAsync(
            title: "å‰Šé™¤ç¢ºèª",
            message: "æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
            onConfirm: async () => await DeleteAsync(id),
            onCancel: async () => await Task.CompletedTask);
    }

    private async Task DeleteAsync(Guid id)
    {
        // å‰Šé™¤å‡¦ç†
        await Store.DeleteAsync(id);
        await NotificationStore.ShowSuccessAsync("å‰Šé™¤å®Œäº†", "ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    }
}
```

#### **ğŸ¨ ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰çŠ¶æ…‹ç®¡ç†ï¼ˆFeaturesï¼‰ã®å®Ÿè£…**

ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®çŠ¶æ…‹ç®¡ç†ã¯ã€**Store**ï¼ˆçŠ¶æ…‹ç®¡ç†+I/Oï¼‰ã¨**PageActions**ï¼ˆUIæ‰‹é †ï¼‰ã«åˆ†é›¢ã—ã¾ã™ã€‚

##### **ProductsStoreã®ä¾‹**

```csharp
/// <summary>
/// å•†å“ä¸€è¦§ã®çŠ¶æ…‹ç®¡ç†ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ï¼‰
/// </summary>
public sealed class ProductsStore : IDisposable
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly SemaphoreSlim _gate = new(1, 1);
    private ProductsState _state = ProductsState.Empty;

    public event Func<Task>? OnChangeAsync;

    public ProductsState GetState() => _state;

    public async Task LoadAsync(CancellationToken ct = default)
    {
        await _gate.WaitAsync(ct);
        try
        {
            SetState(_state with { IsLoading = true });

            using var scope = _scopeFactory.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();

            var result = await mediator.Send(new GetProductsQuery(), ct);

            if (result.IsSuccess)
            {
                SetState(_state with
                {
                    IsLoading = false,
                    Products = result.Value.ToImmutableList()
                });
            }
        }
        finally
        {
            _gate.Release();
        }
    }

    private void SetState(ProductsState newState)
    {
        _state = newState;
        OnChangeAsync?.Invoke();
    }

    public void Dispose() => _gate.Dispose();
}
```

##### **ProductListActionsã®ä¾‹**

```csharp
/// <summary>
/// å•†å“ä¸€è¦§ç”»é¢ã®UIæ‰‹é †ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ï¼‰
/// </summary>
public sealed class ProductListActions
{
    private readonly ProductsStore _store;
    private readonly NotificationStore _notification;
    private readonly NavigationManager _navigation;

    public async Task LoadAsync()
    {
        await _store.LoadAsync();
    }

    public async Task DeleteAsync(Guid productId)
    {
        await _notification.ShowConfirmAsync(
            "å‰Šé™¤ç¢ºèª",
            "ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
            onConfirm: async () =>
            {
                var success = await _store.DeleteAsync(productId);
                if (success)
                {
                    await _notification.ShowSuccessAsync("å‰Šé™¤å®Œäº†", "å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
                }
            });
    }

    public void EditAsync(Guid productId)
    {
        _navigation.NavigateTo($"/products/{productId}/edit");
    }
}
```

#### **ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®é€£æºä¾‹**

**å•†å“ä¸€è¦§ç”»é¢ã§ã®å®Ÿè·µ**

```razor
@page "/products"
@inject ProductsStore Store
@inject ProductListActions Actions
@inject NotificationStore NotificationStore
@implements IDisposable

@code {
    [CascadingParameter]
    private SessionProvider SessionProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰Storeè³¼èª­
        Store.OnChangeAsync += StateHasChanged;

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«Storeè³¼èª­
        NotificationStore.OnChangeAsync += StateHasChanged;

        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
        await Actions.LoadAsync();
    }

    private bool CanDelete => SessionProvider.State.IsInRole("Admin");

    public void Dispose()
    {
        Store.OnChangeAsync -= StateHasChanged;
        NotificationStore.OnChangeAsync -= StateHasChanged;
    }
}
```

```razor
<div class="product-list">
    <h1>å•†å“ä¸€è¦§</h1>

    @* ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«: ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è¡¨ç¤º *@
    @if (CanDelete)
    {
        <button class="btn btn-danger" @onclick="DeleteAllAsync">
            ä¸€æ‹¬å‰Šé™¤ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
        </button>
    }

    @* ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰: å•†å“ãƒªã‚¹ãƒˆ *@
    @if (Store.GetState().IsLoading)
    {
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    }
    else
    {
        @foreach (var product in Store.GetState().Products)
        {
            <ProductCard
                Product="@product"
                OnEdit="Actions.EditAsync"
                OnDelete="@(CanDelete ? Actions.DeleteAsync : null)" />
        }
    }
</div>

@code {
    private async Task DeleteAllAsync()
    {
        await Actions.DeleteBatchAsync(
            Store.GetState().Products.Select(p => p.Id));
    }
}
```

#### **ğŸ“‹ ä½¿ã„åˆ†ã‘ã‚¬ã‚¤ãƒ‰**

**ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«çŠ¶æ…‹ç®¡ç†ã‚’ä½¿ã†ã¹ãå ´åˆ**

âœ… ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å…±é€šã®æ©Ÿèƒ½
âœ… èªè¨¼ãƒ»èªå¯ã€ãƒ†ãƒ¼ãƒã€è¨€èªè¨­å®š
âœ… UIå…¨ä½“ã«å½±éŸ¿ã™ã‚‹çŠ¶æ…‹
âœ… LocalStorageã«æ°¸ç¶šåŒ–ã—ãŸã„è¨­å®š

**ä¾‹:**
- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª
- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
- è¨€èªåˆ‡ã‚Šæ›¿ãˆ
- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰
- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥

**ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰çŠ¶æ…‹ç®¡ç†ã‚’ä½¿ã†ã¹ãå ´åˆ**

âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å›ºæœ‰ã®æ©Ÿèƒ½
âœ… ç”»é¢å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
âœ… CRUDæ“ä½œ
âœ… æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**ä¾‹:**
- å•†å“ä¸€è¦§ã®è¡¨ç¤º
- æ³¨æ–‡å‡¦ç†
- åœ¨åº«ç®¡ç†
- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

#### **ğŸ“ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**

**1. çŠ¶æ…‹ã®è³¼èª­ã¨è§£é™¤**

```csharp
// âœ… GOOD
protected override void OnInitialized()
{
    Store.OnChangeAsync += StateHasChanged;
}

public void Dispose()
{
    Store.OnChangeAsync -= StateHasChanged;  // å¿…ãšè§£é™¤
}

// âŒ BAD: Disposeã—ãªã„ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ï¼‰
protected override void OnInitialized()
{
    Store.OnChangeAsync += StateHasChanged;
}
```

**2. ä¸¦è¡Œåˆ¶å¾¡ã®æ´»ç”¨**

```csharp
// âœ… GOOD: Storeã§ä¸¦è¡Œåˆ¶å¾¡
public async Task LoadAsync()
{
    await _gate.WaitAsync();
    try
    {
        // I/Oå‡¦ç†
    }
    finally
    {
        _gate.Release();
    }
}
```

**3. ä¸å¤‰çŠ¶æ…‹ã®æ›´æ–°**

```csharp
// âœ… GOOD: recordã®withå¼
SetState(_state with { IsLoading = true });

// âŒ BAD: å¯å¤‰çŠ¶æ…‹
_state.IsLoading = true;  // recordã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
```

---

### 9.1 Dumb Component(ç´”ç²‹è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)

#### **è¨­è¨ˆåŸå‰‡**

- **Pure Presentation**: è¡¨ç¤ºã®ã¿ã‚’æ‹…å½“
- **No State**: å†…éƒ¨çŠ¶æ…‹ã‚’æŒãŸãªã„
- **Parameters + EventCallback**: å¤–éƒ¨ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«

#### **å®Ÿè£…ä¾‹**

```csharp
@* ProductCard.razor *@
<div class="product-card">
    <div class="product-header">
        <h3>@Product.Name</h3>
        <span class="product-price">@Product.DisplayPrice</span>
    </div>
    
    <div class="product-body">
        <p>@Product.Description</p>
        <span class="product-stock">åœ¨åº«: @Product.Stock</span>
    </div>
    
    <div class="product-actions">
        <button class="btn btn-primary" @onclick="HandleEdit">ç·¨é›†</button>
        <button class="btn btn-danger" @onclick="HandleDelete">å‰Šé™¤</button>
    </div>
</div>

@code {
    /// <summary>
    /// è¡¨ç¤ºã™ã‚‹å•†å“ãƒ‡ãƒ¼ã‚¿
    /// </summary>
    [Parameter, EditorRequired]
    public ProductDto Product { get; set; } = default!;
    
    /// <summary>
    /// ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    /// </summary>
    [Parameter]
    public EventCallback<Guid> OnEdit { get; set; }
    
    /// <summary>
    /// å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    /// </summary>
    [Parameter]
    public EventCallback<Guid> OnDelete { get; set; }
    
    private Task HandleEdit() => OnEdit.InvokeAsync(Product.Id);
    private Task HandleDelete() => OnDelete.InvokeAsync(Product.Id);
}
```

#### **æ³¨æ„ç‚¹**

```csharp
// âŒ Dumbã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹æ“ä½œ

// 1. å†…éƒ¨çŠ¶æ…‹ã®ä¿æŒ
private bool _isExpanded = false;  // NG

// 2. I/Oæ“ä½œ
private async Task LoadDetails()
{
    await HttpClient.GetAsync(...);  // NG
}

// 3. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
private bool CanDelete()
{
    return Product.Stock == 0;  // NG(è¦ªã«å§”è­²)
}

// 4. ç›´æ¥ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
private void NavigateToEdit()
{
    NavigationManager.NavigateTo(...);  // NG
}

// âœ… ã™ã¹ã¦ã®æ“ä½œã¯EventCallbackã§è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å§”è­²
[Parameter] public EventCallback<Guid> OnDelete { get; set; }
```

### 9.2 Smart Component(ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)

#### **è¨­è¨ˆåŸå‰‡**

- **Orchestration Only**: æ‰‹é †ã®å‘¼ã³å‡ºã—ã®ã¿
- **State Subscription**: Storeã®çŠ¶æ…‹ã‚’è³¼èª­
- **No I/O**: I/Oã¯PageActionsã«å§”è­²

#### **å®Ÿè£…ä¾‹**

```csharp
@* ProductList.razor *@
@page "/products"
@inject ProductsStore Store
@inject ProductListActions Actions
@implements IDisposable

<PageTitle>å•†å“ä¸€è¦§</PageTitle>

<div class="page-header">
    <h1>å•†å“ç®¡ç†</h1>
    <button class="btn btn-success" @onclick="Actions.CreateAsync">æ–°è¦ä½œæˆ</button>
</div>

@if (State.IsLoading)
{
    <LoadingIndicator Message="èª­ã¿è¾¼ã¿ä¸­..." />
}
else if (!string.IsNullOrEmpty(State.ErrorMessage))
{
    <ErrorAlert Message="@State.ErrorMessage" OnRetry="Actions.LoadAsync" />
}
else if (!State.Products.Any())
{
    <EmptyState Message="å•†å“ãŒã‚ã‚Šã¾ã›ã‚“" />
}
else
{
    <div class="product-grid">
        @foreach (var product in State.Products)
        {
            <ProductCard 
                Product="@product" 
                OnEdit="Actions.EditAsync"
                OnDelete="Actions.DeleteAsync" />
        }
    </div>
    
    @if (State.TotalCount > State.Products.Count)
    {
        <Pagination 
            CurrentPage="@State.CurrentPage"
            TotalPages="@State.TotalPages"
            OnPageChanged="Actions.LoadPageAsync" />
    }
}

@code {
    /// <summary>
    /// Storeã‹ã‚‰ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—
    /// </summary>
    private ProductsState State => Store.GetState();
    
    protected override async Task OnInitializedAsync()
    {
        // 1. Storeã®å¤‰æ›´ã‚’è³¼èª­
        Store.OnChangeAsync += HandleStateChanged;
        
        // 2. åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰(Actionsã«å§”è­²)
        await Actions.LoadAsync();
    }
    
    /// <summary>
    /// Stateå¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    /// Blazor Serverã®æç”»ã‚¹ãƒ¬ãƒƒãƒ‰ã¸ãƒãƒ¼ã‚·ãƒ£ãƒªãƒ³ã‚°
    /// </summary>
    private Task HandleStateChanged()
    {
        return InvokeAsync(StateHasChanged);
    }
    
    /// <summary>
    /// Disposeæ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­ã‚’è§£é™¤
    /// </summary>
    public void Dispose()
    {
        Store.OnChangeAsync -= HandleStateChanged;
    }
}
```

#### **ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã§ã®æ³¨æ„ç‚¹**

```csharp
// âœ… æ­£ã—ã„ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

protected override async Task OnInitializedAsync()
{
    // 1. æœ€åˆã«ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­(ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å‰)
    Store.OnChangeAsync += HandleStateChanged;
    
    // 2. ãã®å¾Œã«ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
    await Actions.LoadAsync();
}

// âœ… å¿…ãšDispose
public void Dispose()
{
    Store.OnChangeAsync -= HandleStateChanged;
}

// âŒ ã‚ˆãã‚ã‚‹é–“é•ã„

// é–“é•ã„1: OnAfterRenderAsyncã§è³¼èª­
protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        Store.OnChangeAsync += HandleStateChanged;  // NG: åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾Œã§ã¯é…ã„
    }
}

// é–“é•ã„2: Disposeã—ãªã„
// ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®åŸå› !
```

### 9.3 PageActions(UIæ‰‹é †ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)

#### **è¨­è¨ˆåŸå‰‡**

- **UI Flow Only**: UIæ‰‹é †ã®ã¿ã‚’æ‹…å½“
- **No I/O**: I/Oã¯Storeã«å®Œå…¨å§”è­²
- **User Interaction**: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã€ãƒˆãƒ¼ã‚¹ãƒˆã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

#### **å®Ÿè£…ä¾‹**

```csharp
/// <summary>
/// å•†å“ä¸€è¦§ç”»é¢ã®UIæ‰‹é †ã‚’ç®¡ç†
/// </summary>
public sealed class ProductListActions
{
    private readonly ProductsStore _store;
    private readonly IConfirmDialog _confirm;
    private readonly IToast _toast;
    private readonly NavigationManager _navigation;
    private readonly ILogger<ProductListActions> _logger;
    
    public ProductListActions(
        ProductsStore store,
        IConfirmDialog confirm,
        IToast toast,
        NavigationManager navigation,
        ILogger<ProductListActions> logger)
    {
        _store = store;
        _confirm = confirm;
        _toast = toast;
        _navigation = navigation;
        _logger = logger;
    }
    
    /// <summary>
    /// ä¸€è¦§èª­ã¿è¾¼ã¿
    /// </summary>
    public async Task LoadAsync(CancellationToken ct = default)
    {
        try
        {
            await _store.LoadAsync(ct);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å•†å“ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
            _toast.Error("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
    }
    
    /// <summary>
    /// ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
    /// </summary>
    public async Task LoadPageAsync(int pageNumber, CancellationToken ct = default)
    {
        await _store.LoadPageAsync(pageNumber, ct);
    }
    
    /// <summary>
    /// æ–°è¦ä½œæˆ
    /// </summary>
    public void CreateAsync()
    {
        _navigation.NavigateTo("/products/create");
    }
    
    /// <summary>
    /// ç·¨é›†
    /// </summary>
    public void EditAsync(Guid productId)
    {
        _navigation.NavigateTo($"/products/{productId}/edit");
    }
    
    /// <summary>
    /// å‰Šé™¤(ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ã)
    /// </summary>
    public async Task DeleteAsync(Guid productId, CancellationToken ct = default)
    {
        // 1. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        var confirmed = await _confirm.ShowAsync(
            title: "å‰Šé™¤ç¢ºèª",
            message: "ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?",
            confirmText: "å‰Šé™¤",
            cancelText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
        
        if (!confirmed)
        {
            _logger.LogInformation("å•†å“å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ: {ProductId}", productId);
            return;
        }
        
        // 2. I/Oå®Ÿè¡Œ(Storeã«å§”è­²)
        var success = await _store.DeleteAsync(productId, ct);
        
        // 3. çµæœé€šçŸ¥
        if (success)
        {
            _toast.Success("å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
            _logger.LogInformation("å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: {ProductId}", productId);
        }
        else
        {
            _toast.Error("å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
            _logger.LogWarning("å•†å“å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: {ProductId}", productId);
        }
    }
    
    /// <summary>
    /// ä¸€æ‹¬å‰Šé™¤
    /// </summary>
    public async Task DeleteBatchAsync(IEnumerable<Guid> productIds, CancellationToken ct = default)
    {
        var ids = productIds.ToList();
        
        if (!ids.Any())
        {
            _toast.Warning("å‰Šé™¤ã™ã‚‹å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
        }
        
        var confirmed = await _confirm.ShowAsync(
            title: "ä¸€æ‹¬å‰Šé™¤ç¢ºèª",
            message: $"{ids.Count}ä»¶ã®å•†å“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?",
            confirmText: "å‰Šé™¤",
            cancelText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
        
        if (!confirmed) return;
        
        var result = await _store.DeleteBatchAsync(ids, ct);
        
        _toast.Info($"{result.SuccessCount}ä»¶å‰Šé™¤ã€{result.FailureCount}ä»¶å¤±æ•—");
    }
}
```

#### **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£**

```csharp
// âœ… PageActionsã¯I/Oã‚’æŒãŸãªã„ãŸã‚ã€ãƒ¢ãƒƒã‚¯ãªã—ã§ãƒ†ã‚¹ãƒˆå¯èƒ½

public class ProductListActionsTests
{
    [Fact]
    public async Task DeleteAsync_ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«_Storeã‚’å‘¼ã°ãªã„()
    {
        // Arrange
        var storeMock = new Mock<ProductsStore>();
        var confirmMock = new Mock<IConfirmDialog>();
        confirmMock.Setup(x => x.ShowAsync(It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>()))
            .ReturnsAsync(false);  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        
        var actions = new ProductListActions(
            storeMock.Object,
            confirmMock.Object,
            Mock.Of<IToast>(),
            Mock.Of<NavigationManager>(),
            Mock.Of<ILogger<ProductListActions>>());
        
        // Act
        await actions.DeleteAsync(Guid.NewGuid());
        
        // Assert
        storeMock.Verify(x => x.DeleteAsync(It.IsAny<Guid>(), It.IsAny<CancellationToken>()), Times.Never);
    }
}
```

### 9.4 Store(çŠ¶æ…‹ç®¡ç†ã¨I/O)

#### **è¨­è¨ˆåŸå‰‡**

- **Single Source of Truth**: çŠ¶æ…‹ã®å˜ä¸€ã‚½ãƒ¼ã‚¹
- **Immutable State**: ä¸å¤‰çŠ¶æ…‹
- **Scope Management**: éƒ½åº¦ã‚¹ã‚³ãƒ¼ãƒ—ä½œæˆ
- **Concurrency Control**: ä¸¦è¡Œåˆ¶å¾¡

#### **å®Ÿè£…ä¾‹**

```csharp
/// <summary>
/// å•†å“ä¸€è¦§ã®çŠ¶æ…‹ç®¡ç†ã¨I/Oå®Ÿè¡Œ
/// Blazor Server: Circuit(æ¥ç¶š)å˜ä½ã§Scoped
/// </summary>
public sealed class ProductsStore : IDisposable
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<ProductsStore> _logger;
    
    // ä¸¦è¡Œåˆ¶å¾¡ç”¨
    private readonly SemaphoreSlim _gate = new(1, 1);
    private CancellationTokenSource? _cts;
    
    // çŠ¶æ…‹(ä¸å¤‰)
    private ProductsState _state = ProductsState.Empty;
    
    /// <summary>
    /// çŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    /// Smart ComponentãŒè³¼èª­
    /// </summary>
    public event Func<Task>? OnChangeAsync;
    
    public ProductsStore(
        IServiceScopeFactory scopeFactory,
        ILogger<ProductsStore> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }
    
    /// <summary>
    /// ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—(èª­ã¿å–ã‚Šå°‚ç”¨)
    /// </summary>
    public ProductsState GetState() => _state;
    
    /// <summary>
    /// å•†å“ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    /// </summary>
    public async Task LoadAsync(CancellationToken ct = default)
    {
        // ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡: å…ˆè¡Œå‡¦ç†ä¸­ã¯æ–°è¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
        if (!await _gate.WaitAsync(0, ct))
        {
            _logger.LogDebug("LoadAsyncã¯æ—¢ã«å®Ÿè¡Œä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ");
            return;
        }
        
        // æ—¢å­˜ã®å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        _cts?.Cancel();
        _cts = CancellationTokenSource.CreateLinkedTokenSource(ct);
        
        try
        {
            // 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            SetState(_state with { IsLoading = true, ErrorMessage = null });
            
            // 2. æ–°ã—ã„ã‚¹ã‚³ãƒ¼ãƒ—ã§Mediatorã‚’å–å¾—(DbContextãƒªãƒ¼ã‚¯é˜²æ­¢)
            using var scope = _scopeFactory.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
            
            // 3. Queryã‚’å®Ÿè¡Œ(CQRS)
            var result = await mediator.Send(
                new GetProductsQuery(_state.CurrentPage, _state.PageSize), 
                _cts.Token);
            
            // 4. çµæœã‚’çŠ¶æ…‹ã«åæ˜ 
            if (result.IsSuccess)
            {
                SetState(_state with
                {
                    IsLoading = false,
                    Products = result.Value.Items.ToImmutableList(),
                    TotalCount = result.Value.TotalCount,
                    ErrorMessage = null
                });
            }
            else
            {
                SetState(_state with
                {
                    IsLoading = false,
                    ErrorMessage = result.Error
                });
            }
        }
        catch (OperationCanceledException)
        {
            _logger.LogDebug("LoadAsyncãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ");
            SetState(_state with { IsLoading = false });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å•†å“ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
            SetState(_state with
            {
                IsLoading = false,
                ErrorMessage = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
            });
        }
        finally
        {
            _gate.Release();
        }
    }
    
    /// <summary>
    /// ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
    /// </summary>
    public async Task LoadPageAsync(int pageNumber, CancellationToken ct = default)
    {
        if (pageNumber < 1 || pageNumber > _state.TotalPages)
            return;
        
        SetState(_state with { CurrentPage = pageNumber });
        await LoadAsync(ct);
    }
    
    /// <summary>
    /// å•†å“ã‚’å‰Šé™¤
    /// </summary>
    public async Task<bool> DeleteAsync(Guid productId, CancellationToken ct = default)
    {
        try
        {
            // 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹(éƒ¨åˆ†çš„)
            SetState(_state with { ErrorMessage = null });
            
            // 2. æ–°ã—ã„ã‚¹ã‚³ãƒ¼ãƒ—ã§Commandã‚’å®Ÿè¡Œ
            using var scope = _scopeFactory.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
            
            var command = new DeleteProductCommand(productId);
            var result = await mediator.Send(command, ct);
            
            if (!result.IsSuccess)
            {
                SetState(_state with { ErrorMessage = result.Error });
                return false;
            }
            
            // 3. æˆåŠŸã—ãŸã‚‰ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            await LoadAsync(ct);
            return true;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "å•†å“å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: {ProductId}", productId);
            SetState(_state with { ErrorMessage = "å‰Šé™¤å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ" });
            return false;
        }
    }
    
    /// <summary>
    /// ä¸€æ‹¬å‰Šé™¤
    /// </summary>
    public async Task<(int SuccessCount, int FailureCount)> DeleteBatchAsync(
        IEnumerable<Guid> productIds, 
        CancellationToken ct = default)
    {
        var ids = productIds.ToList();
        var successCount = 0;
        var failureCount = 0;
        
        SetState(_state with { IsLoading = true, ErrorMessage = null });
        
        foreach (var id in ids)
        {
            try
            {
                using var scope = _scopeFactory.CreateScope();
                var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                
                var result = await mediator.Send(new DeleteProductCommand(id), ct);
                
                if (result.IsSuccess) successCount++;
                else failureCount++;
            }
            catch
            {
                failureCount++;
            }
        }
        
        await LoadAsync(ct);
        return (successCount, failureCount);
    }
    
    /// <summary>
    /// çŠ¶æ…‹ã‚’æ›´æ–°ã—ã€è³¼èª­è€…ã«é€šçŸ¥
    /// </summary>
    private async void SetState(ProductsState newState)
    {
        _state = newState;
        
        if (OnChangeAsync is null) return;
        
        // ã™ã¹ã¦ã®è³¼èª­è€…ã«é€šçŸ¥
        foreach (var handler in OnChangeAsync.GetInvocationList().Cast<Func<Task>>())
        {
            try
            {
                await handler();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "çŠ¶æ…‹å¤‰æ›´é€šçŸ¥ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        }
    }
    
    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
        _gate.Dispose();
    }
}
```

#### **Stateå®šç¾©**

```csharp
/// <summary>
/// å•†å“ä¸€è¦§ç”»é¢ã®çŠ¶æ…‹
/// recordã«ã‚ˆã‚‹ä¸å¤‰æ€§ã®ä¿è¨¼
/// </summary>
public sealed record ProductsState
{
    public static readonly ProductsState Empty = new();
    
    /// <summary>
    /// è¡¨ç¤ºä¸­ã®å•†å“ãƒªã‚¹ãƒˆ
    /// </summary>
    public ImmutableList<ProductDto> Products { get; init; } = ImmutableList<ProductDto>.Empty;
    
    /// <summary>
    /// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ãƒ•ãƒ©ã‚°
    /// </summary>
    public bool IsLoading { get; init; }
    
    /// <summary>
    /// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    /// </summary>
    public string? ErrorMessage { get; init; }
    
    /// <summary>
    /// ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ç•ªå·
    /// </summary>
    public int CurrentPage { get; init; } = 1;
    
    /// <summary>
    /// 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°
    /// </summary>
    public int PageSize { get; init; } = 20;
    
    /// <summary>
    /// ç·ä»¶æ•°
    /// </summary>
    public int TotalCount { get; init; }
    
    /// <summary>
    /// ç·ãƒšãƒ¼ã‚¸æ•°(è¨ˆç®—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£)
    /// </summary>
    public int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);
    
    /// <summary>
    /// é¸æŠä¸­ã®å•†å“ID(ä¸€æ‹¬æ“ä½œç”¨)
    /// </summary>
    public ImmutableHashSet<Guid> SelectedIds { get; init; } = ImmutableHashSet<Guid>.Empty;
}
```

#### **é‡è¦ãªæ³¨æ„ç‚¹**

```csharp
// âœ… éƒ½åº¦ã‚¹ã‚³ãƒ¼ãƒ—ã®é‡è¦æ€§(Blazor Server)

// é–“é•ã„: Storeã«ç›´æ¥DbContextã‚’DI
public class ProductsStore
{
    private readonly AppDbContext _context;  // âŒ ç¦æ­¢!
    
    public ProductsStore(AppDbContext context)
    {
        _context = context;  // Circuitå¯¿å‘½ã¨åŒã˜ã«ãªã‚Šã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
    }
}

// æ­£ã—ã„: IServiceScopeFactoryã§éƒ½åº¦ã‚¹ã‚³ãƒ¼ãƒ—ä½œæˆ
public class ProductsStore
{
    private readonly IServiceScopeFactory _scopeFactory;  // âœ… æ¨å¥¨
    
    public async Task LoadAsync(CancellationToken ct)
    {
        using var scope = _scopeFactory.CreateScope();  // â˜… æ–°ã‚¹ã‚³ãƒ¼ãƒ—
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        // Mediatorã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†…ã§DbContextãŒè§£æ±ºã•ã‚Œã‚‹
        // ã‚¹ã‚³ãƒ¼ãƒ—çµ‚äº†æ™‚ã«è‡ªå‹•çš„ã«Dispose
    }
}
```

### 9.5 Storeä¸¦è¡Œåˆ¶å¾¡ã®é«˜åº¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³ (v2.1æ”¹å–„)

#### 9.5.1 single-flight ãƒ‘ã‚¿ãƒ¼ãƒ³(åŒä¸€ã‚­ãƒ¼åˆæµ)

**versioning + single-flight ã®çµ„ã¿åˆã‚ã›ã§é‡ã„Queryã®å¤šé‡èµ·å‹•ã‚’æ›´ã«æŠ‘åˆ¶**

```csharp
/// <summary>
/// versioning + single-flight ã®äºŒæ®µæ§‹ãˆä¸¦è¡Œåˆ¶å¾¡
/// </summary>
public sealed class ProductsStore : IDisposable
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<ProductsStore> _logger;
    
    // ä¸¦è¡Œåˆ¶å¾¡ç”¨
    private readonly SemaphoreSlim _gate = new(1, 1);
    private readonly ConcurrentDictionary<string, Task> _inflightRequests = new();
    private CancellationTokenSource? _cts;
    
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†(é€£æ‰“å¯¾ç­–)
    private long _version;
    
    // çŠ¶æ…‹(ä¸å¤‰)
    private ProductsState _state = ProductsState.Empty;
    
    public event Func<Task>? OnChangeAsync;
    
    public ProductsStore(
        IServiceScopeFactory scopeFactory,
        ILogger<ProductsStore> logger)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
    }
    
    public ProductsState GetState() => _state;
    
    /// <summary>
    /// åŒä¸€ã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã¯åˆæµã—ã€çµæœã‚’å…±æœ‰(single-flight)
    /// </summary>
    public Task LoadAsync(CancellationToken ct = default)
    {
        const string key = "products-load";  // å›ºæœ‰ã‚­ãƒ¼
        
        // âœ… single-flight: åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯1ã¤ã«åˆæµ
        return _inflightRequests.GetOrAdd(key, _ => LoadInternalAsync(ct))
            .ContinueWith(t =>
            {
                _inflightRequests.TryRemove(key, out _);  // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                return t;
            }, ct, TaskContinuationOptions.None, TaskScheduler.Default)
            .Unwrap();
    }
    
    /// <summary>
    /// å®Ÿéš›ã®èª­ã¿è¾¼ã¿å‡¦ç†(versioningä½µç”¨)
    /// </summary>
    private async Task LoadInternalAsync(CancellationToken ct)
    {
        // ç¾åœ¨ã®å®Ÿè¡Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨˜éŒ²
        var currentVersion = Interlocked.Increment(ref _version);
        
        // æ—¢å­˜ã®å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        _cts?.Cancel();
        _cts = CancellationTokenSource.CreateLinkedTokenSource(ct);
        
        await _gate.WaitAsync(_cts.Token);
        try
        {
            // âœ… versioning: å¤ã„å®Ÿè¡Œã¯çµæœã‚’ç ´æ£„
            if (currentVersion != _version)
            {
                _logger.LogDebug("å¤ã„å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—: Version {Current} != {Latest}", 
                    currentVersion, _version);
                return;
            }
            
            SetState(_state with { IsLoading = true, ErrorMessage = null });
            
            // å®Ÿéš›ã®DBèª­ã¿è¾¼ã¿(é‡ã„å‡¦ç†)
            using var scope = _scopeFactory.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
            
            var result = await mediator.Send(
                new GetProductsQuery(_state.CurrentPage, _state.PageSize), 
                _cts.Token);
            
            // âœ… æœ€æ–°ç‰ˆã®ã¿åæ˜ 
            if (currentVersion == _version && result.IsSuccess)
            {
                SetState(_state with
                {
                    IsLoading = false,
                    Products = result.Value.Items.ToImmutableList(),
                    TotalCount = result.Value.TotalCount,
                    ErrorMessage = null
                });
            }
            else if (currentVersion == _version)
            {
                SetState(_state with
                {
                    IsLoading = false,
                    ErrorMessage = result.Error
                });
            }
        }
        catch (OperationCanceledException)
        {
            if (currentVersion == _version)
            {
                _logger.LogDebug("LoadAsyncãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ");
                SetState(_state with { IsLoading = false });
            }
        }
        catch (Exception ex)
        {
            if (currentVersion == _version)
            {
                _logger.LogError(ex, "å•†å“ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
                SetState(_state with
                {
                    IsLoading = false,
                    ErrorMessage = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
                });
            }
        }
        finally
        {
            _gate.Release();
        }
    }
    
    private async void SetState(ProductsState newState)
    {
        // å·®åˆ†ãŒãªã„å ´åˆã¯é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—(å†æç”»æŠ‘åˆ¶)
        if (_state.Equals(newState))
        {
            _logger.LogTrace("State has no changes, skipping notification");
            return;
        }
        
        _state = newState;
        
        if (OnChangeAsync is null) return;
        
        // é€šçŸ¥æ™‚ã®ä¾‹å¤–ã‚’é£²ã¿è¾¼ã¾ãšãƒ­ã‚°
        foreach (var handler in OnChangeAsync.GetInvocationList().Cast<Func<Task>>())
        {
            try
            {
                await handler();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "State change notification failed");
                // ä¾‹å¤–ã‚’å†ã‚¹ãƒ­ãƒ¼ã›ãšã€ãƒ­ã‚°ã®ã¿è¨˜éŒ²
            }
        }
    }
    
    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
        _gate?.Dispose();
    }
}
```

**åŠ¹æœã®æ¯”è¼ƒ**:

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | é€£æ‰“10å› | DBè² è· | UIå¿œç­” |
|---------|---------|--------|--------|
| åˆ¶å¾¡ãªã— | 10å›å®Ÿè¡Œ | 10å› | é…ã„ |
| versioningã®ã¿ | 10å›å®Ÿè¡Œâ†’1å›åæ˜  | 10å› | é€Ÿã„ |
| versioning + single-flight | 1å›å®Ÿè¡Œâ†’1å›åæ˜  | 1å› | æœ€é€Ÿ |

**ä½¿ã„åˆ†ã‘ã‚¬ã‚¤ãƒ‰**:

```csharp
// è»½ã„Query(<100ms): versioningã®ã¿ã§ååˆ†
public Task LoadAsync(CancellationToken ct = default)
{
    var currentVersion = Interlocked.Increment(ref _version);
    // ... versioningå‡¦ç†ã®ã¿
}

// é‡ã„Query(>500ms): versioning + single-flightæ¨å¥¨
public Task LoadAsync(CancellationToken ct = default)
{
    return _inflightRequests.GetOrAdd("key", _ => LoadInternalAsync(ct))
        .ContinueWith(/* cleanup */)
        .Unwrap();
}

// é »ç¹ãªæ›´æ–°ç”»é¢: versioning + ãƒ‡ãƒã‚¦ãƒ³ã‚¹
private readonly Timer _debounceTimer;
public void TriggerLoad()
{
    _debounceTimer.Change(TimeSpan.FromMilliseconds(300), Timeout.InfiniteTimeSpan);
}
```

#### 9.5.2 SignalRé€šçŸ¥ã®ã‚³ã‚¢ãƒ¬ã‚¹&ãƒ‡ãƒã‚¦ãƒ³ã‚¹(åµå¯¾ç­–)

**çŸ­æ™‚é–“ã®è¤‡æ•°é€šçŸ¥ã‚’1å›ã®å†èª­è¾¼ã«ã¾ã¨ã‚ã‚‹**

```csharp
/// <summary>
/// SignalRé€šçŸ¥ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹å®Ÿè£…
/// </summary>
public sealed class ProductsStore : IDisposable
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly ILogger<ProductsStore> _logger;
    private readonly IMemoryCache _memoryCache;
    private readonly IHubConnection _hubConnection;
    
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨
    private readonly Timer _debounceTimer;
    private readonly HashSet<string> _pendingInvalidations = new();
    private readonly object _invalidationLock = new();
    
    // ... æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    
    public ProductsStore(
        IServiceScopeFactory scopeFactory,
        ILogger<ProductsStore> logger,
        IMemoryCache memoryCache,
        IHubConnection hubConnection)
    {
        _scopeFactory = scopeFactory;
        _logger = logger;
        _memoryCache = memoryCache;
        _hubConnection = hubConnection;
        
        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒãƒ¼ã®åˆæœŸåŒ–
        _debounceTimer = new Timer(
            FlushInvalidations, 
            null, 
            Timeout.Infinite, 
            Timeout.Infinite);
        
        // âœ… SignalR Hubã‹ã‚‰é€šçŸ¥ã‚’å—ä¿¡
        _hubConnection.On<string>("ProductInvalidated", OnProductInvalidated);
        _hubConnection.On<Guid>("ProductDeleted", OnProductDeleted);
        _hubConnection.On<Guid>("ProductUpdated", OnProductUpdated);
    }
    
    /// <summary>
    /// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–é€šçŸ¥ã®å—ä¿¡
    /// </summary>
    private void OnProductInvalidated(string cacheKey)
    {
        lock (_invalidationLock)
        {
            _pendingInvalidations.Add(cacheKey);
            
            // âœ… ãƒ‡ãƒã‚¦ãƒ³ã‚¹: 500msä»¥å†…ã®é€šçŸ¥ã¯ã¾ã¨ã‚ã‚‹
            _debounceTimer.Change(
                TimeSpan.FromMilliseconds(500), 
                Timeout.InfiniteTimeSpan);
        }
    }
    
    private void OnProductDeleted(Guid productId)
    {
        // ç´°ç²’åº¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
        OnProductInvalidated($"Product:{productId}");
        OnProductInvalidated("ProductList");  // ä¸€è¦§ã‚‚ç„¡åŠ¹åŒ–
    }
    
    private void OnProductUpdated(Guid productId)
    {
        OnProductInvalidated($"Product:{productId}");
        OnProductInvalidated("ProductList");
    }
    
    /// <summary>
    /// æºœã¾ã£ãŸç„¡åŠ¹åŒ–é€šçŸ¥ã‚’ä¸€æ‹¬å‡¦ç†
    /// </summary>
    private async void FlushInvalidations(object? state)
    {
        HashSet<string> keysToInvalidate;
        
        lock (_invalidationLock)
        {
            if (_pendingInvalidations.Count == 0) return;
            
            keysToInvalidate = new HashSet<string>(_pendingInvalidations);
            _pendingInvalidations.Clear();
        }
        
        // âœ… ã‚³ã‚¢ãƒ¬ã‚¹: è¤‡æ•°ã®ã‚­ãƒ¼ã‚’ä¸€åº¦ã«å‡¦ç†
        _logger.LogInformation(
            "Invalidating {Count} cache keys: {Keys}", 
            keysToInvalidate.Count, 
            string.Join(", ", keysToInvalidate));
        
        foreach (var key in keysToInvalidate)
        {
            _memoryCache.Remove(key);
        }
        
        // âœ… è©²å½“ã™ã‚‹ç”»é¢ã®ã¿å†èª­è¾¼(å…¨ãƒªãƒ­ãƒ¼ãƒ‰ã§ã¯ãªã„)
        if (keysToInvalidate.Contains("ProductList"))
        {
            try
            {
                await LoadAsync();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "SignalRé€šçŸ¥å¾Œã®å†èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }
    }
    
    public void Dispose()
    {
        _debounceTimer?.Dispose();
        _cts?.Cancel();
        _cts?.Dispose();
        _gate?.Dispose();
    }
}
```

**ç„¡åŠ¹åŒ–ã‚­ãƒ¼ã®è¦ç´„(é‡è¦)**:

```csharp
// âœ… GOOD: ç´°ç²’åº¦ã®ã‚­ãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰)
var cacheKey = $"GetProductQuery:{currentUserId}:Product:{productId}";
await _hubConnection.SendAsync("ProductInvalidated", cacheKey);

// âŒ BAD: ç²—ã„ã‚­ãƒ¼(å…¨å“¡ã«å½±éŸ¿)
await _hubConnection.SendAsync("ProductInvalidated", "AllProducts");  // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿
```

**åŠ¹æœæ¸¬å®š**:

| ã‚·ãƒŠãƒªã‚ª | ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‰ | ãƒ‡ãƒã‚¦ãƒ³ã‚¹å¾Œ |
|---------|------------|------------|
| 10ä»¶ã®é€£ç¶šæ›´æ–°é€šçŸ¥ | 10å›å†æç”» | 1å›å†æç”» |
| 100msã”ã¨ã«5é€šçŸ¥ | 5å›å†æç”» | 1å›å†æç”»(500mså¾Œ) |
| åˆ†æ•£ã—ãŸé€šçŸ¥ | Nå›å†æç”» | Nå›å†æç”»(å¤‰åŒ–ãªã—) |

**å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**:

- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/ãƒ†ãƒŠãƒ³ãƒˆIDã‚’å«ã‚ã‚‹
- [ ] ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ™‚é–“ã¯ç”»é¢ã®æ›´æ–°é »åº¦ã«å¿œã˜ã¦èª¿æ•´(300-1000ms)
- [ ] ç´°ç²’åº¦ã®ç„¡åŠ¹åŒ–ã‚­ãƒ¼ã‚’ä½¿ç”¨(å…¨ä½“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã¯é¿ã‘ã‚‹)
- [ ] SignalRå†æ¥ç¶šæ™‚ã®å†è³¼èª­å‡¦ç†ã‚’å®Ÿè£…
- [ ] ç„¡åŠ¹åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›(ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨)

---

### 9.6 çŠ¶æ…‹ç®¡ç†ã®é‹ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¦ï¼‰

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ä¸­é•·æœŸé‹ç”¨ã§çŠ¶æ…‹ç®¡ç†ãŒç ´ç¶»ã—ãªã„ãŸã‚ã®**é‹ç”¨ãƒ«ãƒ¼ãƒ«**ã‚’æ˜æ–‡åŒ–ã—ã¾ã™ã€‚

#### **9.6.1 Store ãŒå”¯ä¸€ã®çœŸå®Ÿ (Single Source of Truth)**

**åŸå‰‡**: Smart Component ã¯ `Store.GetState()` ã‚’èª­ã‚€ã ã‘ã€‚Dumb Component ã¯ `[Parameter]` ã§ã‚‚ã‚‰ã†ã ã‘ã€‚

**ãªãœé‡è¦ã‹:**

```csharp
// âŒ BAD: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§çŠ¶æ…‹ã®ã‚³ãƒ”ãƒ¼ã‚’ä¿æŒ
public class ProductList : ComponentBase
{
    [Inject] private ProductsStore Store { get; set; }

    private List<ProductDto> _localProducts = new();  // âŒ çŠ¶æ…‹ã®ã‚³ãƒ”ãƒ¼

    protected override async Task OnInitializedAsync()
    {
        var state = Store.GetState();
        _localProducts = state.Products.ToList();  // âŒ ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
    }
}
```

**å•é¡Œç‚¹:**
- StoreãŒæ›´æ–°ã•ã‚Œã¦ã‚‚ `_localProducts` ã¯å¤ã„ã¾ã¾
- è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§åŒã˜ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã¨ã€ç‰‡æ–¹ã ã‘å¤ã„è¡¨ç¤ºã«ãªã‚‹
- ã€Œã‚ã‚‹ç”»é¢ã ã‘è¡¨ç¤ºãŒå¤ã„ã€ã€Œé¸æŠçŠ¶æ…‹ã ã‘ãŒå‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚‚ã®ã‚’å¼•ããšã‚‹ã€ç³»ãƒã‚°ã®åŸå› 

**æ­£ã—ã„å®Ÿè£…:**

```csharp
// âœ… GOOD: Storeã‹ã‚‰ç›´æ¥èª­ã‚€
public class ProductList : ComponentBase
{
    [Inject] private ProductsStore Store { get; set; }

    // ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¯æŒãŸãšã€æ¯å›Storeã‹ã‚‰å–å¾—
    private ProductsState State => Store.GetState();

    protected override void OnInitialized()
    {
        Store.OnChangeAsync += StateHasChanged;  // å¤‰æ›´é€šçŸ¥ã‚’è³¼èª­
    }
}
```

```razor
@* è¡¨ç¤ºæ™‚ã‚‚ç›´æ¥Storeã‹ã‚‰ *@
@foreach (var product in State.Products)
{
    <ProductCard Product="@product" />
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- çŠ¶æ…‹ã®ã‚³ãƒ”ãƒ¼ãŒç”Ÿã¾ã‚Œãªã„
- è¤‡æ•°ã®Smart ComponentãŒåŒã˜ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¦ã‚‚ç ´ç¶»ã—ãªã„
- ä¸¦è¡Œæ›´æ–°æ™‚ã®æ•´åˆæ€§ãŒä¿è¨¼ã•ã‚Œã‚‹

---

#### **9.6.2 Storeã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ã€Œãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å˜ä½ã€**

**åŸå‰‡**: Storeã¯ã€Œç‰¹å®šã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆç”»é¢ï¼‰å˜ä½ã€ã§åˆ†å‰²ã—ã¦ã‚ˆã„ã€‚ç„¡ç†ã«1ã¤ã®Storeã§å…¨éƒ¨ã‚’è³„ãŠã†ã¨ã—ãªã„ã€‚

**æ‚ªã„ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```csharp
// âŒ BAD: 1ã¤ã®StoreãŒè¤‡æ•°ã®ç”»é¢ã®çŠ¶æ…‹ã‚’æŒã¤
public sealed record ProductsState
{
    // ä¸€è¦§ç”»é¢ç”¨
    public ImmutableList<ProductDto> ListItems { get; init; }
    public int CurrentPage { get; init; }
    public ImmutableHashSet<Guid> SelectedIds { get; init; }

    // è©³ç´°ç”»é¢ç”¨
    public ProductDetailDto? DetailItem { get; init; }
    public ImmutableList<StockHistoryDto> StockHistory { get; init; }

    // ç·¨é›†ç”»é¢ç”¨
    public ProductEditDto? EditingItem { get; init; }
    public Dictionary<string, string> ValidationErrors { get; init; }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”»é¢ç”¨
    public ImmutableList<ProductExportDto> ExportData { get; init; }
}
```

**å•é¡Œç‚¹:**
- StateãŒè‚¥å¤§åŒ–ã—ã¦ç®¡ç†ãŒå›°é›£
- ç„¡é–¢ä¿‚ãªç”»é¢ã®çŠ¶æ…‹ãŒæ··åœ¨
- ã©ã®ç”»é¢ã§ã©ã®çŠ¶æ…‹ã‚’ä½¿ã†ã‹ä¸æ˜ç­

**è‰¯ã„ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```csharp
// âœ… GOOD: ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã”ã¨ã«Storeã‚’åˆ†å‰²

// ä¸€è¦§ç”»é¢ç”¨
public sealed class ProductsListStore
{
    private ProductsListState _state = ProductsListState.Empty;
    // ...
}

public sealed record ProductsListState
{
    public ImmutableList<ProductDto> Products { get; init; }
    public int CurrentPage { get; init; }
    public ImmutableHashSet<Guid> SelectedIds { get; init; }
}

// è©³ç´°ç”»é¢ç”¨
public sealed class ProductDetailStore
{
    private ProductDetailState _state = ProductDetailState.Empty;
    // ...
}

public sealed record ProductDetailState
{
    public ProductDetailDto? Product { get; init; }
    public ImmutableList<StockHistoryDto> StockHistory { get; init; }
}

// ç·¨é›†ç”»é¢ç”¨
public sealed class ProductEditStore
{
    private ProductEditState _state = ProductEditState.Empty;
    // ...
}

public sealed record ProductEditState
{
    public ProductEditDto? Product { get; init; }
    public Dictionary<string, string> ValidationErrors { get; init; }
}
```

**åˆ¤æ–­åŸºæº–:**

| çŠ¶æ³ | åˆ¤æ–­ |
|------|------|
| ä¸€è¦§ã¨è©³ç´°ã§å¿…è¦ãªæƒ…å ±ãŒå¤§ããç•°ãªã‚‹ | Storeåˆ†å‰² |
| ä¸€è¦§ã¨è©³ç´°ãŒåŒã˜ç”»é¢ã«åŒæ™‚è¡¨ç¤ºã•ã‚Œã‚‹ | Storeçµ±åˆ |
| StateãŒ10å€‹ä»¥ä¸Šã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ | åˆ†å‰²ã‚’æ¤œè¨ |
| è¤‡æ•°ç”»é¢ã§çŠ¶æ…‹ãŒç«¶åˆã™ã‚‹ | Storeåˆ†å‰² |

---

#### **9.6.3 è³¼èª­ç®¡ç†ã®å®‰å…¨åŒ–ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰**

**åŸå‰‡**: `OnChangeAsync` ã®è³¼èª­/è§£é™¤ã‚’å‹ã§ä¿è¨¼ã™ã‚‹ã€‚

**å•é¡Œã®ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```csharp
// âŒ BAD: è³¼èª­è§£é™¤å¿˜ã‚Œã§ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
protected override void OnInitialized()
{
    Store.OnChangeAsync += StateHasChanged;
    // Disposeã§è§£é™¤ã—å¿˜ã‚Œ â†’ ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
}

// DisposeãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„ or è§£é™¤å¿˜ã‚Œ
```

**æ”¹å–„: Subscribeãƒ˜ãƒ«ãƒ‘ãƒ¼ã®å°å…¥**

**Storeå´:**

```csharp
public sealed class ProductsStore : IDisposable
{
    public event Func<Task>? OnChangeAsync;

    /// <summary>
    /// è³¼èª­ã‚’å®‰å…¨ã«ç®¡ç†ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    /// </summary>
    public IDisposable Subscribe(Func<Task> handler)
    {
        OnChangeAsync += handler;
        return new Subscription(this, handler);
    }

    private sealed class Subscription : IDisposable
    {
        private readonly ProductsStore _store;
        private readonly Func<Task> _handler;
        private bool _disposed;

        public Subscription(ProductsStore store, Func<Task> handler)
        {
            _store = store;
            _handler = handler;
        }

        public void Dispose()
        {
            if (_disposed) return;
            _disposed = true;
            _store.OnChangeAsync -= _handler;
        }
    }

    // ...
}
```

**Componentå´:**

```csharp
// âœ… GOOD: IDisposableã§è³¼èª­ç®¡ç†
public class ProductList : ComponentBase, IDisposable
{
    [Inject] private ProductsStore Store { get; set; }
    [Inject] private ProductListActions Actions { get; set; }

    private IDisposable? _subscription;

    protected override async Task OnInitializedAsync()
    {
        // Subscribeãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ç”¨
        _subscription = Store.Subscribe(HandleStateChanged);
        await Actions.LoadAsync();
    }

    private Task HandleStateChanged()
    {
        return InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        // ç¢ºå®Ÿã«è³¼èª­è§£é™¤
        _subscription?.Dispose();
    }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- è³¼èª­è§£é™¤å¿˜ã‚Œã‚’å‹ã§é˜²æ­¢
- `using` ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ä½¿ãˆã‚‹
- è¤‡æ•°è³¼èª­ã®ç®¡ç†ãŒå®¹æ˜“

---

#### **9.6.4 SetState ã¯ Task ã‚’è¿”ã™**

**åŸå‰‡**: `SetState` ã¯ `async void` ã§ã¯ãªã `Task` ã‚’è¿”ã™ã€‚

**å•é¡Œã®ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```csharp
// âŒ BAD: async void
private async void SetState(ProductsState newState)
{
    _state = newState;

    if (OnChangeAsync != null)
    {
        await OnChangeAsync.Invoke();  // å‘¼ã³å‡ºã—å´ãŒå®Œäº†ã‚’å¾…ã¦ãªã„
    }
}
```

**å•é¡Œç‚¹:**
- å‘¼ã³å‡ºã—å´ãŒå®Œäº†ã‚’å¾…ã¦ãªã„
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå›°é›£
- å°†æ¥ã®æ‹¡å¼µæ€§ãŒä½ã„

**æ”¹å–„ç‰ˆ:**

```csharp
// âœ… GOOD: Task ã‚’è¿”ã™
private async Task SetStateAsync(ProductsState newState)
{
    // å·®åˆ†ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
    if (_state.Equals(newState))
    {
        _logger.LogTrace("State has no changes, skipping notification");
        return;
    }

    _state = newState;

    if (OnChangeAsync is null) return;

    // å…¨ã¦ã®è³¼èª­è€…ã«é€šçŸ¥ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
    var tasks = OnChangeAsync
        .GetInvocationList()
        .Cast<Func<Task>>()
        .Select(async handler =>
        {
            try
            {
                await handler();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "State change notification failed");
                // 1ã¤ã®è³¼èª­è€…ã®ã‚¨ãƒ©ãƒ¼ãŒä»–ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«ã‚­ãƒ£ãƒƒãƒ
            }
        });

    await Task.WhenAll(tasks);
}
```

**å‘¼ã³å‡ºã—å´:**

```csharp
public async Task LoadAsync(CancellationToken ct = default)
{
    await _gate.WaitAsync(ct);
    try
    {
        await SetStateAsync(_state with { IsLoading = true });  // å®Œäº†ã‚’å¾…ã¦ã‚‹

        // ...

        await SetStateAsync(_state with
        {
            IsLoading = false,
            Products = result.Value.ToImmutableList()
        });
    }
    finally
    {
        _gate.Release();
    }
}
```

---

#### **9.6.5 PageActions ãŒè§¦ã‚Œã‚‹å…±é€šåŸºç›¤ã®é™å®š**

**åŸå‰‡**: PageActionsãŒç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚ˆã„å…±é€šåŸºç›¤ï¼ˆInfrastructure Storeï¼‰ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåŒ–ã™ã‚‹ã€‚

**æ¨å¥¨ãƒ«ãƒ¼ãƒ«:**

| å…±é€šåŸºç›¤ | PageActionsã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ | ç†ç”± |
|---------|------------------------|------|
| **NotificationStore** | âœ… OK | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã¯è‡ªç„¶ |
| **SessionProvider** | âœ… OK | æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã¯å¿…è¦ |
| **LayoutStore** | âš ï¸ æ…é‡ | ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‹æ‰‹ã«å¤‰ãˆã‚‹ã¨UXãŒå£Šã‚Œã‚‹ |
| **ThemeProvider** | âŒ NG | ã‚¢ãƒ—ãƒªå…¨ä½“ã®å¤–è¦³ã‚’ç”»é¢ãŒå¤‰ãˆã‚‹ã¹ãã§ãªã„ |
| **PreferencesStore** | âš ï¸ æ…é‡ | èª­ã¿å–ã‚Šã¯OKã€æ›¸ãè¾¼ã¿ã¯è¨­å®šç”»é¢ã®ã¿ |

**è‰¯ã„ä¾‹:**

```csharp
// âœ… GOOD
public sealed class ProductListActions
{
    private readonly ProductsStore _store;
    private readonly NotificationStore _notification;  // OK
    private readonly SessionProvider _session;         // OK

    public async Task DeleteAsync(Guid productId)
    {
        // æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆSessionProviderï¼‰
        if (!_session.State.IsInRole("Admin"))
        {
            await _notification.ShowErrorAsync("ã‚¨ãƒ©ãƒ¼", "æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
            return;
        }

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆNotificationStoreï¼‰
        await _notification.ShowConfirmAsync(
            "å‰Šé™¤ç¢ºèª",
            "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
            onConfirm: async () =>
            {
                var success = await _store.DeleteAsync(productId);
                if (success)
                {
                    // æˆåŠŸé€šçŸ¥ï¼ˆNotificationStoreï¼‰
                    await _notification.ShowSuccessAsync("å‰Šé™¤å®Œäº†", "å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
                }
            });
    }
}
```

**æ‚ªã„ä¾‹:**

```csharp
// âŒ BAD
public sealed class ProductListActions
{
    private readonly LayoutStore _layout;        // âš ï¸ æ…é‡ã«
    private readonly ThemeProvider _theme;       // âŒ NG

    public async Task ShowDetailAsync(Guid productId)
    {
        // âŒ å‹æ‰‹ã«ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã¨ç•°ãªã‚‹å¯èƒ½æ€§ï¼‰
        await _layout.CloseSidebarAsync();

        // âŒ å‹æ‰‹ã«ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«å¤‰ãˆã‚‹ï¼ˆå®Œå…¨ã«NGï¼‰
        await _theme.SetDarkModeAsync();

        // ...
    }
}
```

**ä¾‹å¤–çš„ã«è¨±å®¹ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹:**

```csharp
// âœ… OK: è©³ç´°ç”»é¢å°‚ç”¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ï¼ˆæ˜ç¤ºçš„ãªä»•æ§˜ï¼‰
public sealed class ProductDetailActions
{
    private readonly LayoutStore _layout;

    public async Task EnterFullScreenModeAsync()
    {
        // ä»•æ§˜ã¨ã—ã¦ã€Œè©³ç´°ç”»é¢ã¯ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã€ãŒæ±ºã¾ã£ã¦ã„ã‚‹å ´åˆã®ã¿OK
        await _layout.SetFullScreenAsync(true);
    }
}
```

---

#### **9.6.6 ç”»é¢å°‚ç”¨DTOã®æ­£å½“åŒ–**

**åŸå‰‡**: Stateã«å…¥ã‚Œã‚‹å‹ã¯ã€Œãã®ç”»é¢ã«å¿…è¦ãªæœ€å°é™ã®DTOã€ã§ã‚ˆã„ã€‚æ±ç”¨DTOã®å†åˆ©ç”¨ã‚’å¼·åˆ¶ã—ãªã„ã€‚

**æ‚ªã„ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```csharp
// âŒ BAD: 1ã¤ã®DTOã‚’å…¨ç”»é¢ã§ä½¿ã„å›ãã†ã¨ã—ã¦è‚¥å¤§åŒ–
public sealed record ProductDto
{
    // ä¸€è¦§ç”»é¢ç”¨
    public Guid Id { get; init; }
    public string Name { get; init; }
    public decimal Price { get; init; }

    // è©³ç´°ç”»é¢ç”¨
    public string Description { get; init; }
    public List<SupplierDto> Suppliers { get; init; }
    public List<StockHistoryDto> StockHistory { get; init; }

    // ç·¨é›†ç”»é¢ç”¨
    public List<CategoryDto> AllCategories { get; init; }
    public Dictionary<string, string> ValidationErrors { get; init; }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”»é¢ç”¨
    public DateTime CreatedAt { get; init; }
    public string CreatedByUserName { get; init; }
    // ...ã•ã‚‰ã«å¢—ãˆç¶šã‘ã‚‹
}
```

**å•é¡Œç‚¹:**
- DTOãŒè‚¥å¤§åŒ–ã—ã¦ä¿å®ˆå›°é›£
- ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã¾ã§å–å¾—ãƒ»è»¢é€ã•ã‚Œã‚‹
- ç”»é¢ã”ã¨ã®é–¢å¿ƒäº‹ãŒåˆ†é›¢ã•ã‚Œã¦ã„ãªã„

**è‰¯ã„ãƒ‘ã‚¿ãƒ¼ãƒ³:**

```csharp
// âœ… GOOD: ç”»é¢ã”ã¨ã«å°‚ç”¨DTOã‚’ä½œã‚‹

// ä¸€è¦§ç”»é¢ç”¨ï¼ˆæœ€å°é™ï¼‰
public sealed record ProductListItemDto
{
    public Guid Id { get; init; }
    public string Name { get; init; }
    public string DisplayPrice { get; init; }  // æ•´å½¢æ¸ˆã¿
    public int Stock { get; init; }
}

// è©³ç´°ç”»é¢ç”¨
public sealed record ProductDetailDto
{
    public Guid Id { get; init; }
    public string Name { get; init; }
    public decimal Price { get; init; }
    public string Description { get; init; }
    public ImmutableList<SupplierDto> Suppliers { get; init; }
    public ImmutableList<StockHistoryDto> StockHistory { get; init; }
}

// ç·¨é›†ç”»é¢ç”¨
public sealed record ProductEditDto
{
    public Guid Id { get; init; }
    public string Name { get; init; }
    public decimal Price { get; init; }
    public Guid CategoryId { get; init; }
    public ImmutableList<CategoryDto> AvailableCategories { get; init; }
}

// CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨
public sealed record ProductExportDto
{
    public Guid Id { get; init; }
    public string Name { get; init; }
    public decimal Price { get; init; }
    public DateTime CreatedAt { get; init; }
    public string CreatedByUserName { get; init; }
}
```

**Queryã‚‚ç”»é¢ã”ã¨ã«åˆ†ã‘ã‚‹:**

```csharp
// ä¸€è¦§ç”»é¢ç”¨Query
public sealed record GetProductListQuery : IQuery<PagedResult<ProductListItemDto>>
{
    public int Page { get; init; }
    public int PageSize { get; init; }
}

// è©³ç´°ç”»é¢ç”¨Query
public sealed record GetProductDetailQuery : IQuery<ProductDetailDto>
{
    public Guid ProductId { get; init; }
}

// ç·¨é›†ç”»é¢ç”¨Query
public sealed record GetProductForEditQuery : IQuery<ProductEditDto>
{
    public Guid ProductId { get; init; }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- å„ç”»é¢ã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å–å¾—
- DTOã®è‚¥å¤§åŒ–ã‚’é˜²æ­¢
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼ˆä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãªã„ï¼‰
- ä¿å®ˆæ€§å‘ä¸Šï¼ˆç”»é¢ã”ã¨ã®å¤‰æ›´ãŒç‹¬ç«‹ï¼‰

---

#### **9.6.7 é‹ç”¨ãƒ«ãƒ¼ãƒ«ã¾ã¨ã‚**

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ã“ã¨ã§ã€çŠ¶æ…‹ç®¡ç†ãŒé•·æœŸçš„ã«ç ´ç¶»ã—ã«ãããªã‚Šã¾ã™ï¼š

1. âœ… **Single Source of Truth**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§çŠ¶æ…‹ã®ã‚³ãƒ”ãƒ¼ã‚’æŒãŸãªã„
2. âœ… **Storeã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å˜ä½**: ç„¡ç†ã«1ã¤ã«ã¾ã¨ã‚ãªã„
3. âœ… **è³¼èª­ç®¡ç†ã¯Subscribeãƒ˜ãƒ«ãƒ‘ãƒ¼**: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã‚’å‹ã§ä¿è¨¼
4. âœ… **SetStateã¯Taskã‚’è¿”ã™**: å°†æ¥ã®æ‹¡å¼µæ€§ã‚’ç¢ºä¿
5. âœ… **å…±é€šåŸºç›¤ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é™å®š**: NotificationStore, SessionProviderã®ã¿æ¨å¥¨
6. âœ… **ç”»é¢å°‚ç”¨DTOã‚’è¨±å®¹**: æ±ç”¨DTOã®è‚¥å¤§åŒ–ã‚’é˜²æ­¢

ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã‚’ãƒãƒ¼ãƒ å†…ã§å…±æœ‰ã—ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªã™ã‚‹ã“ã¨ã§ã€é«˜å“è³ªãªçŠ¶æ…‹ç®¡ç†ã‚’ç¶­æŒã§ãã¾ã™ã€‚

---
