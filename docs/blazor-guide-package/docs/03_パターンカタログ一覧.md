# 3. ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ã‚¿ãƒ­ã‚°ä¸€è¦§

[â† ç›®æ¬¡ã«æˆ»ã‚‹](00_README.md)

---

## ğŸ“š ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æä¾›ã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€AIé§†å‹•é–‹ç™ºã§å‚ç…§ã™ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Œå…¨ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã™ã€‚

---

## ğŸ—‚ï¸ ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†é¡

### 1. å‚ç…§ç³»ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆQueryï¼‰

ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®èª­ã¿å–ã‚Šå°‚ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | ä½¿ç”¨ã‚·ãƒŠãƒªã‚ª | è¤‡é›‘åº¦ | å®Ÿè£…å ´æ‰€ |
|-----------|------------|-------|---------|
| **GetProducts** | å…¨å•†å“ã®ä¸€è¦§å–å¾— | â­ ç°¡å˜ | `/Features/Products/GetProducts/` |
| **GetProductById** | IDã§å˜ä¸€å•†å“ã‚’å–å¾— | â­ ç°¡å˜ | `/Features/Products/GetProductById/` |
| **SearchProducts** | è¤‡é›‘ãªæ¤œç´¢ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ãƒšãƒ¼ã‚¸ãƒ³ã‚° | â­â­â­ è¤‡é›‘ | `/Features/Products/SearchProducts/` |
| **ExportProductsToCsv** | æ¤œç´¢çµæœã®CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ | â­â­ æ™®é€š | `/Features/Products/ExportProductsToCsv/` |

#### GetProducts - ä¸€è¦§å–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ãŸã„å ´åˆ
- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚„ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãŒä¸è¦ãªå ´åˆ
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åŠ¹ã‹ã›ãŸã„å ´åˆ

**ç‰¹å¾´:**
```csharp
// âœ… ã‚·ãƒ³ãƒ—ãƒ«ãªQuery
public sealed record GetProductsQuery() : IQuery<Result<IEnumerable<ProductDto>>>, ICacheableQuery
{
    public string GetCacheKey() => "products-all";
    public int CacheDurationMinutes => 5;
}

// âœ… Dapperã§æœ€é©åŒ–ã•ã‚ŒãŸã‚¯ã‚¨ãƒª
public async Task<IEnumerable<ProductDto>> Handle(GetProductsQuery query, CancellationToken ct)
{
    // Readãƒ¢ãƒ‡ãƒ«ï¼ˆDapperï¼‰ã§é«˜é€Ÿå–å¾—
    var sql = "SELECT Id, Name, Description, Price, Stock, Status FROM Products WHERE IsDeleted = 0";
    return await _connection.QueryAsync<ProductDto>(sql);
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `GetProductsQuery.cs` - Queryå®šç¾©
- `GetProductsHandler.cs` - å–å¾—ãƒ­ã‚¸ãƒƒã‚¯

---

#### GetProductById - å˜ä¸€å–å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- è©³ç´°ç”»é¢ã§å˜ä¸€ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆ
- ç·¨é›†ç”»é¢ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ

**ç‰¹å¾´:**
```csharp
// âœ… IDã§æ¤œç´¢
public sealed record GetProductByIdQuery(Guid ProductId)
    : IQuery<Result<ProductDetailDto>>, ICacheableQuery
{
    public string GetCacheKey() => $"product_{ProductId}";
    public int CacheDurationMinutes => 10;
}

// âœ… é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚ã¦å–å¾—
public async Task<ProductDetailDto> Handle(GetProductByIdQuery query, CancellationToken ct)
{
    // RepositoryçµŒç”±ã§é›†ç´„å…¨ä½“ã‚’å–å¾—
    var product = await _repository.GetAsync(new ProductId(query.ProductId), ct);

    // DTOã«å¤‰æ›ï¼ˆç”»åƒã‚‚å«ã‚€ï¼‰
    return ProductDetailDto.FromDomain(product);
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `GetProductByIdQuery.cs`
- `GetProductByIdHandler.cs`
- `ProductDetailDto.cs` - è©³ç´°æƒ…å ±ç”¨DTO

---

#### SearchProducts - æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¡ä»¶ã‚’æŒ‡å®šã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã™ã‚‹å ´åˆ
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒšãƒ¼ã‚¸ãƒ³ã‚°è¡¨ç¤ºã™ã‚‹å ´åˆ
- è¤‡æ•°ã®æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹å ´åˆ

**ç‰¹å¾´:**
```csharp
// âœ… æŸ”è»Ÿãªæ¤œç´¢æ¡ä»¶
public sealed record SearchProductsQuery(
    string? NameFilter = null,        // åå‰ã§éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
    decimal? MinPrice = null,         // æœ€ä½ä¾¡æ ¼
    decimal? MaxPrice = null,         // æœ€é«˜ä¾¡æ ¼
    ProductStatus? Status = null,     // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    int Page = 1,                     // ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆ1å§‹ã¾ã‚Šï¼‰
    int PageSize = 20,                // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚º
    string OrderBy = "Name",          // ã‚½ãƒ¼ãƒˆé …ç›®
    bool IsDescending = false         // é™é †ã‹
) : IQuery<Result<PagedResult<ProductDto>>>, ICacheableQuery;

// âœ… å‹•çš„ã‚¯ã‚¨ãƒªç”Ÿæˆ
public async Task<PagedResult<ProductDto>> Handle(SearchProductsQuery query, CancellationToken ct)
{
    var sql = new StringBuilder("SELECT * FROM Products WHERE IsDeleted = 0");
    var parameters = new DynamicParameters();

    // æ¡ä»¶ã«å¿œã˜ã¦WHEREå¥ã‚’è¿½åŠ 
    if (!string.IsNullOrEmpty(query.NameFilter))
    {
        sql.Append(" AND Name LIKE @NameFilter");
        parameters.Add("NameFilter", $"%{query.NameFilter}%");
    }

    if (query.MinPrice.HasValue)
    {
        sql.Append(" AND Price >= @MinPrice");
        parameters.Add("MinPrice", query.MinPrice.Value);
    }

    // ã‚½ãƒ¼ãƒˆã€ãƒšãƒ¼ã‚¸ãƒ³ã‚°å‡¦ç†...
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `SearchProductsQuery.cs`
- `SearchProductsHandler.cs`
- `PagedResult.cs` - ãƒšãƒ¼ã‚¸ãƒ³ã‚°çµæœã‚’è¡¨ã™DTO

---

#### ExportProductsToCsv - CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- æ¤œç´¢çµæœã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ
- Excelç­‰ã®å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã§ãƒ‡ãƒ¼ã‚¿åˆ†æã—ãŸã„å ´åˆ
- ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã®æº–å‚™

**ç‰¹å¾´:**
```csharp
// âœ… æ¤œç´¢æ¡ä»¶ã‚’å—ã‘å–ã‚Šã€CSVãƒã‚¤ãƒŠãƒªã‚’è¿”ã™
public sealed record ExportProductsToCsvQuery(
    string? NameFilter = null,
    decimal? MinPrice = null,
    decimal? MaxPrice = null,
    ProductStatus? Status = null
) : IQuery<Result<byte[]>>;  // ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™

// âœ… CsvHelperã§CSVç”Ÿæˆ
public async Task<Result<byte[]>> Handle(ExportProductsToCsvQuery query, CancellationToken ct)
{
    // 1. æ¤œç´¢æ¡ä»¶ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆä¸Šé™10,000ä»¶ï¼‰
    var products = await GetProductsByFilterAsync(query, maxResults: 10000, ct);

    // 2. MemoryStreamã§CSVç”Ÿæˆ
    using var memoryStream = new MemoryStream();
    using var writer = new StreamWriter(memoryStream, new UTF8Encoding(true)); // BOMä»˜ãUTF-8
    using var csv = new CsvWriter(writer, CultureInfo.GetCultureInfo("ja-JP"));

    // 3. ãƒ˜ãƒƒãƒ€ãƒ¼æ›¸ãè¾¼ã¿
    csv.WriteField("å•†å“ID");
    csv.WriteField("å•†å“å");
    csv.WriteField("ä¾¡æ ¼");
    csv.WriteField("åœ¨åº«");
    csv.NextRecord();

    // 4. ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
    foreach (var product in products)
    {
        csv.WriteField(product.Id);
        csv.WriteField(product.Name);
        csv.WriteField(product.Price);
        csv.WriteField(product.Stock);
        csv.NextRecord();
    }

    await writer.FlushAsync();
    return Result.Success(memoryStream.ToArray());
}
```

**UIå´ã®ä½¿ç”¨ä¾‹:**
```csharp
// PageActions
public async Task ExportToCsvAsync(CancellationToken ct = default)
{
    var query = new ExportProductsToCsvQuery(
        NameFilter: _store.GetState().SearchFilter.Name,
        MinPrice: _store.GetState().SearchFilter.MinPrice,
        MaxPrice: _store.GetState().SearchFilter.MaxPrice,
        Status: _store.GetState().SearchFilter.Status
    );

    var result = await _mediator.Send(query, ct);

    if (result.IsSuccess)
    {
        // ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        var fileName = $"products_{DateTime.Now:yyyyMMddHHmmss}.csv";
        await _jsRuntime.InvokeVoidAsync("downloadFile", fileName, "text/csv", result.Value);
        _toast.Success("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ");
    }
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `ExportProductsToCsvQuery.cs`
- `ExportProductsToCsvHandler.cs`

---

### 2. æ›´æ–°ç³»ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆCommandï¼‰

ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã®æ›¸ãè¾¼ã¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | ä½¿ç”¨ã‚·ãƒŠãƒªã‚ª | è¤‡é›‘åº¦ | å®Ÿè£…å ´æ‰€ |
|-----------|------------|-------|---------|
| **CreateProduct** | æ–°è¦å•†å“ã®ä½œæˆ | â­â­ æ™®é€š | `/Features/Products/CreateProduct/` |
| **UpdateProduct** | æ—¢å­˜å•†å“ã®æ›´æ–° | â­â­â­ è¤‡é›‘ | `/Features/Products/UpdateProduct/` |
| **DeleteProduct** | å˜ä¸€å•†å“ã®å‰Šé™¤ | â­â­ æ™®é€š | `/Features/Products/DeleteProduct/` |
| **BulkDeleteProducts** | è¤‡æ•°å•†å“ã®ä¸€æ‹¬å‰Šé™¤ | â­â­â­ è¤‡é›‘ | `/Features/Products/BulkDeleteProducts/` |
| **BulkUpdateProductPrices** | è¤‡æ•°å•†å“ã®ä¾¡æ ¼ä¸€æ‹¬æ›´æ–° | â­â­â­ è¤‡é›‘ | `/Features/Products/BulkUpdateProductPrices/` |
| **ImportProductsFromCsv** | CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ | â­â­â­â­ é«˜åº¦ | `/Features/Products/ImportProductsFromCsv/` |

#### CreateProduct - ä½œæˆãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- æ–°ã—ã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œæˆã™ã‚‹å ´åˆ
- ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã§åˆæœŸåŒ–ã—ãŸã„å ´åˆ

**ç‰¹å¾´:**
```csharp
// âœ… å¿…è¦ãªæƒ…å ±ã ã‘ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«
public sealed record CreateProductCommand(
    string Name,
    string Description,
    decimal Price,
    int InitialStock
) : ICommand<Result<Guid>>  // ä½œæˆã•ã‚ŒãŸIDã‚’è¿”ã™
{
    public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
}

// âœ… ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã§ä½œæˆ
public async Task<Result<Guid>> Handle(CreateProductCommand command, CancellationToken ct)
{
    // Domainã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã§ä½œæˆ
    var product = Product.Create(
        command.Name,
        command.Description,
        new Money(command.Price),
        command.InitialStock
    );

    await _repository.SaveAsync(product, ct);

    return Result.Success(product.Id.Value);
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `CreateProductCommand.cs`
- `CreateProductHandler.cs`
- `CreateProductValidator.cs` - å…¥åŠ›æ¤œè¨¼

---

#### UpdateProduct - æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨ã¾ãŸã¯å…¨éƒ¨ã‚’å¤‰æ›´ã—ãŸã„å ´åˆ
- æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ãŒå¿…è¦ãªå ´åˆ

**ç‰¹å¾´:**
```csharp
// âœ… Versionã§æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡
public sealed record UpdateProductCommand(
    Guid ProductId,
    string Name,
    string Description,
    decimal Price,
    int Stock,
    long Version  // æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ç”¨
) : ICommand<Result>
{
    public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
}

// âœ… ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã§å¤‰æ›´
public async Task<Result> Handle(UpdateProductCommand command, CancellationToken ct)
{
    var product = await _repository.GetAsync(new ProductId(command.ProductId), ct);

    if (product is null)
        return Result.Fail("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

    // Versionãƒã‚§ãƒƒã‚¯ï¼ˆæ¥½è¦³çš„æ’ä»–åˆ¶å¾¡ï¼‰
    if (product.Version != command.Version)
        return Result.Fail("ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚");

    // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã§å¤‰æ›´
    product.ChangeName(command.Name);
    product.ChangeDescription(command.Description);
    product.ChangePrice(new Money(command.Price));
    product.ChangeStock(command.Stock);

    await _repository.SaveAsync(product, ct);

    return Result.Success();
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `UpdateProductCommand.cs`
- `UpdateProductHandler.cs`
- `UpdateProductValidator.cs`

---

#### DeleteProduct - å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- å˜ä¸€ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å‰Šé™¤ã—ãŸã„å ´åˆ
- å‰Šé™¤å‰ã«ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’æ¤œè¨¼ã—ãŸã„å ´åˆï¼ˆåœ¨åº«ãƒã‚§ãƒƒã‚¯ãªã©ï¼‰

**ç‰¹å¾´:**
```csharp
// âœ… IDã®ã¿æŒ‡å®š
public sealed record DeleteProductCommand(Guid ProductId) : ICommand<Result>
{
    public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
}

// âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã§æ¤œè¨¼
public async Task<Result> Handle(DeleteProductCommand command, CancellationToken ct)
{
    var product = await _repository.GetAsync(new ProductId(command.ProductId), ct);

    if (product is null)
        return Result.Fail("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

    try
    {
        // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã§æ¤œè¨¼ï¼ˆåœ¨åº«ãŒã‚ã‚‹å•†å“ã¯å‰Šé™¤ä¸å¯ãªã©ï¼‰
        product.Delete();
    }
    catch (DomainException ex)
    {
        return Result.Fail(ex.Message);
    }

    await _repository.SaveAsync(product, ct);

    return Result.Success();
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `DeleteProductCommand.cs`
- `DeleteProductHandler.cs`
- `DeleteProductValidator.cs`

---

#### BulkDeleteProducts - ä¸€æ‹¬å‰Šé™¤ãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- è¤‡æ•°ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¸€åº¦ã«å‰Šé™¤ã—ãŸã„å ´åˆ
- UIä¸Šã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¤‡æ•°é¸æŠã—ã¦å‰Šé™¤ã™ã‚‹å ´åˆ

**ç‰¹å¾´:**
```csharp
// âœ… è¤‡æ•°IDã‚’å—ã‘å–ã‚‹
public sealed record BulkDeleteProductsCommand(
    IEnumerable<Guid> ProductIds
) : ICommand<Result<BulkOperationResult>>
{
    public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
}

// âœ… å„å‰Šé™¤ã¯å€‹åˆ¥ã«æ¤œè¨¼
public async Task<Result<BulkOperationResult>> Handle(BulkDeleteProductsCommand command, CancellationToken ct)
{
    var succeeded = 0;
    var failed = 0;
    var errors = new List<string>();

    foreach (var productId in command.ProductIds)
    {
        var product = await _repository.GetAsync(new ProductId(productId), ct);

        if (product is null)
        {
            failed++;
            errors.Add($"å•†å“ {productId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            continue;
        }

        try
        {
            product.Delete();  // å„å‰Šé™¤ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«æ¤œè¨¼ã‚’é€šã™
            await _repository.SaveAsync(product, ct);
            succeeded++;
        }
        catch (DomainException ex)
        {
            failed++;
            errors.Add($"å•†å“ {productId}: {ex.Message}");
        }
    }

    return Result.Success(new BulkOperationResult(succeeded, failed, errors));
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `BulkDeleteProductsCommand.cs`
- `BulkDeleteProductsHandler.cs`
- `BulkOperationResult.cs`

---

#### BulkUpdateProductPrices - ä¸€æ‹¬ä¾¡æ ¼æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- ã‚»ãƒ¼ãƒ«æ™‚ã«è¤‡æ•°å•†å“ã®ä¾¡æ ¼ã‚’ä¸€æ‹¬å¤‰æ›´ã—ãŸã„å ´åˆ
- ä¾¡æ ¼æ”¹å®šã‚’ä¸€æ‹¬ã§é©ç”¨ã—ãŸã„å ´åˆ
- å•†å“ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®ä¾¡æ ¼èª¿æ•´

**ç‰¹å¾´:**
```csharp
// âœ… ProductIdã€æ–°ä¾¡æ ¼ã€Versionã®ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã‚‹
public sealed record BulkUpdateProductPricesCommand(
    IReadOnlyList<ProductPriceUpdate> Updates
) : ICommand<Result<BulkOperationResult>>
{
    public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
}

public record ProductPriceUpdate(
    Guid ProductId,
    decimal NewPrice,
    int Version  // æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡
);

// âœ… å„å•†å“ã®ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’å€‹åˆ¥ã«æ¤œè¨¼
public async Task<Result<BulkOperationResult>> Handle(
    BulkUpdateProductPricesCommand command,
    CancellationToken ct)
{
    // ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: 100ä»¶ã¾ã§ï¼‰
    if (command.Updates.Count > 100)
        return Result.Fail("ä¸€åº¦ã«æ›´æ–°ã§ãã‚‹å•†å“ã¯100ä»¶ã¾ã§ã§ã™");

    var succeeded = 0;
    var failed = 0;
    var errors = new List<string>();

    foreach (var update in command.Updates)
    {
        var product = await _repository.GetAsync(new ProductId(update.ProductId), ct);

        if (product is null)
        {
            failed++;
            errors.Add($"å•†å“ {update.ProductId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            continue;
        }

        // Versionãƒã‚§ãƒƒã‚¯
        if (product.Version != update.Version)
        {
            failed++;
            errors.Add($"å•†å“ {update.ProductId} ã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™");
            continue;
        }

        try
        {
            // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã§ä¾¡æ ¼å¤‰æ›´ï¼ˆ50%ä»¥ä¸Šã®å€¤ä¸‹ã’åˆ¶é™ãªã©ã®ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ï¼‰
            product.ChangePrice(new Money(update.NewPrice));
            await _repository.SaveAsync(product, ct);
            succeeded++;
        }
        catch (DomainException ex)
        {
            failed++;
            errors.Add($"å•†å“ {update.ProductId}: {ex.Message}");
        }
    }

    return Result.Success(new BulkOperationResult(succeeded, failed, errors));
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `BulkUpdateProductPricesCommand.cs`
- `BulkUpdateProductPricesHandler.cs`
- `ProductPriceUpdate.cs`

---

#### ImportProductsFromCsv - CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

**ã„ã¤ä½¿ã†ã‹:**
- CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ç™»éŒ²ã—ãŸã„å ´åˆ
- å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ

**ç‰¹å¾´:**
```csharp
// âœ… Streamã§å—ã‘å–ã‚‹ï¼ˆãƒ¡ãƒ¢ãƒªåŠ¹ç‡ï¼‰
public sealed record ImportProductsFromCsvCommand(
    Stream CsvStream
) : ICommand<Result<BulkOperationResult>>
{
    public string IdempotencyKey { get; init; } = Guid.NewGuid().ToString();
}

// âœ… ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ã§å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ã«å‡¦ç†
public async Task<Result<BulkOperationResult>> Handle(
    ImportProductsFromCsvCommand command,
    CancellationToken ct)
{
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: 10MB ã¾ã§ï¼‰
    if (command.CsvStream.Length > 10 * 1024 * 1024)
        return Result.Fail("ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBã¾ã§ã§ã™");

    var succeeded = 0;
    var failed = 0;
    var errors = new List<string>();
    var rowNumber = 1;

    using var reader = new StreamReader(command.CsvStream, Encoding.UTF8);
    using var csv = new CsvReader(reader, CultureInfo.GetCultureInfo("ja-JP"));

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’èª­ã¿é£›ã°ã™
    await csv.ReadAsync();
    csv.ReadHeader();

    // è¡Œã”ã¨ã«å‡¦ç†ï¼ˆæœ€å¤§1,000ä»¶ï¼‰
    while (await csv.ReadAsync() && rowNumber <= 1000)
    {
        rowNumber++;

        try
        {
            // CSVè¡Œã‚’ãƒ‘ãƒ¼ã‚¹
            var name = csv.GetField<string>("å•†å“å");
            var description = csv.GetField<string>("èª¬æ˜");
            var price = csv.GetField<decimal>("ä¾¡æ ¼");
            var stock = csv.GetField<int>("åœ¨åº«");

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (string.IsNullOrEmpty(name))
            {
                failed++;
                errors.Add($"{rowNumber}è¡Œç›®: å•†å“åã¯å¿…é ˆã§ã™");
                continue;
            }

            // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¯ãƒˆãƒªã§ä½œæˆ
            var product = Product.Create(name, description, new Money(price), stock);
            await _repository.SaveAsync(product, ct);
            succeeded++;
        }
        catch (Exception ex)
        {
            failed++;
            errors.Add($"{rowNumber}è¡Œç›®: {ex.Message}");
        }
    }

    if (rowNumber > 1000)
        errors.Add("1,000ä»¶ã‚’è¶…ãˆã‚‹è¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã—ãŸ");

    return Result.Success(new BulkOperationResult(succeeded, failed, errors));
}
```

**UIå´ã®ä½¿ç”¨ä¾‹:**
```csharp
// PageActions
public async Task ImportFromCsvAsync(IBrowserFile file, CancellationToken ct = default)
{
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if (file.Size > 10 * 1024 * 1024)
    {
        _toast.Error("ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBã¾ã§ã§ã™");
        return;
    }

    await using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
    var command = new ImportProductsFromCsvCommand(stream);
    var result = await _mediator.Send(command, ct);

    if (result.IsSuccess)
    {
        var bulkResult = result.Value;
        _toast.Success($"{bulkResult.Succeeded}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");

        if (bulkResult.Failed > 0)
        {
            // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
            await _dialog.ShowAsync("ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ", string.Join("\n", bulkResult.Errors));
        }

        await _store.LoadAsync(ct);  // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
    }
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«:**
- `ImportProductsFromCsvCommand.cs`
- `ImportProductsFromCsvHandler.cs`

---

### 3. Domainå±¤ãƒ‘ã‚¿ãƒ¼ãƒ³

ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | ä½¿ç”¨ã‚·ãƒŠãƒªã‚ª | å®Ÿè£…å ´æ‰€ |
|-----------|------------|---------|
| **AggregateRoot** | é›†ç´„ãƒ«ãƒ¼ãƒˆã®åŸºåº•ã‚¯ãƒ©ã‚¹ | `/Domain/Common/AggregateRoot.cs` |
| **è¦ªå­é–¢ä¿‚** | Product-ProductImage | `/Domain/Products/Product.cs` |
| **çŠ¶æ…‹é·ç§»** | ProductStatusç®¡ç† | `/Domain/Products/Product.cs` |
| **è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«** | ä¾¡æ ¼å¤‰æ›´åˆ¶é™ãªã© | `/Domain/Products/Product.cs` |

è©³ç´°ã¯ [06_Domainå±¤ãƒ‘ã‚¿ãƒ¼ãƒ³](06_Domainå±¤ãƒ‘ã‚¿ãƒ¼ãƒ³.md) ã‚’å‚ç…§ã€‚

---

### 4. æ¨ªæ–­çš„é–¢å¿ƒäº‹ãƒ‘ã‚¿ãƒ¼ãƒ³

ã™ã¹ã¦ã®Command/Queryã«é©ç”¨ã•ã‚Œã‚‹å…±é€šæ©Ÿèƒ½ã€‚

| ãƒ‘ã‚¿ãƒ¼ãƒ³å | å½¹å‰² | å®Ÿè£…å ´æ‰€ |
|-----------|-----|---------|
| **MetricsBehavior** | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† | `/Infrastructure/Behaviors/` |
| **LoggingBehavior** | ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ­ã‚®ãƒ³ã‚° | `/Application/Common/Behaviors/` |
| **ValidationBehavior** | FluentValidationã«ã‚ˆã‚‹å…¥åŠ›æ¤œè¨¼ | `/Application/Common/Behaviors/` |
| **AuthorizationBehavior** | ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹èªå¯ | `/Infrastructure/Behaviors/` |
| **IdempotencyBehavior** | å†ªç­‰æ€§ä¿è¨¼ | `/Infrastructure/Behaviors/` |
| **CachingBehavior** | ã‚¯ã‚¨ãƒªçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | `/Infrastructure/Behaviors/` |
| **AuditLogBehavior** | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã®ç›£æŸ»è¨˜éŒ² | `/Infrastructure/Behaviors/` |
| **TransactionBehavior** | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç† | `/Infrastructure/Behaviors/` |

è©³ç´°ã¯ [æ¨ªæ–­çš„é–¢å¿ƒäº‹ã®è©³ç´°è¨­è¨ˆ](../../architecture/cross-cutting-concerns.md) ã‚’å‚ç…§ã€‚

---

## ğŸ¯ ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```mermaid
graph TD
    A[å®Ÿè£…ã—ãŸã„æ©Ÿèƒ½ã¯?] --> B{ãƒ‡ãƒ¼ã‚¿å–å¾—ã‹å¤‰æ›´ã‹?}

    B -->|ãƒ‡ãƒ¼ã‚¿å–å¾—| C{å–å¾—æ–¹æ³•ã¯?}
    B -->|ãƒ‡ãƒ¼ã‚¿å¤‰æ›´| D{å¤‰æ›´ã®ç¨®é¡ã¯?}

    C -->|å…¨ä»¶å–å¾—| E[GetProducts]
    C -->|IDæŒ‡å®š| F[GetProductById]
    C -->|æ¡ä»¶æ¤œç´¢| G[SearchProducts]
    C -->|CSVå‡ºåŠ›| H[ExportProductsToCsv]

    D -->|æ–°è¦ä½œæˆ| I[CreateProduct]
    D -->|æ›´æ–°| J{å˜ä¸€ã‹è¤‡æ•°ã‹?}
    D -->|å‰Šé™¤| K{å˜ä¸€ã‹è¤‡æ•°ã‹?}
    D -->|CSVå–è¾¼| L[ImportProductsFromCsv]

    J -->|å˜ä¸€| M[UpdateProduct]
    J -->|è¤‡æ•°ä¾¡æ ¼æ›´æ–°| N[BulkUpdateProductPrices]

    K -->|å˜ä¸€| O[DeleteProduct]
    K -->|è¤‡æ•°| P[BulkDeleteProducts]
```

---

## ğŸ“– æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®è©³ç´°ã‚¬ã‚¤ãƒ‰

- [04_åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³_å‚ç…§ç³»](04_åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³_å‚ç…§ç³».md) - Queryå®Ÿè£…ã®è©³ç´°
- [05_åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³_æ›´æ–°ç³»](05_åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³_æ›´æ–°ç³».md) - Commandå®Ÿè£…ã®è©³ç´°
- [06_Domainå±¤ãƒ‘ã‚¿ãƒ¼ãƒ³](06_Domainå±¤ãƒ‘ã‚¿ãƒ¼ãƒ³.md) - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…
- [10_AIã¸ã®å®Ÿè£…ã‚¬ã‚¤ãƒ‰](10_AIã¸ã®å®Ÿè£…ã‚¬ã‚¤ãƒ‰.md) - å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹

---

**ğŸ¤– ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ãŸã‚‰ã€è©²å½“ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥å‚ç…§ã—ã¦ãã ã•ã„**
