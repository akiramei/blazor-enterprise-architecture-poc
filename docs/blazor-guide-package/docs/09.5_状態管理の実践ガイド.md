# 9.5 çŠ¶æ…‹ç®¡ç†ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰

[â† ç›®æ¬¡ã«æˆ»ã‚‹](00_README.md)

---

## 9.5 çŠ¶æ…‹ç®¡ç†ã®å®Ÿè·µã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®çŠ¶æ…‹ç®¡ç†ã‚’**ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«**ã¨**ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰**ã«åˆ†ã‘ã¦è§£èª¬ã—ã¾ã™ã€‚

---

## ğŸ¯ çŠ¶æ…‹ç®¡ç†ã®2ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼

### ãƒ¬ã‚¤ãƒ¤ãƒ¼å®šç¾©

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | è²¬ä»»ç¯„å›² | å®Ÿè£…å ´æ‰€ | ä¾‹ |
|---------|---------|---------|-----|
| **ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«** | ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å…±é€š | `Infrastructure/` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ãƒ†ãƒ¼ãƒã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€é€šçŸ¥ |
| **ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰** | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å›ºæœ‰ | `Features/` | Products, Orders, Customers |

**é‡è¦ãªè¨­è¨ˆåŸå‰‡:**

âœ… **ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«** = æ¯å›æ›¸ãã¹ãã§ãªã„ï¼ˆå…±é€šåŸºç›¤ï¼‰
âœ… **ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰** = ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«å®Ÿè£…ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

---

## ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«çŠ¶æ…‹ç®¡ç†ï¼ˆInfrastructureï¼‰

### æä¾›ã•ã‚Œã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² | ä½¿ç”¨ä¾‹ |
|------------|------|--------|
| **SessionProvider** | èªè¨¼çŠ¶æ…‹ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± | ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèªã€ãƒ­ãƒ¼ãƒ«åˆ¤å®š |
| **ThemeProvider** | ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ | ãƒ†ãƒ¼ãƒã®åˆ‡ã‚Šæ›¿ãˆã€ã‚·ã‚¹ãƒ†ãƒ è¨­å®šé€£æº |
| **PreferencesStore** | è¨€èªãƒ»ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š | å¤šè¨€èªå¯¾å¿œã€æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ |
| **LayoutStore** | ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ»UIçŠ¶æ…‹ | ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰ã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ |
| **NotificationStore** | ãƒˆãƒ¼ã‚¹ãƒˆãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ« | æˆåŠŸé€šçŸ¥ã€ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã€ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° |

---

### 1. SessionProviderï¼ˆèªè¨¼çŠ¶æ…‹ç®¡ç†ï¼‰

#### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

`Routes.razor` ã§æ—¢ã«è¨­å®šæ¸ˆã¿ï¼š

```razor
<SessionProvider>
    <ThemeProvider>
        <Router AppAssembly="typeof(Program).Assembly">
            <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        </Router>
    </ThemeProvider>
</SessionProvider>
```

#### ä½¿ç”¨æ–¹æ³•

```razor
@page "/dashboard"

@code {
    [CascadingParameter]
    private SessionProvider SessionProvider { get; set; } = default!;

    protected override void OnInitialized()
    {
        var session = SessionProvider.State;

        if (session.IsAuthenticated)
        {
            var userId = session.UserId;
            var userName = session.UserName;
            var email = session.Email;

            // ãƒ­ãƒ¼ãƒ«åˆ¤å®š
            if (session.IsInRole("Admin"))
            {
                // ç®¡ç†è€…å°‚ç”¨å‡¦ç†
            }

            // è¤‡æ•°ãƒ­ãƒ¼ãƒ«åˆ¤å®š
            if (session.IsInAnyRole("Admin", "Manager"))
            {
                // ç®¡ç†è€…ã¾ãŸã¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å°‚ç”¨å‡¦ç†
            }
        }
    }
}
```

#### ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è¡¨ç¤º

```razor
@if (SessionProvider.State.IsInRole("Admin"))
{
    <div class="admin-panel">
        <button @onclick="DeleteAllAsync">å…¨å‰Šé™¤ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰</button>
    </div>
}
```

#### SessionStateã®æ§‹é€ 

```csharp
public sealed record SessionState
{
    public bool IsAuthenticated { get; init; }
    public Guid UserId { get; init; }
    public string UserName { get; init; }
    public string? Email { get; init; }
    public IReadOnlyList<string> Roles { get; init; }
    public Guid? TenantId { get; init; }

    public bool IsInRole(string role);
    public bool IsInAnyRole(params string[] roles);
}
```

---

### 2. ThemeProviderï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼‰

#### ä½¿ç”¨æ–¹æ³•

```razor
@code {
    [CascadingParameter]
    private ThemeProvider ThemeProvider { get; set; } = default!;

    private async Task ToggleTheme()
    {
        await ThemeProvider.ToggleThemeAsync();
    }

    private async Task SetDarkMode()
    {
        await ThemeProvider.SetDarkModeAsync();
    }

    private async Task SetLightMode()
    {
        await ThemeProvider.SetLightModeAsync();
    }

    private bool IsDarkMode => ThemeProvider.State.Mode == ThemeMode.Dark;
}
```

#### UIä¾‹

```razor
<div class="theme-toggle">
    <button @onclick="ToggleTheme">
        @if (ThemeProvider.State.Mode == ThemeMode.Dark)
        {
            <span>ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
        }
        else
        {
            <span>â˜€ï¸ ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</span>
        }
    </button>
</div>
```

#### ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒé€£æº

```razor
<div class="theme-settings">
    <label>
        <input type="checkbox"
               @bind="useSystemTheme"
               @bind:after="UpdateSystemThemePreference" />
        ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«å¾“ã†
    </label>
</div>

@code {
    private bool useSystemTheme;

    private async Task UpdateSystemThemePreference()
    {
        await ThemeProvider.SetUseSystemThemeAsync(useSystemTheme);
    }
}
```

---

### 3. PreferencesStoreï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šç®¡ç†ï¼‰

#### DIç™»éŒ²ï¼ˆProgram.csï¼‰

```csharp
builder.Services.AddScoped<PreferencesStore>();
```

#### ä½¿ç”¨æ–¹æ³•

```razor
@inject PreferencesStore PreferencesStore

@code {
    protected override async Task OnInitializedAsync()
    {
        // LocalStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        await PreferencesStore.InitializeAsync();

        // çŠ¶æ…‹å¤‰æ›´ã‚’è³¼èª­
        PreferencesStore.OnChangeAsync += StateHasChanged;
    }

    private async Task ChangeCulture(string culture)
    {
        await PreferencesStore.SetCultureAsync(culture);
    }

    private async Task ChangeTimeZone(string timeZoneId)
    {
        await PreferencesStore.SetTimeZoneAsync(timeZoneId);
    }

    private PreferencesState Prefs => PreferencesStore.GetState();
}
```

#### è¨­å®šUIä¾‹

```razor
<div class="preferences-panel">
    <h3>è¨€èªè¨­å®š</h3>
    <select @onchange="OnCultureChanged">
        <option value="ja-JP" selected="@(Prefs.Culture == "ja-JP")">æ—¥æœ¬èª</option>
        <option value="en-US" selected="@(Prefs.Culture == "en-US")">English</option>
    </select>

    <h3>ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</h3>
    <select @onchange="OnTimeZoneChanged">
        <option value="Tokyo Standard Time">æ—¥æœ¬æ¨™æº–æ™‚</option>
        <option value="UTC">UTC</option>
    </select>

    <h3>æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h3>
    <input type="text" @bind="dateFormat" @bind:after="UpdateDateFormat" />

    <button @onclick="ResetPreferences">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
</div>

@code {
    private string dateFormat = "";

    private async Task OnCultureChanged(ChangeEventArgs e)
    {
        await PreferencesStore.SetCultureAsync(e.Value?.ToString() ?? "ja-JP");
    }

    private async Task OnTimeZoneChanged(ChangeEventArgs e)
    {
        await PreferencesStore.SetTimeZoneAsync(e.Value?.ToString() ?? "Tokyo Standard Time");
    }

    private async Task UpdateDateFormat()
    {
        await PreferencesStore.SetDateFormatAsync(dateFormat);
    }

    private async Task ResetPreferences()
    {
        await PreferencesStore.ResetAsync();
    }
}
```

#### CultureInfoã®æ´»ç”¨

```csharp
var prefs = PreferencesStore.GetState();
var culture = prefs.GetCultureInfo();
var timeZone = prefs.GetTimeZoneInfo();

// æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
var formatted = DateTime.Now.ToString(prefs.DateFormat, culture);

// ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›
var localTime = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, timeZone);
```

---

### 4. LayoutStoreï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ç®¡ç†ï¼‰

#### DIç™»éŒ²ï¼ˆProgram.csï¼‰

```csharp
builder.Services.AddScoped<LayoutStore>();
```

#### ä½¿ç”¨æ–¹æ³•

```razor
@inject LayoutStore LayoutStore

@code {
    protected override async Task OnInitializedAsync()
    {
        await LayoutStore.InitializeAsync();
        LayoutStore.OnChangeAsync += StateHasChanged;
    }

    private async Task ToggleSidebar()
    {
        await LayoutStore.ToggleSidebarAsync();
    }

    private async Task ToggleSidebarPin()
    {
        await LayoutStore.ToggleSidebarPinAsync();
    }

    private LayoutState Layout => LayoutStore.GetState();
}
```

#### ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆUI

```razor
<div class="main-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar @(Layout.IsSidebarOpen ? "open" : "closed")
                          @(Layout.IsSidebarPinned ? "pinned" : "")">
        <div class="sidebar-header">
            <button @onclick="ToggleSidebarPin">
                @if (Layout.IsSidebarPinned)
                {
                    <span>ğŸ“Œ ãƒ”ãƒ³ç•™ã‚è§£é™¤</span>
                }
                else
                {
                    <span>ğŸ“ ãƒ”ãƒ³ç•™ã‚</span>
                }
            </button>
        </div>
        <nav>
            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        </nav>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <header>
            <button @onclick="ToggleSidebar">â˜°</button>
            <h1>@Title</h1>
        </header>
        <div class="content">
            @ChildContent
        </div>
    </main>
</div>

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public RenderFragment? ChildContent { get; set; }
}
```

#### ç”»é¢ã‚µã‚¤ã‚ºæ¤œçŸ¥ï¼ˆJavaScripté€£æºï¼‰

```razor
@inject IJSRuntime JSRuntime

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        // ç”»é¢ã‚µã‚¤ã‚ºã‚’ç›£è¦–
        await JSRuntime.InvokeVoidAsync("window.addEventListener", "resize",
            DotNetObjectReference.Create(this), "OnWindowResize");
    }
}

[JSInvokable]
public async Task OnWindowResize(int width)
{
    var screenSize = width switch
    {
        < 768 => ScreenSize.Mobile,
        < 1024 => ScreenSize.Tablet,
        _ => ScreenSize.Desktop
    };

    await LayoutStore.SetScreenSizeAsync(screenSize);
}
```

---

### 5. NotificationStoreï¼ˆé€šçŸ¥ç®¡ç†ï¼‰

#### DIç™»éŒ²ï¼ˆProgram.csï¼‰

```csharp
builder.Services.AddScoped<NotificationStore>();
```

#### ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥

```razor
@inject NotificationStore NotificationStore

@code {
    private async Task SaveAsync()
    {
        try
        {
            // ä¿å­˜å‡¦ç†
            await SaveDataAsync();

            // æˆåŠŸé€šçŸ¥
            await NotificationStore.ShowSuccessAsync(
                "ä¿å­˜å®Œäº†",
                "ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
        }
        catch (Exception ex)
        {
            // ã‚¨ãƒ©ãƒ¼é€šçŸ¥
            await NotificationStore.ShowErrorAsync(
                "ä¿å­˜å¤±æ•—",
                $"ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {ex.Message}");
        }
    }

    private async Task ShowCustomToast()
    {
        await NotificationStore.ShowToastAsync(
            title: "ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥",
            message: "ã“ã‚Œã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™",
            type: NotificationType.Info,
            durationMs: 7000,
            autoDismiss: true);
    }
}
```

#### ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```razor
@code {
    private async Task DeleteWithConfirm(Guid id)
    {
        await NotificationStore.ShowConfirmAsync(
            title: "å‰Šé™¤ç¢ºèª",
            message: "æœ¬å½“ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
            onConfirm: async () => await DeleteAsync(id),
            onCancel: async () => await Task.CompletedTask);
    }

    private async Task DeleteAsync(Guid id)
    {
        // å‰Šé™¤å‡¦ç†
        await Store.DeleteAsync(id);
        await NotificationStore.ShowSuccessAsync("å‰Šé™¤å®Œäº†", "ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
    }
}
```

#### é«˜åº¦ãªãƒ¢ãƒ¼ãƒ€ãƒ«

```razor
@code {
    private async Task ShowCustomModal()
    {
        await NotificationStore.ShowModalAsync(
            title: "ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«",
            message: "è©³ç´°ãªç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
            type: NotificationType.Warning,
            modalType: ModalType.Confirm,
            confirmButtonText: "å®Ÿè¡Œ",
            cancelButtonText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
            onConfirm: async () =>
            {
                // ç¢ºèªæ™‚ã®å‡¦ç†
                await ExecuteAsync();
            },
            onCancel: async () =>
            {
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
                await NotificationStore.ShowInfoAsync("ã‚­ãƒ£ãƒ³ã‚»ãƒ«", "å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ");
            });
    }
}
```

#### ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«é…ç½®ï¼‰

```razor
@* MainLayout.razor *@
@inject NotificationStore NotificationStore

<div class="main-layout">
    <!-- æ—¢å­˜ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    @Body

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºé ˜åŸŸ -->
    <div class="toast-container">
        @foreach (var toast in NotificationStore.GetState().Toasts)
        {
            <div class="toast toast-@toast.Type.ToString().ToLower()">
                <div class="toast-header">
                    <strong>@toast.Title</strong>
                    <button @onclick="() => DismissToast(toast.Id)">Ã—</button>
                </div>
                <div class="toast-body">
                    @toast.Message
                </div>
            </div>
        }
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º -->
    @if (NotificationStore.GetState().CurrentModal is { } modal)
    {
        <div class="modal-backdrop">
            <div class="modal modal-@modal.Type.ToString().ToLower()">
                <div class="modal-header">
                    <h3>@modal.Title</h3>
                </div>
                <div class="modal-body">
                    <p>@modal.Message</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" @onclick="ConfirmModal">
                        @modal.ConfirmButtonText
                    </button>
                    @if (modal.CancelButtonText != null)
                    {
                        <button class="btn btn-secondary" @onclick="CancelModal">
                            @modal.CancelButtonText
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    protected override void OnInitialized()
    {
        NotificationStore.OnChangeAsync += StateHasChanged;
    }

    private async Task DismissToast(Guid toastId)
    {
        await NotificationStore.DismissToastAsync(toastId);
    }

    private async Task ConfirmModal()
    {
        await NotificationStore.ConfirmModalAsync();
    }

    private async Task CancelModal()
    {
        await NotificationStore.CancelModalAsync();
    }
}
```

---

## ğŸ¨ ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰çŠ¶æ…‹ç®¡ç†ï¼ˆFeaturesï¼‰

### Store + PageActions ãƒ‘ã‚¿ãƒ¼ãƒ³

ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®çŠ¶æ…‹ç®¡ç†ã¯ã€**Store**ï¼ˆçŠ¶æ…‹ç®¡ç†+I/Oï¼‰ã¨**PageActions**ï¼ˆUIæ‰‹é †ï¼‰ã«åˆ†é›¢ã—ã¾ã™ã€‚

#### ProductsStoreã®ä¾‹

```csharp
/// <summary>
/// å•†å“ä¸€è¦§ã®çŠ¶æ…‹ç®¡ç†ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ï¼‰
/// </summary>
public sealed class ProductsStore : IDisposable
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly SemaphoreSlim _gate = new(1, 1);
    private ProductsState _state = ProductsState.Empty;

    public event Func<Task>? OnChangeAsync;

    public ProductsState GetState() => _state;

    public async Task LoadAsync(CancellationToken ct = default)
    {
        await _gate.WaitAsync(ct);
        try
        {
            SetState(_state with { IsLoading = true });

            using var scope = _scopeFactory.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();

            var result = await mediator.Send(new GetProductsQuery(), ct);

            if (result.IsSuccess)
            {
                SetState(_state with
                {
                    IsLoading = false,
                    Products = result.Value.ToImmutableList()
                });
            }
        }
        finally
        {
            _gate.Release();
        }
    }

    private void SetState(ProductsState newState)
    {
        _state = newState;
        OnChangeAsync?.Invoke();
    }

    public void Dispose() => _gate.Dispose();
}
```

#### ProductListActionsã®ä¾‹

```csharp
/// <summary>
/// å•†å“ä¸€è¦§ç”»é¢ã®UIæ‰‹é †ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ï¼‰
/// </summary>
public sealed class ProductListActions
{
    private readonly ProductsStore _store;
    private readonly NotificationStore _notification;
    private readonly NavigationManager _navigation;

    public async Task LoadAsync()
    {
        await _store.LoadAsync();
    }

    public async Task DeleteAsync(Guid productId)
    {
        await _notification.ShowConfirmAsync(
            "å‰Šé™¤ç¢ºèª",
            "ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
            onConfirm: async () =>
            {
                var success = await _store.DeleteAsync(productId);
                if (success)
                {
                    await _notification.ShowSuccessAsync("å‰Šé™¤å®Œäº†", "å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
                }
            });
    }

    public void EditAsync(Guid productId)
    {
        _navigation.NavigateTo($"/products/{productId}/edit");
    }
}
```

---

## ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®é€£æº

### å®Ÿè·µä¾‹ï¼šå•†å“ä¸€è¦§ç”»é¢

```razor
@page "/products"
@inject ProductsStore Store
@inject ProductListActions Actions
@inject NotificationStore NotificationStore
@implements IDisposable

@code {
    [CascadingParameter]
    private SessionProvider SessionProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰Storeè³¼èª­
        Store.OnChangeAsync += StateHasChanged;

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«Storeè³¼èª­
        NotificationStore.OnChangeAsync += StateHasChanged;

        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
        await Actions.LoadAsync();
    }

    private bool CanDelete => SessionProvider.State.IsInRole("Admin");

    public void Dispose()
    {
        Store.OnChangeAsync -= StateHasChanged;
        NotificationStore.OnChangeAsync -= StateHasChanged;
    }
}
```

```razor
<div class="product-list">
    <h1>å•†å“ä¸€è¦§</h1>

    @* ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«: ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹è¡¨ç¤º *@
    @if (CanDelete)
    {
        <button class="btn btn-danger" @onclick="DeleteAllAsync">
            ä¸€æ‹¬å‰Šé™¤ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
        </button>
    }

    @* ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰: å•†å“ãƒªã‚¹ãƒˆ *@
    @if (Store.GetState().IsLoading)
    {
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    }
    else
    {
        @foreach (var product in Store.GetState().Products)
        {
            <ProductCard
                Product="@product"
                OnEdit="Actions.EditAsync"
                OnDelete="@(CanDelete ? Actions.DeleteAsync : null)" />
        }
    }
</div>

@code {
    private async Task DeleteAllAsync()
    {
        await Actions.DeleteBatchAsync(
            Store.GetState().Products.Select(p => p.Id));
    }
}
```

---

## ğŸ“‹ ä½¿ã„åˆ†ã‘ã‚¬ã‚¤ãƒ‰

### ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«çŠ¶æ…‹ç®¡ç†ã‚’ä½¿ã†ã¹ãå ´åˆ

âœ… ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å…±é€šã®æ©Ÿèƒ½
âœ… èªè¨¼ãƒ»èªå¯ã€ãƒ†ãƒ¼ãƒã€è¨€èªè¨­å®š
âœ… UIå…¨ä½“ã«å½±éŸ¿ã™ã‚‹çŠ¶æ…‹
âœ… LocalStorageã«æ°¸ç¶šåŒ–ã—ãŸã„è¨­å®š

**ä¾‹:**
- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª
- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
- è¨€èªåˆ‡ã‚Šæ›¿ãˆ
- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰
- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥

### ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰çŠ¶æ…‹ç®¡ç†ã‚’ä½¿ã†ã¹ãå ´åˆ

âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å›ºæœ‰ã®æ©Ÿèƒ½
âœ… ç”»é¢å›ºæœ‰ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
âœ… CRUDæ“ä½œ
âœ… æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**ä¾‹:**
- å•†å“ä¸€è¦§ã®è¡¨ç¤º
- æ³¨æ–‡å‡¦ç†
- åœ¨åº«ç®¡ç†
- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

---

## ğŸ“ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. çŠ¶æ…‹ã®è³¼èª­ã¨è§£é™¤

```csharp
// âœ… GOOD
protected override void OnInitialized()
{
    Store.OnChangeAsync += StateHasChanged;
}

public void Dispose()
{
    Store.OnChangeAsync -= StateHasChanged;  // å¿…ãšè§£é™¤
}

// âŒ BAD: Disposeã—ãªã„ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ï¼‰
protected override void OnInitialized()
{
    Store.OnChangeAsync += StateHasChanged;
}
```

### 2. ä¸¦è¡Œåˆ¶å¾¡ã®æ´»ç”¨

```csharp
// âœ… GOOD: Storeã§ä¸¦è¡Œåˆ¶å¾¡
public async Task LoadAsync()
{
    await _gate.WaitAsync();
    try
    {
        // I/Oå‡¦ç†
    }
    finally
    {
        _gate.Release();
    }
}
```

### 3. ä¸å¤‰çŠ¶æ…‹ã®æ›´æ–°

```csharp
// âœ… GOOD: recordã®withå¼
SetState(_state with { IsLoading = true });

// âŒ BAD: å¯å¤‰çŠ¶æ…‹
_state.IsLoading = true;  // recordã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
```

### 4. LocalStorageã®ä½¿ç”¨

```csharp
// âœ… GOOD: LocalStorageServiceã‚’ä½¿ç”¨
await _localStorage.SetItemAsync("preferences", state);

// âŒ BAD: JSInteropã‚’ç›´æ¥ä½¿ç”¨
await _jsRuntime.InvokeVoidAsync("localStorage.setItem", ...);
```

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [09_UIå±¤ã®è©³ç´°è¨­è¨ˆ](09_UIå±¤ã®è©³ç´°è¨­è¨ˆ.md) - Store, PageActions, Componentã®è©³ç´°
- [STATE-MANAGEMENT-LAYERS.md](../architecture/STATE-MANAGEMENT-LAYERS.md) - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“ã®èª¬æ˜
- [Infrastructure/README.md](../../src/ProductCatalog.Web/Infrastructure/README.md) - å®Ÿè£…ã®è©³ç´°

---

**ä½œæˆæ—¥**: 2025-11-02
**å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: ProductCatalog
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… Phase 1 å®Ÿè£…å®Œäº†
