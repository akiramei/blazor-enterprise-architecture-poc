# 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

[â† ç›®æ¬¡ã«æˆ»ã‚‹](00_README.md)

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### 2.1 è¨­è¨ˆåŸå‰‡

#### **1. é–¢å¿ƒäº‹ã®åˆ†é›¢ (Separation of Concerns)**

```
UIå±¤       â†’ è¡¨ç¤ºã¨æ‰‹é †ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
Applicationå±¤ â†’ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè¡Œ
Domainå±¤    â†’ ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«
Infrastructureå±¤ â†’ æŠ€è¡“çš„è©³ç´°(DBã€å¤–éƒ¨APIç­‰)
```

#### **2. ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ (DIP)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Layer (Blazor Components)               â”‚
â”‚    â†“ ä¾å­˜                                   â”‚
â”‚  Application Layer (UseCases/Handlers)      â”‚
â”‚    â†“ ä¾å­˜                                   â”‚
â”‚  Domain Layer (Business Rules) â†â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â†‘ å®Ÿè£…                               â”‚   â”‚
â”‚  Infrastructure Layer (Repositories) â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¾å­˜ã®æ–¹å‘:UI â†’ Application â†’ Domain â† Infrastructure
```

#### **3. ä¸å¤‰æ€§ (Immutability)**

```csharp
// âœ… ä¸å¤‰State(recordã§å®šç¾©)
public record ProductsState
{
    public ImmutableList<ProductDto> Products { get; init; } = ImmutableList<ProductDto>.Empty;
    public bool IsLoading { get; init; }
    public string? ErrorMessage { get; init; }
}

// âœ… çŠ¶æ…‹æ›´æ–°ã¯å¸¸ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
SetState(_state with { IsLoading = true });
```

#### **4. æ˜ç¤ºçš„ãªå‰¯ä½œç”¨ (Explicit Side Effects)**

```csharp
// âœ… å‰¯ä½œç”¨ã®å ´æ‰€ãŒæ˜ç¢º
PageActions â†’ Store â†’ Mediator â†’ Handler â†’ Repository

// âŒ å‰¯ä½œç”¨ãŒæ•£åœ¨
Componentå†…ã§DBç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã€APIå‘¼ã³å‡ºã—ã€ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç­‰ãŒæ··åœ¨
```

### 2.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¹ã‚¿ã‚¤ãƒ«

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ä»¥ä¸‹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã¦ã„ã¾ã™:

#### **ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ã‚¿ãƒ­ã‚°å‹Clean Architecture**

**ğŸ¯ ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç‰¹å¾´:**

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**AIé§†å‹•é–‹ç™ºã®ãŸã‚ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ã‚¿ãƒ­ã‚°**ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
å¾“æ¥ã®ã€Œå±¤åˆ†é›¢ã€ã¨ã€Œæ©Ÿèƒ½å‡é›†ã€ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã€AIãŒå‚ç…§ã—ã‚„ã™ã„ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

**ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ:**

```
src/
â”œâ”€â”€ ProductCatalog.Web/                    # UIå±¤
â”‚   â””â”€â”€ Features/
â”‚       â””â”€â”€ Products/                      # æ©Ÿèƒ½åˆ¥ã«æ•´ç†
â”‚           â”œâ”€â”€ Pages/
â”‚           â”œâ”€â”€ Actions/
â”‚           â”œâ”€â”€ Store/
â”‚           â””â”€â”€ Components/
â”‚
â”œâ”€â”€ ProductCatalog.Application/            # Applicationå±¤
â”‚   â””â”€â”€ Features/
â”‚       â””â”€â”€ Products/                      # æ©Ÿèƒ½åˆ¥ã«æ•´ç†
â”‚           â”œâ”€â”€ CreateProduct/             # â† ãƒ‘ã‚¿ãƒ¼ãƒ³å˜ä½ã§å‡é›†
â”‚           â”‚   â”œâ”€â”€ CreateProductCommand.cs
â”‚           â”‚   â”œâ”€â”€ CreateProductHandler.cs
â”‚           â”‚   â””â”€â”€ CreateProductValidator.cs
â”‚           â”œâ”€â”€ UpdateProduct/             # â† ãƒ‘ã‚¿ãƒ¼ãƒ³å˜ä½ã§å‡é›†
â”‚           â”‚   â”œâ”€â”€ UpdateProductCommand.cs
â”‚           â”‚   â”œâ”€â”€ UpdateProductHandler.cs
â”‚           â”‚   â””â”€â”€ UpdateProductValidator.cs
â”‚           â”œâ”€â”€ DeleteProduct/
â”‚           â”œâ”€â”€ GetProducts/
â”‚           â”œâ”€â”€ GetProductById/
â”‚           â”œâ”€â”€ SearchProducts/
â”‚           â””â”€â”€ BulkDeleteProducts/
â”‚
â”œâ”€â”€ ProductCatalog.Domain/                 # Domainå±¤
â”‚   â”œâ”€â”€ Common/
â”‚   â”‚   â”œâ”€â”€ AggregateRoot.cs              # é›†ç´„ãƒ«ãƒ¼ãƒˆåŸºåº•ã‚¯ãƒ©ã‚¹
â”‚   â”‚   â”œâ”€â”€ Entity.cs
â”‚   â”‚   â””â”€â”€ ValueObject.cs
â”‚   â””â”€â”€ Products/
â”‚       â”œâ”€â”€ Product.cs                     # é›†ç´„ãƒ«ãƒ¼ãƒˆ
â”‚       â”œâ”€â”€ ProductImage.cs                # å­ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚       â”œâ”€â”€ ProductId.cs
â”‚       â”œâ”€â”€ Money.cs
â”‚       â””â”€â”€ ProductStatus.cs
â”‚
â””â”€â”€ ProductCatalog.Infrastructure/         # Infrastructureå±¤
    â”œâ”€â”€ Persistence/
    â”‚   â”œâ”€â”€ Repositories/
    â”‚   â””â”€â”€ Configurations/
    â”œâ”€â”€ Behaviors/                         # æ¨ªæ–­çš„é–¢å¿ƒäº‹
    â””â”€â”€ Outbox/
```

**ãªãœã“ã®æ§‹æˆãªã®ã‹ï¼Ÿï¼ˆAIè¦–ç‚¹ï¼‰**

âœ… **ãƒ‘ã‚¿ãƒ¼ãƒ³å˜ä½ã§å®Œçµ**
- ã€Œæ›´æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã„ã€â†’ `UpdateProduct/` ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¦‹ã‚‹ã ã‘
- Command/Handler/ValidatorãŒ1ç®‡æ‰€ã«é›†ç´„
- æ©Ÿèƒ½ã®è¿½åŠ ãƒ»å‰Šé™¤ãŒå®¹æ˜“

âœ… **å±¤åˆ†é›¢ã¯ç¶­æŒ**
- Clean Architectureã®ä¾å­˜æ–¹å‘ã¯å³å®ˆ
- DIPï¼ˆä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ï¼‰ã‚’é©ç”¨
- ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿

âœ… **AIãŒå‚ç…§ã—ã‚„ã™ã„**
- åŒç¨®ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå…¨ã¦ã®Commandã€å…¨ã¦ã®Queryï¼‰ã‚’æ¯”è¼ƒã—ã‚„ã™ã„
- CQRSã®åŒºåˆ¥ãŒæ˜ç¢º
- å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç™ºè¦‹æ€§ãŒé«˜ã„

**å¾“æ¥ã®VSAï¼ˆå…¨å±¤ã‚’1ãƒ•ã‚©ãƒ«ãƒ€ã«é›†ç´„ï¼‰ã¨ã®é•ã„:**

| è¦³ç‚¹ | å¾“æ¥ã®VSA | ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ |
|-----|----------|----------------|
| å±¤åˆ†é›¢ | æ©Ÿèƒ½ã”ã¨ã«å…¨å±¤ã‚’å«ã‚€ | å±¤ã¯åˆ†é›¢ã€å±¤å†…ã§æ©Ÿèƒ½åˆ¥æ•´ç† |
| ä¾å­˜æ–¹å‘ | æ©Ÿèƒ½å†…ã§å®Œçµ | Clean Architectureã®ä¾å­˜æ–¹å‘ |
| AIå‚ç…§ | æ©Ÿèƒ½å…¨ä½“ã‚’è¦‹ã‚‹ | ãƒ‘ã‚¿ãƒ¼ãƒ³å˜ä½ã§è¦‹ã‚‹ |
| é©ç”¨å ´é¢ | æ©Ÿèƒ½é–“ã®çµåˆãŒå¼±ã„å ´åˆ | ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’ãƒ»å†åˆ©ç”¨ |

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ğŸ“š **ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ã‚¿ãƒ­ã‚°ã¨ã—ã¦æœ€é©** - AIãŒåŒç¨®ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¯”è¼ƒå­¦ç¿’ã—ã‚„ã™ã„
- ğŸ” **é«˜ã„ç™ºè¦‹æ€§** - ã€Œæ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã„ã€â†’ `SearchProducts/` ã‚’å‚ç…§
- ğŸ—ï¸ **æ‹¡å¼µæ€§** - æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚©ãƒ«ãƒ€å˜ä½ã§è¿½åŠ 
- ğŸ§ª **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£** - å±¤åˆ†é›¢ã«ã‚ˆã‚Šå˜ä½“ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“
- ğŸ“– **æ˜ç¢ºãªè²¬å‹™** - CQRS ã«ã‚ˆã‚Šèª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿ãŒæ˜ç¢º

#### **CQRS (Command Query Responsibility Segregation)**

```csharp
// Query: èª­ã¿å–ã‚Šå°‚ç”¨ã€æœ€é©åŒ–ã•ã‚ŒãŸå–å¾—
public record GetProductsQuery : IQuery<Result<IEnumerable<ProductDto>>>;

// Command: æ›¸ãè¾¼ã¿ã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«é©ç”¨
public record DeleteProductCommand(Guid Id) : ICommand<Result>;
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’ç‹¬ç«‹ã—ã¦æœ€é©åŒ–
- è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®é©ç”¨ãŒå®¹æ˜“

#### **Event-Driven Architecture (EDA)**

```csharp
// ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
public record ProductDeletedEvent(Guid ProductId, DateTime DeletedAt);

// çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆ(OutboxçµŒç”±ã§é…ä¿¡)
public record ProductDeletedIntegrationEvent(
    string EventId,
    Guid ProductId,
    DateTime DeletedAt
);

// SignalRã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
await _hubContext.Clients.All.SendAsync("ProductDeleted", productId);
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ç–çµåˆãªæ©Ÿèƒ½é–“é€£æº
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ UIæ›´æ–°
- å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆãŒå®¹æ˜“

---
