# 6. 具体例: 商品管理機能

[← 目次に戻る](00_README.md)

---

## 6. 具体例: 商品管理機能

### 6.1 ユースケース概要

**機能**: 商品一覧画面での削除処理

**要件**:
- 管理者のみが削除可能
- 在庫がある商品は削除不可
- 削除時に確認ダイアログを表示
- 削除成功時にトースト通知
- 他のユーザーの画面もリアルタイムで更新
- 二重クリック防止

### 6.2 処理フロー(削除ボタンクリック時)

```mermaid
sequenceDiagram
    actor User
    participant Dumb as ProductCard<br/>(Dumb)
    participant Smart as ProductList<br/>(Smart)
    participant Actions as ProductListActions
    participant Store as ProductsStore
    participant Mediator as IMediator
    participant Pipeline as Behaviors
    participant Handler as DeleteProductHandler
    participant Domain as Product
    participant Repo as IProductRepository
    participant DB as Database
    participant Hub as SignalR Hub

    User->>Dumb: クリック削除ボタン
    Dumb->>Smart: OnDelete.InvokeAsync(id)
    Smart->>Actions: DeleteAsync(id)
    
    Actions->>Actions: 確認ダイアログ表示
    alt ユーザーがキャンセル
        Actions-->>Smart: return
    end
    
    Actions->>Store: DeleteAsync(id)
    Store->>Store: SetState(IsLoading=true)
    Store->>Store: CreateScope()
    Store->>Mediator: Send(DeleteProductCommand)
    
    Mediator->>Pipeline: LoggingBehavior
    Pipeline->>Pipeline: ValidationBehavior
    Pipeline->>Pipeline: AuthorizationBehavior
    Pipeline->>Pipeline: IdempotencyBehavior
    Pipeline->>Pipeline: TransactionBehavior (Begin)
    
    Pipeline->>Handler: Handle(command)
    Handler->>Repo: GetAsync(productId)
    Repo->>DB: SELECT
    DB-->>Repo: Product
    Repo-->>Handler: Product
    
    Handler->>Domain: product.Delete()
    Domain->>Domain: ビジネスルール検証
    Domain->>Domain: RaiseDomainEvent()
    
    Handler->>Repo: SaveAsync(product)
    Repo->>DB: UPDATE + INSERT Outbox
    DB-->>Repo: OK
    
    Pipeline->>Pipeline: TransactionBehavior (Commit)
    Pipeline-->>Store: Result.Success()
    
    Store->>Store: LoadAsync() (再読み込み)
    Store->>Store: SetState(IsLoading=false)
    Store->>Store: OnChangeAsync.Invoke()
    
    Store->>Smart: (event notification)
    Smart->>Smart: StateHasChanged()
    Smart-->>User: 画面更新
    
    Actions->>Actions: トースト表示
    
    Note over DB,Hub: 非同期イベント配信
    DB->>Hub: Outbox Dispatcher
    Hub->>User: SignalR通知(他のクライアント)
```

### 6.3 関連クラス図

```
┌─────────────────────────────────────────────────────────────┐
│  UI Layer (Blazor Components)                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐         ┌──────────────────────┐     │
│  │ ProductCard      │         │ ProductList          │     │
│  │ (Dumb)           │───────▶ │ (Smart)              │     │
│  ├──────────────────┤         ├──────────────────────┤     │
│  │ + Product        │         │ - Store: ProductsStore│    │
│  │ + OnDelete       │         │ - Actions: Actions   │     │
│  └──────────────────┘         └────────┬─────────────┘     │
│                                         │                   │
│                          ┌──────────────▼───────────────┐   │
│                          │ ProductListActions           │   │
│                          ├──────────────────────────────┤   │
│                          │ - _store: ProductsStore      │   │
│                          │ - _confirm: IConfirmDialog   │   │
│                          │ - _toast: IToast             │   │
│                          ├──────────────────────────────┤   │
│                          │ + LoadAsync()                │   │
│                          │ + DeleteAsync(id)            │   │
│                          └──────────┬───────────────────┘   │
│                                     │                       │
│                          ┌──────────▼───────────────┐       │
│                          │ ProductsStore            │       │
│                          ├──────────────────────────┤       │
│                          │ - _state: ProductsState  │       │
│                          │ - _scopeFactory          │       │
│                          ├──────────────────────────┤       │
│                          │ + GetState()             │       │
│                          │ + LoadAsync()            │       │
│                          │ + DeleteAsync(id)        │       │
│                          │ + OnChangeAsync: event   │       │
│                          └──────────┬───────────────┘       │
│                                     │                       │
│                          ┌──────────▼───────────────┐       │
│                          │ ProductsState (record)   │       │
│                          ├──────────────────────────┤       │
│                          │ + Products: ImmutableList│       │
│                          │ + IsLoading: bool        │       │
│                          │ + ErrorMessage: string?  │       │
│                          └──────────────────────────┘       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Application Layer                                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │ DeleteProductCommand (record)                │          │
│  ├──────────────────────────────────────────────┤          │
│  │ + ProductId: Guid                            │          │
│  │ + IdempotencyKey: string                     │          │
│  └────────────────┬─────────────────────────────┘          │
│                   │ implements ICommand<Result>            │
│                   │                                        │
│  ┌────────────────▼─────────────────────────────┐          │
│  │ DeleteProductHandler                         │          │
│  ├──────────────────────────────────────────────┤          │
│  │ - _repository: IProductRepository            │          │
│  ├──────────────────────────────────────────────┤          │
│  │ + Handle(command, ct): Task<Result>          │          │
│  └────────────────┬─────────────────────────────┘          │
│                   │                                        │
│  ┌────────────────▼─────────────────────────────┐          │
│  │ IPipelineBehavior<TRequest, TResponse>       │          │
│  ├──────────────────────────────────────────────┤          │
│  │ - LoggingBehavior                            │          │
│  │ - ValidationBehavior                         │          │
│  │ - AuthorizationBehavior                      │          │
│  │ - IdempotencyBehavior                        │          │
│  │ - TransactionBehavior                        │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Domain Layer                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │ Product (Aggregate Root)                     │          │
│  ├──────────────────────────────────────────────┤          │
│  │ - _id: ProductId                             │          │
│  │ - _name: string                              │          │
│  │ - _price: Money                              │          │
│  │ - _stock: int                                │          │
│  │ - _domainEvents: List<DomainEvent>           │          │
│  ├──────────────────────────────────────────────┤          │
│  │ + Delete(): void                             │          │
│  │ + ChangeName(name): void                     │          │
│  │ - RaiseDomainEvent(event): void              │          │
│  └──────────────────────────────────────────────┘          │
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │ IProductRepository                           │          │
│  ├──────────────────────────────────────────────┤          │
│  │ + GetAsync(id, ct): Task<Product?>           │          │
│  │ + SaveAsync(product, ct): Task               │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  Infrastructure Layer                                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │ EfProductRepository                          │          │
│  ├──────────────────────────────────────────────┤          │
│  │ - _context: AppDbContext                     │          │
│  ├──────────────────────────────────────────────┤          │
│  │ + GetAsync(id, ct): Task<Product?>           │          │
│  │ + SaveAsync(product, ct): Task               │          │
│  └──────────────────────────────────────────────┘          │
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │ AppDbContext                                 │          │
│  ├──────────────────────────────────────────────┤          │
│  │ + Products: DbSet<Product>                   │          │
│  │ + OutboxMessages: DbSet<OutboxMessage>       │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

---
