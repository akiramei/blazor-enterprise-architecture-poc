# 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

[â† ç›®æ¬¡ã«æˆ»ã‚‹](00_README.md)

---

## 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### 3.1 è¨­è¨ˆåŸå‰‡

#### **1. æ©Ÿèƒ½ã«ã‚ˆã‚‹å‚ç›´åˆ†å‰² (Vertical Slicing)**

```
æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹ â†’ æ©Ÿèƒ½ã”ã¨ã«å…¨å±¤ã‚’åŒ…å«
  â”œâ”€ UIå±¤       â†’ è¡¨ç¤ºã¨æ‰‹é †ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  â”œâ”€ Applicationå±¤ â†’ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè¡Œ
  â”œâ”€ Domainå±¤    â†’ ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«
  â””â”€ Infrastructureå±¤ â†’ æŠ€è¡“çš„è©³ç´°(DBã€å¤–éƒ¨APIç­‰)
```

#### **2. æ©Ÿèƒ½å†…ã§ã®ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ (DIP)**

```
æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹ (ä¾‹: CreateProduct)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Layer (Blazor Components)               â”‚
â”‚    â†“ ä¾å­˜                                   â”‚
â”‚  Application Layer (UseCases/Handlers)      â”‚
â”‚    â†“ ä¾å­˜                                   â”‚
â”‚  Domain Layer (Business Rules) â†â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â†‘ å®Ÿè£…                               â”‚   â”‚
â”‚  Infrastructure Layer (Repositories) â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¾å­˜ã®æ–¹å‘:UI â†’ Application â†’ Domain â† Infrastructure
æ©Ÿèƒ½é–“ã®ä¾å­˜: âŒ ç¦æ­¢ (Sharedãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å…±æœ‰)
```

#### **3. ä¸å¤‰æ€§ (Immutability)**

```csharp
// âœ… ä¸å¤‰State(recordã§å®šç¾©)
public record ProductsState
{
    public ImmutableList<ProductDto> Products { get; init; } = ImmutableList<ProductDto>.Empty;
    public bool IsLoading { get; init; }
    public string? ErrorMessage { get; init; }
}

// âœ… çŠ¶æ…‹æ›´æ–°ã¯å¸¸ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
SetState(_state with { IsLoading = true });
```

#### **4. æ˜ç¤ºçš„ãªå‰¯ä½œç”¨ (Explicit Side Effects)**

```csharp
// âœ… å‰¯ä½œç”¨ã®å ´æ‰€ãŒæ˜ç¢º
PageActions â†’ Store â†’ Mediator â†’ Handler â†’ Repository

// âŒ å‰¯ä½œç”¨ãŒæ•£åœ¨
Componentå†…ã§DBç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã€APIå‘¼ã³å‡ºã—ã€ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç­‰ãŒæ··åœ¨
```

### 3.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¹ã‚¿ã‚¤ãƒ«

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯**Vertical Slice Architecture (VSA)** ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

#### **Vertical Slice Architecture (VSA)**

**ğŸ¯ ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç‰¹å¾´:**

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**æ©Ÿèƒ½(Feature)ã‚’æœ€ä¸Šä½ã¨ã—ãŸå‚ç›´ã‚¹ãƒ©ã‚¤ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
å¾“æ¥ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã¯ç•°ãªã‚Šã€**æ©Ÿèƒ½ã”ã¨ã«å…¨å±¤ã‚’åŒ…å«**ã—ã€æ©Ÿèƒ½è¿½åŠ æ™‚ã®å¤‰æ›´ç¯„å›²ã‚’æœ€å°åŒ–ã—ã¾ã™ã€‚

**ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆï¼ˆã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å®Ÿè£… - å…±é€šãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰:**

```
src/
â””â”€â”€ ProductCatalog/                        # Bounded Context
    â”œâ”€â”€ Features/
    â”‚   â”œâ”€â”€ CreateProduct/                 # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹1
    â”‚   â”‚   â”œâ”€â”€ Application/
    â”‚   â”‚   â”‚   â”œâ”€â”€ CreateProductCommand.cs
    â”‚   â”‚   â”‚   â”œâ”€â”€ CreateProductHandler.cs
    â”‚   â”‚   â”‚   â””â”€â”€ CreateProductValidator.cs
    â”‚   â”‚   â””â”€â”€ UI/
    â”‚   â”‚       â””â”€â”€ Api/
    â”‚   â”‚           â”œâ”€â”€ CreateProductEndpoint.cs
    â”‚   â”‚           â””â”€â”€ Dtos/
    â”‚   â”‚
    â”‚   â”œâ”€â”€ GetProducts/                   # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹2
    â”‚   â”‚   â”œâ”€â”€ Application/
    â”‚   â”‚   â”‚   â”œâ”€â”€ GetProductsQuery.cs
    â”‚   â”‚   â”‚   â””â”€â”€ GetProductsHandler.cs
    â”‚   â”‚   â””â”€â”€ UI/
    â”‚   â”‚       â”œâ”€â”€ Api/
    â”‚   â”‚       â””â”€â”€ Components/
    â”‚   â”‚
    â”‚   â”œâ”€â”€ UpdateProduct/                 # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹3
    â”‚   â”‚   â”œâ”€â”€ Application/
    â”‚   â”‚   â””â”€â”€ UI/
    â”‚   â”‚
    â”‚   â”œâ”€â”€ DeleteProduct/                 # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹4
    â”‚   â”œâ”€â”€ GetProductById/                # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹5
    â”‚   â”œâ”€â”€ SearchProducts/                # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹6
    â”‚   â”œâ”€â”€ BulkDeleteProducts/            # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹7
    â”‚   â”œâ”€â”€ BulkUpdateProductPrices/       # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹8
    â”‚   â”œâ”€â”€ ExportProductsToCsv/           # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹9
    â”‚   â””â”€â”€ ImportProductsFromCsv/         # æ©Ÿèƒ½ã‚¹ãƒ©ã‚¤ã‚¹10
    â”‚
    â””â”€â”€ Shared/                            # ProductCatalogå…±é€šã‚³ãƒ¼ãƒ‰
        â”œâ”€â”€ Application/
        â”‚   â””â”€â”€ DTOs/                      # å…±é€šDTO
        â”œâ”€â”€ Domain/
        â”‚   â””â”€â”€ Products/                  # Producté›†ç´„ï¼ˆå…¨æ©Ÿèƒ½ã§å…±æœ‰ï¼‰
        â”‚       â”œâ”€â”€ Product.cs
        â”‚       â”œâ”€â”€ Money.cs
        â”‚       â””â”€â”€ Events/
        â”œâ”€â”€ Infrastructure/
        â”‚   â””â”€â”€ Persistence/
        â”‚       â”œâ”€â”€ Configurations/        # EF Coreè¨­å®š
        â”‚       â””â”€â”€ Repositories/          # Repositoryå®Ÿè£…
        â””â”€â”€ UI/
            â”œâ”€â”€ Actions/                   # PageActions Pattern
            â””â”€â”€ Store/                     # Store Pattern
```

**é‡è¦:**
- **å„æ©Ÿèƒ½ï¼ˆCreateProduct, GetProductsç­‰ï¼‰ã¯Application + UIã®ã¿ã‚’æŒã¤**
- **Domain/Infrastructureã¯ProductCatalog/Sharedã«é›†ç´„**ï¼ˆå…¨æ©Ÿèƒ½ãŒåŒã˜Producté›†ç´„ã‚’ä½¿ã†ãŸã‚ï¼‰
- ã“ã‚Œã¯ã€Œå…±é€šãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã¨å‘¼ã°ã‚Œã‚‹VSAã®å®Ÿç”¨çš„ãªå¤‰å½¢ã§ã™

**ãªãœVSAãªã®ã‹ï¼Ÿ**

âœ… **æ©Ÿèƒ½å˜ä½ã§å®Œçµ**
- ã€Œæ›´æ–°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã„ã€â†’ `UpdateProduct/` ãƒ•ã‚©ãƒ«ãƒ€å†…ã§å®Œçµ
- Command/Handler/Validator/Repository/UIãŒ1ç®‡æ‰€ã«é›†ç´„
- æ©Ÿèƒ½ã®è¿½åŠ ãƒ»å‰Šé™¤æ™‚ã«ä»–ã®æ©Ÿèƒ½ã«å½±éŸ¿ã—ãªã„

âœ… **æ©Ÿèƒ½å†…ã§å±¤åˆ†é›¢ã‚’ç¶­æŒ**
- æ©Ÿèƒ½å†…ã§ã¯DIPï¼ˆä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ï¼‰ã‚’é©ç”¨
- ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿
- ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã§ä¿è­·

âœ… **å¤‰æ›´ã®å±€æ‰€åŒ–**
- æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã¯1ã¤ã®Featureãƒ•ã‚©ãƒ«ãƒ€ã®ã¿å¤‰æ›´
- ä»–ã®æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–
- ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒèµ·ãã«ãã„

**Clean Architectureï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ï¼‰ã¨ã®é•ã„:**

| è¦³ç‚¹ | Clean Architecture | VSA (ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ) |
|-----|-------------------|---------------------|
| æœ€ä¸Šä½ã®åˆ†å‰² | ãƒ¬ã‚¤ãƒ¤ãƒ¼(Application/Domain/Infrastructure/UI) | æ©Ÿèƒ½(Features/{FeatureName}) |
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå | ProductCatalog.Application | CreateProduct.Application |
| æ©Ÿèƒ½è¿½åŠ æ™‚ã®å¤‰æ›´ | è¤‡æ•°ã®å±¤ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´ | 1ã¤ã®æ©Ÿèƒ½ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã¿ |
| ä¾å­˜æ–¹å‘ | å±¤é–“ã®ä¾å­˜æ–¹å‘ã‚’å³å¯†ã«ç®¡ç† | æ©Ÿèƒ½å†…ã§ä¾å­˜æ–¹å‘ã‚’ç®¡ç†ã€æ©Ÿèƒ½é–“ã¯ç–çµåˆ |
| é©ç”¨å ´é¢ | å±¤ã®è²¬å‹™ã‚’å³å¯†ã«åˆ†é›¢ã—ãŸã„å ´åˆ | æ©Ÿèƒ½ã®ç‹¬ç«‹æ€§ã‚’é‡è¦–ã™ã‚‹å ´åˆ |

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ğŸ¯ **é«˜ã„å‡é›†åº¦** - é–¢é€£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒç‰©ç†çš„ã«è¿‘ã„ä½ç½®ã«ã‚ã‚‹
- ğŸ” **é«˜ã„ç™ºè¦‹æ€§** - ã€Œæ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ãŸã„ã€â†’ `SearchProducts/` ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¦‹ã‚‹ã ã‘
- ğŸ—ï¸ **æ‹¡å¼µæ€§** - æ–°ã—ã„æ©Ÿèƒ½ã‚’ãƒ•ã‚©ãƒ«ãƒ€å˜ä½ã§è¿½åŠ ãƒ»å‰Šé™¤å¯èƒ½
- ğŸ§ª **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£** - æ©Ÿèƒ½å˜ä½ã§ã®ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“
- ğŸš€ **ãƒãƒ¼ãƒ é–‹ç™º** - æ©Ÿèƒ½ã”ã¨ã«é–‹ç™ºè€…ã‚’å‰²ã‚Šå½“ã¦å¯èƒ½ã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæœ€å°åŒ–

#### **CQRS (Command Query Responsibility Segregation)**

```csharp
// Query: èª­ã¿å–ã‚Šå°‚ç”¨ã€æœ€é©åŒ–ã•ã‚ŒãŸå–å¾—
public record GetProductsQuery : IQuery<Result<IEnumerable<ProductDto>>>;

// Command: æ›¸ãè¾¼ã¿ã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«é©ç”¨
public record DeleteProductCommand(Guid Id) : ICommand<Result>;
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’ç‹¬ç«‹ã—ã¦æœ€é©åŒ–
- è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®é©ç”¨ãŒå®¹æ˜“

#### **Event-Driven Architecture (EDA)**

```csharp
// ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
public record ProductDeletedEvent(Guid ProductId, DateTime DeletedAt);

// çµ±åˆã‚¤ãƒ™ãƒ³ãƒˆ(OutboxçµŒç”±ã§é…ä¿¡)
public record ProductDeletedIntegrationEvent(
    string EventId,
    Guid ProductId,
    DateTime DeletedAt
);

// SignalRã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
await _hubContext.Clients.All.SendAsync("ProductDeleted", productId);
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ç–çµåˆãªæ©Ÿèƒ½é–“é€£æº
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ UIæ›´æ–°
- å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆãŒå®¹æ˜“

---

### 3.3 3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã®å¯¾å¿œè¡¨

**WPF/WinForms + RESTful Web API çµŒé¨“è€…å‘ã‘ã®ãƒãƒƒãƒ”ãƒ³ã‚°**

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€å¤å…¸çš„ãª3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ¦‚å¿µã‚’è¸è¥²ã—ã¤ã¤ã€ç¾ä»£çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§å†æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚

#### **å…¨ä½“å¯¾å¿œè¡¨**

| 3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | ä¸»ãªå¤‰æ›´ç‚¹ |
|----------------|-----------------|----------|
| **Presentation Layer** | **UI Layer (Blazor)** | WPF/WinForms â†’ Blazor Component |
| ViewModel | **Store + PageActions** | è²¬å‹™ã‚’åˆ†é›¢ï¼ˆçŠ¶æ…‹ç®¡ç† + æ‰‹é †ï¼‰ |
| View | Smart/Dumb Component | Container/Presentationalåˆ†é›¢ |
| **Business Logic Layer** | **Application Layer** | Service â†’ MediatR Handler |
| Serviceã‚¯ãƒ©ã‚¹ã®DI | MediatR + Pipeline Behaviors | æ¨ªæ–­çš„é–¢å¿ƒäº‹ã®çµ±ä¸€ |
| DTOãƒãƒƒãƒ”ãƒ³ã‚° | Command/Query | CQRSé©ç”¨ |
| **Data Access Layer** | **Infrastructure Layer** | ã»ã¼åŒã˜æ¦‚å¿µ |
| Repository | Repository | ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯Domainå±¤ã«é…ç½® |
| DbContext | DbContext | å¯¿å‘½ç®¡ç†ãŒå³å¯†åŒ– |

#### **è©³ç´°ãªå¯¾å¿œ: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤**

**3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆå¾“æ¥ï¼‰:**
```csharp
// Serviceã‚¯ãƒ©ã‚¹ã«å…¨ã¦ã‚’å®Ÿè£…
public class ProductService : IProductService
{
    private readonly IProductRepository _repository;
    private readonly ILogger _logger;
    private readonly IAuthorizationService _authz;

    public async Task<Result> DeleteProductAsync(Guid id)
    {
        // 1. ãƒ­ã‚°å‡ºåŠ›
        _logger.LogInformation("å•†å“å‰Šé™¤é–‹å§‹: {Id}", id);

        // 2. èªå¯ãƒã‚§ãƒƒã‚¯
        if (!await _authz.AuthorizeAsync("Product.Delete"))
            return Result.Fail("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");

        // 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
        using var transaction = await _dbContext.Database.BeginTransactionAsync();
        try {
            // 4. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
            var product = await _repository.GetAsync(id);
            await _repository.DeleteAsync(product);
            await _dbContext.SaveChangesAsync();
            await transaction.CommitAsync();
        }
        catch { await transaction.RollbackAsync(); throw; }

        // 5. ç›£æŸ»ãƒ­ã‚°
        await _auditLog.SaveAsync(new AuditEntry(...));

        return Result.Success();
    }
}
```

**ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:**
```csharp
// Handlerã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿
public class DeleteProductHandler : IRequestHandler<DeleteProductCommand, Result>
{
    private readonly IProductRepository _repository;

    public async Task<Result> Handle(DeleteProductCommand cmd, CancellationToken ct)
    {
        // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ï¼
        // ãƒ­ã‚°ã€èªå¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€ç›£æŸ»ãƒ­ã‚°ã¯è‡ªå‹•é©ç”¨
        var product = await _repository.GetAsync(new ProductId(cmd.ProductId), ct);
        if (product is null) return Result.Fail("å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

        product.Delete();  // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«
        await _repository.SaveAsync(product, ct);
        return Result.Success();
    }
}

// Pipeline Behaviorsï¼ˆDIç™»éŒ²ã§è‡ªå‹•é©ç”¨ï¼‰
builder.Services.AddTransient(typeof(IPipelineBehavior<,>), typeof(LoggingBehavior<,>));
builder.Services.AddTransient(typeof(IPipelineBehavior<,>), typeof(AuthorizationBehavior<,>));
builder.Services.AddTransient(typeof(IPipelineBehavior<,>), typeof(TransactionBehavior<,>));
builder.Services.AddTransient(typeof(IPipelineBehavior<,>), typeof(AuditLogBehavior<,>));
```

**é•ã„:**
- **3å±¤**: æ¨ªæ–­çš„é–¢å¿ƒäº‹ãŒå„Serviceã‚¯ãƒ©ã‚¹ã«æ•£åœ¨
- **ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: Pipeline Behaviorsã§ä¸€ç®‡æ‰€ã«é›†ç´„ã€è‡ªå‹•é©ç”¨

è©³ç´°ã¯ [10_Applicationå±¤ã®è©³ç´°è¨­è¨ˆ - 10.0 ãªãœMediatRãŒå¿…è¦ã‹ï¼Ÿ](10_Applicationå±¤ã®è©³ç´°è¨­è¨ˆ.md#100-ãªãœmediatrãŒå¿…è¦ã‹-serviceã‚¯ãƒ©ã‚¹ç›´æ¥diã¨ã®æ¯”è¼ƒ) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### **è©³ç´°ãªå¯¾å¿œ: UIå±¤**

**3å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆWPF/WinFormsï¼‰:**
```csharp
// ViewModelã«å…¨ã¦ã‚’å®Ÿè£…
public class ProductListViewModel : INotifyPropertyChanged
{
    private ObservableCollection<Product> _products = new();
    public ObservableCollection<Product> Products
    {
        get => _products;
        set { _products = value; OnPropertyChanged(); }
    }

    public ICommand DeleteCommand { get; }

    private async Task DeleteProductAsync(Guid id)
    {
        var result = MessageBox.Show("å‰Šé™¤ã—ã¾ã™ã‹?", "ç¢ºèª", MessageBoxButton.YesNo);
        if (result == MessageBoxResult.No) return;

        await _productService.DeleteAsync(id);
        Products.Remove(Products.First(p => p.Id == id));
    }
}
```

**ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:**
```csharp
// Store: çŠ¶æ…‹ç®¡ç†ã®ã¿
public class ProductsStore
{
    private ProductsState _state = new();  // ä¸å¤‰çŠ¶æ…‹
    public event Func<Task>? OnChangeAsync;

    public async Task<bool> DeleteAsync(Guid id, CancellationToken ct = default)
    {
        // I/Oå®Ÿè¡Œã¨çŠ¶æ…‹æ›´æ–°
        using var scope = _scopeFactory.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new DeleteProductCommand(id), ct);

        if (result.IsSuccess)
            await LoadAsync(ct);  // çŠ¶æ…‹å†å–å¾—

        return result.IsSuccess;
    }
}

// PageActions: UIæ‰‹é †ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
public class ProductListActions
{
    public async Task DeleteAsync(Guid id, CancellationToken ct = default)
    {
        // UIæ‰‹é †ã®åˆ¶å¾¡ã®ã¿
        if (!await _confirm.ShowAsync("å‰Šé™¤ã—ã¾ã™ã‹?")) return;

        var result = await _store.DeleteAsync(id, ct);

        if (result) _toast.Success("å‰Šé™¤ã—ã¾ã—ãŸ");
        else _toast.Error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
}
```

**é•ã„:**
- **3å±¤**: ViewModel ã«çŠ¶æ…‹ç®¡ç†ã¨UIæ‰‹é †ãŒæ··åœ¨
- **ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: Storeï¼ˆçŠ¶æ…‹ï¼‰ + PageActionsï¼ˆæ‰‹é †ï¼‰ã«åˆ†é›¢

è©³ç´°ã¯ [09_UIå±¤ã®è©³ç´°è¨­è¨ˆ - 9.0 WPF/WinFormsã¨ã®æ¯”è¼ƒ](09_UIå±¤ã®è©³ç´°è¨­è¨ˆ.md#90-wpfwinformsã¨ã®æ¯”è¼ƒ) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

### 3.4 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çŠ¶æ…‹ç®¡ç†ã¨ã®æ¦‚å¿µæ¯”è¼ƒ

**React/Vueç•Œéšˆã®çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®é–¢ä¿‚**

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®**Storeãƒ‘ã‚¿ãƒ¼ãƒ³**ã¯ã€React/Vueç•Œéšˆã§ã‚ˆãä½¿ã‚ã‚Œã‚‹ä»¥ä¸‹ã®çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨**ä¼¼ãŸæ¦‚å¿µ**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

#### **å‚è€ƒã«ã—ãŸæ¦‚å¿µ**

| ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | æ¦‚è¦ | ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã®å¯¾å¿œ |
|----------|------|------------------------|
| **Jotai** | Reactã®ã‚¢ãƒˆãƒŸãƒƒã‚¯çŠ¶æ…‹ç®¡ç† | Store ã®ä¸å¤‰çŠ¶æ…‹ç®¡ç† |
| **Redux** | å˜æ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ…‹ç®¡ç† | Store ã®å˜æ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ |
| **Zustand** | ã‚·ãƒ³ãƒ—ãƒ«ãªReactçŠ¶æ…‹ç®¡ç† | Store ã®è»½é‡å®Ÿè£… |
| **Recoil** | Facebookã®çŠ¶æ…‹ç®¡ç† | Store ã®ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹• |

**æ³¨æ„:** ã“ã‚Œã‚‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’**ç›´æ¥ä½¿ç”¨ã™ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚Blazorã«æœ€é©åŒ–ã—ãŸç‹¬è‡ªå®Ÿè£…ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

#### **å…±é€šã™ã‚‹è¨­è¨ˆæ¦‚å¿µ**

##### **1. ä¸å¤‰ï¼ˆImmutableï¼‰ãªçŠ¶æ…‹ç®¡ç†**

```csharp
// âœ… ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆStoreãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
public record ProductsState
{
    public ImmutableList<ProductDto> Products { get; init; } = ImmutableList<ProductDto>.Empty;
    public bool IsLoading { get; init; }
}

// çŠ¶æ…‹æ›´æ–°ã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
SetState(_state with { IsLoading = true });
```

```javascript
// å‚è€ƒ: Jotai (React)
const productsAtom = atom([]);
const isLoadingAtom = atom(false);

// çŠ¶æ…‹æ›´æ–°ã¯æ–°ã—ã„å€¤ã‚’ã‚»ãƒƒãƒˆ
setProducts([...products, newProduct]);
```

**å…±é€šç‚¹:**
- çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥å¤‰æ›´ã—ãªã„ï¼ˆImmutableï¼‰
- å¸¸ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¦å·®ã—æ›¿ãˆã‚‹
- äºˆæ¸¬å¯èƒ½ãªçŠ¶æ…‹é·ç§»

##### **2. å˜æ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**

```
[ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£]          [Redux/Jotai]
Action/Event                  Action
  â†“                            â†“
Store.UpdateState()          Reducer/Setter
  â†“                            â†“
Store.OnChangeAsync          Subscriber
  â†“                            â†“
Component.StateHasChanged()  Component Re-render
```

**å…±é€šç‚¹:**
- ãƒ‡ãƒ¼ã‚¿ã¯ä¸€æ–¹å‘ã«ã®ã¿æµã‚Œã‚‹
- çŠ¶æ…‹æ›´æ–°ãŒãƒˆãƒªã‚¬ãƒ¼ã¨ãªã£ã¦å†æç”»
- ãƒ‡ãƒãƒƒã‚°ãŒã—ã‚„ã™ã„

##### **3. ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã®å†æç”»**

```csharp
// âœ… ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
public class ProductsStore
{
    public event Func<Task>? OnChangeAsync;  // ã‚¤ãƒ™ãƒ³ãƒˆ

    private void SetState(ProductsState newState)
    {
        _state = newState;
        OnChangeAsync?.Invoke();  // è³¼èª­è€…ã«é€šçŸ¥
    }
}

// Component ã§ã®è³¼èª­
protected override void OnInitialized()
{
    Store.OnChangeAsync += () => InvokeAsync(StateHasChanged);
}
```

```javascript
// å‚è€ƒ: Zustand (React)
const useProductsStore = create((set) => ({
  products: [],
  setProducts: (products) => set({ products }),  // è‡ªå‹•ã§è³¼èª­è€…ã«é€šçŸ¥
}));

// Component ã§ã®ä½¿ç”¨
const products = useProductsStore((state) => state.products);  // è‡ªå‹•è³¼èª­
```

**å…±é€šç‚¹:**
- çŠ¶æ…‹å¤‰æ›´ã‚’è³¼èª­ï¼ˆSubscribeï¼‰ã™ã‚‹ä»•çµ„ã¿
- çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹ã¨è‡ªå‹•ã§é€šçŸ¥ã•ã‚Œã‚‹
- æ‰‹å‹•ã§ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã¯ä¸è¦

#### **WPF/WinFormsã®MVVMã¨ã®é•ã„**

| è¦³ç‚¹ | MVVM (WPF/WinForms) | Store Pattern (ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£) | Jotai/Redux (React) |
|------|-------------------|-------------------------------|-------------------|
| **çŠ¶æ…‹ã®å¯å¤‰æ€§** | å¯å¤‰ï¼ˆMutableï¼‰ | ä¸å¤‰ï¼ˆImmutableï¼‰ | ä¸å¤‰ï¼ˆImmutableï¼‰ |
| **å¤‰æ›´é€šçŸ¥** | INotifyPropertyChanged | OnChangeAsync ã‚¤ãƒ™ãƒ³ãƒˆ | Subscriberé€šçŸ¥ |
| **ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°** | åŒæ–¹å‘ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° | å˜æ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ | å˜æ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ |
| **çŠ¶æ…‹æ›´æ–°** | ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç›´æ¥å¤‰æ›´ | æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ | æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ |

**ä¾‹: å•†å“ãƒªã‚¹ãƒˆæ›´æ–°**

```csharp
// âŒ MVVM (WPF) - å¯å¤‰çŠ¶æ…‹
Products.Add(newProduct);  // ObservableCollectionã‚’ç›´æ¥å¤‰æ›´

// âœ… Store Pattern - ä¸å¤‰çŠ¶æ…‹
SetState(_state with {
    Products = _state.Products.Add(newProduct)  // æ–°ã—ã„ãƒªã‚¹ãƒˆç”Ÿæˆ
});
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- **ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“**: çŠ¶æ…‹å±¥æ­´ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã—ã‚„ã™ã„
- **ä¸¦è¡Œåˆ¶å¾¡**: ä¸å¤‰ãªã®ã§ç«¶åˆãŒèµ·ãã«ãã„
- **æ™‚é–“æ—…è¡Œãƒ‡ãƒãƒƒã‚°**: çŠ¶æ…‹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜å¯èƒ½

è©³ç´°ã¯ [09_UIå±¤ã®è©³ç´°è¨­è¨ˆ - 9.4 Store](09_UIå±¤ã®è©³ç´°è¨­è¨ˆ.md#94-storeçŠ¶æ…‹ç®¡ç†ã¨io) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---
