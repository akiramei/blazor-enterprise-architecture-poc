# 4. 全体アーキテクチャ図

[← 目次に戻る](00_README.md)

---

## 4. 全体アーキテクチャ図

### 4.1 レイヤー構造図

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  UI Layer (Blazor Components)                           ┃
┃  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┃
┃  │ Dumb         │  │ Smart        │  │ PageActions  │  ┃
┃  │ Components   │←─│ Components   │←─│              │  ┃
┃  │ (表示のみ)    │  │ (状態管理)   │  │ (UI手順)     │  ┃
┃  └──────────────┘  └───────┬──────┘  └───────┬──────┘  ┃
┃                            │                 │         ┃
┃                    ┌───────▼─────────────────▼──────┐  ┃
┃                    │      Store (状態+I/O)          │  ┃
┃                    │  ┌─────────────────────────┐   │  ┃
┃                    │  │ State (不変)            │   │  ┃
┃                    │  └─────────────────────────┘   │  ┃
┃                    └───────────┬─────────────────────┘  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━┛
                                │ IServiceScopeFactory
                                │ CreateScope()
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━▼━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  Application Layer                                      ┃
┃  ┌─────────────────────────────────────────────────┐   ┃
┃  │         MediatR (Mediator Pattern)              │   ┃
┃  │  ┌────────────────────────────────────────┐    │   ┃
┃  │  │     Pipeline Behaviors (横断的関心事)   │    │   ┃
┃  │  │  1. Logging                            │    │   ┃
┃  │  │  2. Validation                         │    │   ┃
┃  │  │  3. Authorization                      │    │   ┃
┃  │  │  4. Idempotency                        │    │   ┃
┃  │  │  5. Caching (Query)                    │    │   ┃
┃  │  │  6. Transaction (Command)              │    │   ┃
┃  │  └────────────┬───────────────────────────┘    │   ┃
┃  │               │                                 │   ┃
┃  │       ┌───────▼───────┐       ┌──────────────┐ │   ┃
┃  │       │ Query Handler │       │ Command      │ │   ┃
┃  │       │ (Read)        │       │ Handler      │ │   ┃
┃  │       └───────┬───────┘       │ (Write)      │ │   ┃
┃  │               │                └───────┬──────┘ │   ┃
┃  └───────────────┼────────────────────────┼────────┘   ┃
┗━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━┛
                    │                        │
          ┌─────────▼────────┐      ┌────────▼────────────┐
          │  Read Model      │      │   Domain Layer      │
          │  (DAO/Query)     │      │  ┌───────────────┐  │
          └──────────────────┘      │  │  Aggregates   │  │
                    │               │  │  (Business    │  │
                    │               │  │   Rules)      │  │
                    │               │  └───────────────┘  │
                    │               └─────────┬───────────┘
┏━━━━━━━━━━━━━━━━━━━▼━━━━━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━┓
┃  Infrastructure Layer                      │           ┃
┃  ┌──────────────────┐   ┌─────────────────▼────────┐  ┃
┃  │ Dapper (Read)    │   │ EF Core (Write)          │  ┃
┃  │ - SQL Views      │   │ - Repositories           │  ┃
┃  │ - ReadDao        │   │ - DbContext              │  ┃
┃  └──────────────────┘   │ - Unit of Work           │  ┃
┃                         │ - Outbox                 │  ┃
┃                         └──────────────────────────┘  ┃
┃  ┌──────────────────────────────────────────────────┐ ┃
┃  │ Event Infrastructure                             │ ┃
┃  │ - SignalR Hub                                    │ ┃
┃  │ - Outbox Dispatcher                              │ ┃
┃  │ - Message Broker (RabbitMQ/Azure Service Bus)   │ ┃
┃  └──────────────────────────────────────────────────┘ ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

### 4.2 処理フロー図(Command実行時)

```
┌─────────────┐
│   User      │
│ (クリック)   │
└──────┬──────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  1. Dumb Component                          │
│     EventCallback.InvokeAsync(id)           │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  2. Smart Component (Page)                  │
│     await Actions.DeleteAsync(id)           │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  3. PageActions                             │
│     ・確認ダイアログ表示                      │
│     ・await Store.DeleteAsync(id)           │
│     ・トースト通知                           │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  4. Store                                   │
│     ・SetState(IsLoading = true)            │
│     ・CreateScope()                         │
│     ・IMediator取得                          │
│     ・await mediator.Send(Command)          │
└──────┬──────────────────────────────────────┘
       │
       ▼ (新スコープ内)
┌─────────────────────────────────────────────┐
│  5. MediatR Pipeline                        │
│     ① LoggingBehavior                       │
│     ② ValidationBehavior                    │
│     ③ AuthorizationBehavior                 │
│     ④ IdempotencyBehavior                   │
│     ⑤ TransactionBehavior (Begin)           │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  6. Command Handler (UseCase)               │
│     ・Repository.GetAsync()                 │
│     ・Aggregate.Delete()                    │
│     ・Repository.SaveAsync()                │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  7. Domain Layer                            │
│     ・ビジネスルール検証                      │
│     ・RaiseDomainEvent()                    │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  8. Infrastructure                          │
│     ・EF Core: SaveChanges()                │
│     ・Outbox: 統合イベント記録               │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  9. Transaction Commit                      │
│     ・TransactionBehavior (Commit)          │
│     ・Outbox確定                            │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  10. Event Dispatch                         │
│     ・ドメインイベント同期処理                │
│     ・Outbox Dispatcher (非同期配信)         │
│     ・SignalR: Clients.All.SendAsync()      │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  11. Store (結果反映)                       │
│     ・SetState(IsLoading = false)           │
│     ・await LoadAsync() (再読み込み)         │
│     ・OnChangeAsync?.Invoke()               │
└──────┬──────────────────────────────────────┘
       │
       â–¼
┌─────────────────────────────────────────────┐
│  12. UI Re-render                           │
│     ・InvokeAsync(StateHasChanged)          │
│     ・Smart/Dumb自動再描画                   │
└─────────────────────────────────────────────┘
```

---
