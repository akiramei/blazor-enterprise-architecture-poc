{
  "$schema": "consumer-example/patterns.manifest.schema.json",
  "version": "v2025.11.27.3",
  "last_updated": "2025-11-27",
  "changelog_summary": "計画フェーズへの導線強化（planning_required_conditions, pre_implementation_check追加）",
  "description": "Blazor Enterprise Architecture PoC - Pattern Catalog",
  "repository": "https://github.com/akiramei/blazor-enterprise-architecture-poc",
  "phase_guidance": {
    "description": "計画フェーズと実装フェーズでのカタログの使い分け",
    "phases": {
      "planning": {
        "description": "要求分析、パターン選択、組み合わせ決定、影響範囲評価",
        "key_files": [
          "catalog/planning/PLANNING_GUIDE.md",
          "catalog/planning/pattern-combinations.yaml",
          "catalog/planning/handoff-template.yaml"
        ],
        "focus": [
          "ai_decision_matrix でパターンカテゴリを特定",
          "domain_hints でドメイン固有パターンを追加",
          "nonfunctional_pattern_hints で非機能要件パターンを選択",
          "依存関係に基づいて適用順序を決定",
          "Boundary設計（UIがある場合は必須）"
        ],
        "output": "計画書（適用パターン一覧、適用順序、影響範囲）"
      },
      "implementation": {
        "description": "計画に基づいたコード生成、テンプレート適用、検証",
        "key_files": [
          "catalog/implementation/IMPLEMENTATION_GUIDE.md",
          "各パターンのYAMLファイル（implementation.template）"
        ],
        "focus": [
          "パターンYAMLの implementation.template を使用",
          "テンプレート変数を置換してコード生成",
          "ai_guidance.common_mistakes を確認",
          "evidence で実装例を参照"
        ],
        "output": "実装コード"
      }
    },
    "workflow": {
      "step1": "計画フェーズ: PLANNING_GUIDE.md に従ってパターンを選択",
      "step2": "引き継ぎ: handoff-template.yaml で計画書を作成",
      "step3": "承認: ユーザーに計画を提示して承認を得る",
      "step4": "実装フェーズ: IMPLEMENTATION_GUIDE.md に従ってコードを生成"
    }
  },
  "planning_required_conditions": {
    "description": "計画フェーズが必要かどうかを判断する条件。実装開始前に必ず確認すること。",
    "requires_planning": {
      "triggers": [
        {
          "condition": "新規機能の追加",
          "examples": ["〇〇機能を作って", "〇〇画面を追加", "〇〇できるようにして"],
          "reason": "パターン選択と組み合わせの検討が必要"
        },
        {
          "condition": "3ファイル以上の作成が予想される",
          "examples": ["Command + Handler + Validator + UI", "Entity + Repository + Configuration"],
          "reason": "影響範囲の把握と適用順序の決定が必要"
        },
        {
          "condition": "複数パターンの組み合わせが必要",
          "examples": ["CRUD + 状態遷移", "検索 + 重複チェック", "作成 + 監査ログ"],
          "reason": "パターン間の依存関係を解決する必要がある"
        },
        {
          "condition": "UIがある",
          "examples": ["画面", "フォーム", "一覧表示", "ダイアログ"],
          "reason": "Boundaryモデリングが必須（Entity.CanXxx()の設計）"
        },
        {
          "condition": "ドメイン固有の業務ロジック",
          "examples": ["貸出ルール", "予約ルール", "承認フロー", "在庫引当"],
          "reason": "ドメインパターンの選択が必要"
        },
        {
          "condition": "非機能要件の考慮が必要",
          "examples": ["監査ログ", "同時実行制御", "キャッシュ", "認可"],
          "reason": "nonfunctional_pattern_hintsの確認が必要"
        }
      ],
      "action": "catalog/planning/PLANNING_GUIDE.md を読み、計画フェーズを実行する"
    },
    "skip_planning": {
      "conditions": [
        {
          "condition": "単一ファイルの修正",
          "examples": ["バグ修正", "リファクタリング", "typo修正"]
        },
        {
          "condition": "既存機能への小さな変更",
          "examples": ["フィールド追加", "バリデーション修正", "ラベル変更"]
        },
        {
          "condition": "テンプレート変数の置換のみ",
          "examples": ["既存パターンの別エンティティへの適用"]
        },
        {
          "condition": "ドキュメントの更新",
          "examples": ["README更新", "コメント追加"]
        }
      ],
      "action": "直接実装に進む（catalog/implementation/IMPLEMENTATION_GUIDE.md）"
    },
    "decision_flowchart": "CLAUDE.md の「計画フェーズが必要か判断する」セクションを参照"
  },
  "ai_bootstrap": {
    "description": "AI エージェントが最初に読むべき情報（フェーズ別）",
    "pre_implementation_check": {
      "instruction": "⚠️ 実装を開始する前に、このタスクが計画フェーズを必要とするか判断すること",
      "check_order": [
        "1. CLAUDE.md の「計画フェーズが必要か判断する」セクションを確認",
        "2. planning_required_conditions の triggers に該当するか確認",
        "3. 該当する場合 → catalog/planning/PLANNING_GUIDE.md を読む",
        "4. 該当しない場合 → catalog/implementation/IMPLEMENTATION_GUIDE.md を読む"
      ],
      "mandatory": true,
      "skip_penalty": "計画なしで実装を開始した場合、パターンの組み合わせミスやBoundaryモデリングの欠落が発生しやすい"
    },
    "phase_specific_reading": {
      "planning_phase": {
        "description": "計画フェーズで読むべきファイル",
        "files": [
          {
            "order": 1,
            "file": "catalog/planning/PLANNING_GUIDE.md",
            "purpose": "planning_workflow",
            "description": "計画フェーズの進め方（6ステップ）",
            "required": true
          },
          {
            "order": 2,
            "file": "catalog/index.json",
            "purpose": "ai_decision_matrix",
            "description": "パターン選択の意思決定マトリクス",
            "required": true
          },
          {
            "order": 3,
            "file": "catalog/planning/pattern-combinations.yaml",
            "purpose": "pattern_combinations",
            "description": "ドメイン別パターン組み合わせ例",
            "required": true
          },
          {
            "order": 4,
            "file": "catalog/planning/handoff-template.yaml",
            "purpose": "handoff_format",
            "description": "計画→実装の引き継ぎフォーマット",
            "required": true
          }
        ]
      },
      "implementation_phase": {
        "description": "実装フェーズで読むべきファイル",
        "files": [
          {
            "order": 1,
            "file": "catalog/implementation/IMPLEMENTATION_GUIDE.md",
            "purpose": "implementation_workflow",
            "description": "実装フェーズの進め方",
            "required": true
          },
          {
            "order": 2,
            "file": "catalog/COMMON_MISTAKES.md",
            "purpose": "common_mistakes",
            "description": "頻出する実装ミス（SaveChangesAsync、Value Object比較）",
            "required": true
          },
          {
            "order": 3,
            "file": "各パターンのYAMLファイル",
            "purpose": "implementation_template",
            "description": "計画で選択されたパターンのテンプレートを参照",
            "required": true
          }
        ]
      }
    },
    "priority_reading_order": [
      {
        "order": 1,
        "file": "catalog/scaffolds/project-structure.yaml",
        "purpose": "project_structure",
        "description": "標準プロジェクト構造（5プロジェクト構成、依存関係、UI配置ルール）",
        "required": true,
        "phases": ["planning", "implementation"]
      },
      {
        "order": 2,
        "file": "CLAUDE.md",
        "purpose": "critical_constraints",
        "description": "実装ルール・禁止事項・クイックリファレンス",
        "required": true,
        "phases": ["planning", "implementation"]
      },
      {
        "order": 3,
        "file": "catalog/COMMON_MISTAKES.md",
        "purpose": "common_mistakes",
        "description": "頻出する実装ミス（SaveChangesAsync、Value Object比較、Boundary判定）",
        "required": true,
        "phases": ["implementation"]
      },
      {
        "order": 4,
        "file": "catalog/AI_USAGE_GUIDE.md",
        "purpose": "implementation_guide",
        "description": "詳細な実装ガイド・アーキテクチャ全体像",
        "required": true,
        "phases": ["planning", "implementation"]
      },
      {
        "order": 5,
        "file": "catalog/index.json",
        "purpose": "pattern_index",
        "description": "パターン索引・意思決定マトリクス",
        "required": true,
        "phases": ["planning", "implementation"]
      },
      {
        "order": 6,
        "file": "patterns.manifest.json",
        "purpose": "enabled_patterns",
        "description": "有効なパターン一覧",
        "required": false,
        "phases": ["implementation"]
      },
      {
        "order": 7,
        "file": "catalog/DECISION_FLOWCHART.md",
        "purpose": "pattern_selection",
        "description": "パターン選択アルゴリズム",
        "required": false,
        "phases": ["planning"]
      },
      {
        "order": 8,
        "file": "catalog/planning/PLANNING_GUIDE.md",
        "purpose": "planning_guide",
        "description": "計画フェーズの進め方",
        "required": false,
        "phases": ["planning"]
      },
      {
        "order": 9,
        "file": "catalog/implementation/IMPLEMENTATION_GUIDE.md",
        "purpose": "implementation_guide",
        "description": "実装フェーズの進め方",
        "required": false,
        "phases": ["implementation"]
      }
    ],
    "skip_if_familiar": [
      "docs/blazor-guide-package/docs/00_README.md",
      "docs/architecture/*.md"
    ],
    "critical_constraints": {
      "never_do": [
        "Handler内でSaveChangesAsync()を呼ばない（TransactionBehaviorが自動実行）",
        "SingletonでDbContextやScopedサービスを注入しない",
        "MediatRのHandleメソッド名をHandleAsyncにしない",
        "独自のCQRS基盤を作らない（MediatRを使用）",
        "例外をthrowしてエラーを伝播しない（Result<T>を使用）",
        "Features/{Feature}/UI/ サブフォルダを作らない（同列配置）",
        "Shared/{BC}/ フォルダを作らない（SharedプロジェクトにBC混入禁止）"
      ],
      "always_do": [
        "CommandはResult<T>を返す",
        "サービスはScopedで登録",
        "パターンのYAMLを読んでから実装",
        "機能固有UIは Features/{Feature}/ に .cs と同列配置",
        "BC固有インフラは Application/Infrastructure/{BC}/ に配置"
      ]
    },
    "default_pattern_on_uncertainty": "feature-slice",
    "conditional_mustread_patterns": {
      "description": "特定の条件下で必ず読むべきパターン。計画フェーズで確認必須。",
      "rules": [
        {
          "condition": "UIがある / ユーザー対話がある",
          "mustread": "patterns/boundary-pattern.yaml",
          "reason": "AIの学習バイアスによりBoundaryモデリングが忘却されやすい。UIがある場合は必ず読むこと。",
          "plan_requirement": "計画にBoundaryセクション（Intent, Entity.CanXxx()）を含めること"
        },
        {
          "condition": "状態遷移がある",
          "mustread": "patterns/domain-state-machine.yaml",
          "reason": "状態遷移の制約を明確化するため"
        },
        {
          "condition": "重複チェック / 在庫引当がある",
          "mustread": "patterns/domain-validation-service.yaml",
          "reason": "複数エンティティをまたぐビジネスルール検証のため"
        },
        {
          "condition": "予約 / ダブルブッキング防止",
          "mustread": "patterns/concurrency-control.yaml",
          "reason": "同時実行制御（悲観的ロック）が必要なため"
        },
        {
          "condition": "本番運用を想定 / 運用監視が必要",
          "mustread": "patterns/logging-behavior.yaml",
          "reason": "運用時のトラブルシューティングに必須。全システムで推奨。",
          "plan_requirement": "非機能要件セクションにロギング要件を記載すること"
        },
        {
          "condition": "監査証跡が必要 / 履歴追跡が必要 / コンプライアンス要件あり",
          "mustread": "patterns/audit-log-behavior.yaml",
          "reason": "誰が・いつ・何をしたかの記録。図書館・金融・医療等で必須。",
          "plan_requirement": "監査対象のCommand一覧を計画に含めること"
        },
        {
          "condition": "パフォーマンス要件あり / 負荷が高い",
          "mustread": ["patterns/metrics-behavior.yaml", "patterns/caching-behavior.yaml"],
          "reason": "メトリクス収集とキャッシュによる最適化"
        }
      ],
      "enforcement": {
        "plan_phase_check": "UIがあるのにBoundaryセクションがない計画は不完全とみなす",
        "spec_template": "catalog/scaffolds/spec-template.yaml を使用して仕様書を作成すること"
      }
    }
  },
  "categories": {
    "kernel": {
      "name": "Kernel (DDD Foundations)",
      "description": "DDD基盤型（Entity, ValueObject, Result）。他の全パターンの前提となる基盤。",
      "scope": "全パターン共通",
      "priority": "critical",
      "note": "これらのパターンは他のパターンを使用する前に理解しておく必要がある"
    },
    "scaffold": {
      "name": "Scaffolds",
      "description": "新規プロジェクト作成時の標準構造・テンプレート",
      "scope": "プロジェクト全体"
    },
    "pipeline-behavior": {
      "name": "Pipeline Behaviors",
      "description": "MediatR パイプラインで実行される横断的関心事",
      "execution_order": "order_hint に従って実行される"
    },
    "feature-slice": {
      "name": "Feature Slices",
      "description": "完全な垂直スライス（Application + UI + API）",
      "scope": "複数レイヤーにまたがる機能全体"
    },
    "layer-element": {
      "name": "Layer Elements",
      "description": "個別レイヤーの要素（Command, Handler, Store, PageActions など）",
      "scope": "単一レイヤーの個別ファイル"
    },
    "query-pattern": {
      "name": "Query Patterns",
      "description": "データ取得パターン（CQRS の Query 側）"
    },
    "command-pattern": {
      "name": "Command Patterns",
      "description": "データ変更パターン（CQRS の Command 側）"
    },
    "domain-pattern": {
      "name": "Domain Patterns",
      "description": "ドメインモデルの実装パターン"
    },
    "ui-pattern": {
      "name": "UI Patterns",
      "description": "Blazor UI の実装パターン（Store, PageActions, Component）"
    },
    "infrastructure-pattern": {
      "name": "Infrastructure Patterns",
      "description": "インフラストラクチャ層のパターン（同時実行制御、永続化など）"
    }
  },
  "patterns": [
    {
      "id": "result-pattern",
      "name": "Result Pattern (Railway Oriented Programming)",
      "category": "kernel",
      "version": "1.0.0",
      "file": "kernel/result-pattern.yaml",
      "intent": "例外に頼らないエラーハンドリングの基盤。すべてのCommand/Queryの戻り値として使用。",
      "tags": ["kernel", "error-handling", "result", "railway", "foundation"],
      "stability": "stable",
      "scope": "foundation",
      "priority": "critical"
    },
    {
      "id": "value-object",
      "name": "ValueObject Base Class (DDD Foundation)",
      "category": "kernel",
      "version": "1.0.0",
      "file": "kernel/value-object.yaml",
      "intent": "値による同一性を持つ不変オブジェクトの基底クラス。Money、Address等の値オブジェクト作成の基盤。",
      "tags": ["kernel", "value-object", "ddd", "immutable", "foundation"],
      "stability": "stable",
      "scope": "foundation",
      "priority": "critical"
    },
    {
      "id": "entity-base",
      "name": "Entity Base Class (DDD Foundation)",
      "category": "kernel",
      "version": "1.0.0",
      "file": "kernel/entity-base.yaml",
      "intent": "識別子による同一性を持つエンティティの基底クラス。ドメインイベント発行機能を含む。",
      "tags": ["kernel", "entity", "ddd", "domain-event", "foundation"],
      "stability": "stable",
      "scope": "foundation",
      "priority": "high"
    },
    {
      "id": "project-structure",
      "name": "Project Structure (VSA Standard)",
      "category": "scaffold",
      "version": "1.0.0",
      "file": "scaffolds/project-structure.yaml",
      "intent": "新規プロジェクトの標準構造を定義し、一貫性のあるソリューションを生成する",
      "tags": ["scaffold", "project-structure", "vsa", "standard"],
      "stability": "stable",
      "scope": "project-wide"
    },
    {
      "id": "spec-template",
      "name": "Specification Template (Boundary Required)",
      "category": "scaffold",
      "version": "1.0.0",
      "file": "scaffolds/spec-template.yaml",
      "intent": "AIに仕様を与える際の標準フォーマット。Boundaryセクションを必須化し、モデリング忘却を防止する",
      "tags": ["scaffold", "specification", "boundary", "template", "ai-bias-prevention"],
      "stability": "stable",
      "scope": "project-wide"
    },
    {
      "id": "metrics-behavior",
      "name": "MetricsBehavior",
      "category": "pipeline-behavior",
      "version": "1.4.0",
      "order_hint": 50,
      "file": "patterns/metrics-behavior.yaml",
      "intent": "ビジネスメトリクスとパフォーマンスメトリクスを自動収集",
      "tags": ["observability", "performance", "monitoring"],
      "stability": "stable"
    },
    {
      "id": "validation-behavior",
      "name": "ValidationBehavior",
      "category": "pipeline-behavior",
      "version": "1.3.0",
      "order_hint": 100,
      "file": "patterns/validation-behavior.yaml",
      "intent": "FluentValidation による入力検証を MediatR パイプラインで自動実行",
      "tags": ["validation", "fluent-validation"],
      "stability": "stable"
    },
    {
      "id": "authorization-behavior",
      "name": "AuthorizationBehavior",
      "category": "pipeline-behavior",
      "version": "1.2.1",
      "order_hint": 200,
      "file": "patterns/authorization-behavior.yaml",
      "intent": "ロールベース認可チェックを MediatR パイプラインで自動実行",
      "tags": ["authorization", "security", "role-based"],
      "stability": "stable"
    },
    {
      "id": "idempotency-behavior",
      "name": "IdempotencyBehavior",
      "category": "pipeline-behavior",
      "version": "0.9.0",
      "order_hint": 300,
      "file": "patterns/idempotency-behavior.yaml",
      "intent": "Command の冪等性を保証し、重複実行を防止",
      "tags": ["idempotency", "cache", "reliability"],
      "stability": "beta"
    },
    {
      "id": "caching-behavior",
      "name": "CachingBehavior",
      "category": "pipeline-behavior",
      "version": "1.0.0",
      "order_hint": 350,
      "file": "patterns/caching-behavior.yaml",
      "intent": "Query結果をメモリキャッシュし、パフォーマンスを向上",
      "tags": ["caching", "performance", "query"],
      "stability": "stable"
    },
    {
      "id": "transaction-behavior",
      "name": "TransactionBehavior",
      "category": "pipeline-behavior",
      "version": "2.0.0",
      "order_hint": 400,
      "file": "patterns/transaction-behavior.yaml",
      "intent": "Command を単一トランザクションで実行し、エラー時に自動ロールバック",
      "tags": ["transaction", "entity-framework", "database"],
      "stability": "stable"
    },
    {
      "id": "logging-behavior",
      "name": "LoggingBehavior",
      "category": "pipeline-behavior",
      "version": "1.1.0",
      "order_hint": 600,
      "file": "patterns/logging-behavior.yaml",
      "intent": "すべての Command/Query のリクエスト・レスポンス・実行時間をログ出力",
      "tags": ["logging", "observability"],
      "stability": "stable"
    },
    {
      "id": "audit-log-behavior",
      "name": "AuditLogBehavior",
      "category": "pipeline-behavior",
      "version": "1.0.0",
      "order_hint": 550,
      "file": "patterns/audit-log-behavior.yaml",
      "intent": "Command実行の監査ログを自動記録（操作履歴・変更履歴）",
      "tags": ["audit-log", "compliance", "security", "tracking"],
      "stability": "stable"
    },
    {
      "id": "query-get-list",
      "name": "GetListQuery Pattern",
      "category": "query-pattern",
      "version": "1.0.0",
      "file": "patterns/query-get-list.yaml",
      "intent": "全件取得クエリのテンプレート（キャッシュ対応）",
      "tags": ["query", "cqrs", "cache", "dapper"],
      "stability": "stable"
    },
    {
      "id": "query-get-by-id",
      "name": "GetByIdQuery Pattern",
      "category": "query-pattern",
      "version": "1.0.0",
      "file": "patterns/query-get-by-id.yaml",
      "intent": "IDによる単一エンティティ取得クエリのテンプレート（キャッシュ対応）",
      "tags": ["query", "cqrs", "cache", "dapper", "single"],
      "stability": "stable"
    },
    {
      "id": "command-create",
      "name": "CreateCommand Pattern",
      "category": "command-pattern",
      "version": "1.0.0",
      "file": "patterns/command-create.yaml",
      "intent": "新規エンティティ作成コマンドのテンプレート",
      "tags": ["command", "cqrs", "create", "idempotency"],
      "stability": "stable"
    },
    {
      "id": "feature-create-entity",
      "name": "Create Entity Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-create-entity.yaml",
      "intent": "エンティティ作成の完全な垂直スライス（Application + UI + API）",
      "tags": ["feature-slice", "create", "vertical-slice", "full-stack"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "feature-search-entity",
      "name": "Search Entity Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-search-entity.yaml",
      "intent": "エンティティ検索・フィルタリング・ページングの完全な垂直スライス",
      "tags": ["feature-slice", "search", "filtering", "paging"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "feature-export-csv",
      "name": "CSV Export Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-export-csv.yaml",
      "intent": "検索条件に基づいたデータをCSV形式でエクスポートする機能",
      "tags": ["feature-slice", "csv", "export", "download"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "feature-update-entity",
      "name": "Update Entity Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-update-entity.yaml",
      "intent": "エンティティの更新機能（楽観的排他制御・冪等性保証）",
      "tags": ["feature-slice", "update", "edit", "crud", "optimistic-lock"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "feature-delete-entity",
      "name": "Delete Entity Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-delete-entity.yaml",
      "intent": "エンティティの削除機能（論理削除 or 物理削除）",
      "tags": ["feature-slice", "delete", "crud", "soft-delete", "hard-delete"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "feature-import-csv",
      "name": "CSV Import Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-import-csv.yaml",
      "intent": "CSVファイルからデータを一括インポートする機能",
      "tags": ["feature-slice", "csv", "import", "bulk-operation", "upload"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "feature-file-upload",
      "name": "File Upload Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-file-upload.yaml",
      "intent": "ファイルアップロード機能（添付ファイル・画像アップロード）",
      "tags": ["feature-slice", "file-upload", "attachment", "storage", "azure-blob", "s3"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "layer-store",
      "name": "Layer Store Pattern (Flux-based State Management)",
      "category": "ui-pattern",
      "version": "1.0.0",
      "file": "patterns/layer-store.yaml",
      "intent": "フロントエンド状態をシステムレベルとドメイン固有の2層に分離し、再利用性と保守性を高める",
      "tags": ["ui", "state-management", "store", "blazor", "flux", "session", "theme"],
      "stability": "stable"
    },
    {
      "id": "layer-pageactions",
      "name": "PageActions Pattern (UI Procedures)",
      "category": "layer-element",
      "version": "1.0.0",
      "file": "layers/layer-pageactions.yaml",
      "intent": "UI手順のオーケストレーションを担当するPageActionsパターン",
      "tags": ["ui", "orchestration", "pageactions", "blazor"],
      "stability": "stable",
      "layer": "UI"
    },
    {
      "id": "realtime-notification-pattern",
      "name": "Real-time Notification Pattern (SignalR)",
      "category": "ui-pattern",
      "version": "1.0.0",
      "file": "patterns/realtime-notification-pattern.yaml",
      "intent": "SignalRを使用したリアルタイム通知でUI自動更新を実現",
      "tags": ["signalr", "realtime", "notification", "ui-sync", "blazor"],
      "stability": "stable"
    },
    {
      "id": "undo-redo-pattern",
      "name": "Undo/Redo Pattern (UI State Management)",
      "category": "ui-pattern",
      "version": "1.0.0",
      "file": "patterns/undo-redo-pattern.yaml",
      "intent": "ユーザー操作の取り消し・やり直し機能をUI層の責務として実装",
      "tags": ["undo", "redo", "history", "ui-state", "blazor"],
      "stability": "stable"
    },
    {
      "id": "feature-approval-workflow",
      "name": "Approval Workflow Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-approval-workflow.yaml",
      "intent": "稟議・申請の承認ワークフローを実装（マルチステップ承認）",
      "tags": ["approval", "workflow", "ringi", "multi-step", "domain-driven"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "feature-authentication",
      "name": "Authentication Feature Slice",
      "category": "feature-slice",
      "version": "1.0.0",
      "file": "features/feature-authentication.yaml",
      "intent": "ログイン・2FA・トークン管理を含む認証機能の完全な垂直スライス",
      "tags": ["authentication", "login", "jwt", "2fa", "security"],
      "stability": "stable",
      "scope": "vertical-slice"
    },
    {
      "id": "domain-state-machine",
      "name": "State Machine Pattern",
      "category": "domain-pattern",
      "version": "1.0.0",
      "file": "patterns/domain-state-machine.yaml",
      "intent": "ステートマシンによる状態遷移管理（不正な遷移を防止）",
      "tags": ["state-machine", "state-transition", "domain", "validation"],
      "stability": "stable"
    },
    {
      "id": "domain-approval-history",
      "name": "Approval History Pattern",
      "category": "domain-pattern",
      "version": "1.0.0",
      "file": "patterns/domain-approval-history.yaml",
      "intent": "承認履歴を記録・追跡（誰が・いつ・何を承認/却下したか）",
      "tags": ["approval-history", "audit", "tracking", "domain"],
      "stability": "stable"
    },
    {
      "id": "boundary-pattern",
      "name": "Boundary Pattern (Intent-Boundary分離)",
      "category": "domain-pattern",
      "version": "1.0.0",
      "file": "patterns/boundary-pattern.yaml",
      "intent": "ユーザーとシステムの接点（操作可否判定）をドメイン層に配置し、UIから業務ルールを分離",
      "tags": ["boundary", "intent", "domain", "ui-separation", "business-rule"],
      "stability": "stable"
    },
    {
      "id": "query-service-pattern",
      "name": "Query Service Pattern (CQRS Query Side)",
      "category": "query-pattern",
      "version": "1.0.0",
      "file": "patterns/query-service-pattern.yaml",
      "intent": "Query HandlerからDbContext直接使用を排除し、Query側の実装を統一",
      "tags": ["query", "cqrs", "as-no-tracking", "read-optimization"],
      "stability": "stable"
    },
    {
      "id": "domain-validation-service",
      "name": "Domain Validation Service Pattern",
      "category": "domain-pattern",
      "version": "1.0.0",
      "file": "patterns/domain-validation-service.yaml",
      "intent": "複数エンティティをまたぐビジネスルール検証をドメインサービスとして実装（重複チェック、在庫引当、残高確認、排他制御など）",
      "tags": ["domain-service", "validation", "business-rule", "overlap-check", "inventory", "balance", "reservation"],
      "stability": "stable"
    },
    {
      "id": "concurrency-control",
      "name": "Concurrency Control Pattern",
      "category": "infrastructure-pattern",
      "version": "1.0.0",
      "file": "patterns/concurrency-control.yaml",
      "intent": "同時実行制御（楽観的ロック/悲観的ロック）でデータ整合性を保証（更新競合、ダブルブッキング防止、在庫引当など）",
      "tags": ["concurrency", "optimistic-lock", "pessimistic-lock", "row-version", "for-update", "double-booking"],
      "stability": "stable"
    },
    {
      "id": "outbox-pattern",
      "name": "Transactional Outbox Pattern",
      "category": "infrastructure-pattern",
      "version": "1.0.0",
      "file": "patterns/outbox-pattern.yaml",
      "intent": "ドメインイベントとビジネスエンティティを同一トランザクションで保存し、マイクロサービス間の結果整合性を保証",
      "tags": ["outbox", "event-delivery", "eventual-consistency", "transaction", "microservices", "domain-event"],
      "stability": "stable"
    },
    {
      "id": "complex-query-service",
      "name": "Complex Query Service Pattern",
      "category": "query-pattern",
      "version": "1.0.0",
      "file": "patterns/complex-query-service.yaml",
      "intent": "複合条件クエリを専用サービスとして実装（NOT EXISTS/空き検索、複数テーブル結合、未割当検索など）",
      "tags": ["query", "dapper", "complex-query", "available-search", "not-exists", "unassigned", "vacancy"],
      "stability": "stable"
    },
    {
      "id": "aggregation-reporting",
      "name": "Aggregation & Reporting Pattern",
      "category": "query-pattern",
      "version": "1.0.0",
      "file": "patterns/aggregation-reporting.yaml",
      "intent": "リアルタイム集計、ダッシュボード表示、売上レポート、ランキングなどの高度な集計クエリを実装",
      "tags": ["query", "dapper", "aggregation", "reporting", "dashboard", "kpi", "ranking", "materialized-view"],
      "stability": "stable"
    },
    {
      "id": "domain-timeslot",
      "name": "TimeSlot Value Object Pattern",
      "category": "domain-pattern",
      "version": "1.0.0",
      "file": "patterns/domain-timeslot.yaml",
      "intent": "時間枠（半開区間）を値オブジェクトとして抽象化し、重複判定を統一",
      "tags": ["value-object", "time-slot", "booking", "reservation", "overlap", "half-open-interval"],
      "stability": "stable"
    },
    {
      "id": "domain-typed-id",
      "name": "Typed ID Value Object Pattern",
      "category": "domain-pattern",
      "version": "1.0.0",
      "file": "patterns/domain-typed-id.yaml",
      "intent": "集約固有の強型付けIDで型安全性を確保し、ID取り違えを防止",
      "tags": ["value-object", "typed-id", "aggregate-id", "type-safety", "guid"],
      "stability": "stable"
    },
    {
      "id": "query-get-by-period",
      "name": "GetByPeriodQuery Pattern",
      "category": "query-pattern",
      "version": "1.0.0",
      "file": "patterns/query-get-by-period.yaml",
      "intent": "期間（日付範囲）を指定してエンティティを取得するクエリパターン",
      "tags": ["query", "cqrs", "period", "date-range", "calendar", "schedule", "booking"],
      "stability": "stable"
    },
    {
      "id": "domain-ordered-queue",
      "name": "Ordered Queue Pattern (Position Management)",
      "category": "domain-pattern",
      "version": "1.0.0",
      "file": "patterns/domain-ordered-queue.yaml",
      "intent": "順序付きキュー（待ち行列）の管理パターン。予約順、処理順、優先度順などの順序管理を実装",
      "tags": ["domain", "queue", "position", "ready-state", "reservation", "waiting-list", "priority"],
      "stability": "stable",
      "note": "図書館ドッグフーディングFR-018対策として追加。予約の順番管理が完全に未実装だった問題を解決。"
    }
  ],
  "recommended_combinations": [
    {
      "name": "標準的な CQRS + Behaviors",
      "description": "ほとんどの業務アプリで推奨される基本構成",
      "patterns": [
        "metrics-behavior",
        "validation-behavior",
        "authorization-behavior",
        "transaction-behavior",
        "logging-behavior"
      ]
    },
    {
      "name": "高信頼性構成（冪等性あり）",
      "description": "支払い処理など、重複実行が致命的な処理を含む場合",
      "patterns": [
        "metrics-behavior",
        "validation-behavior",
        "authorization-behavior",
        "idempotency-behavior",
        "transaction-behavior",
        "logging-behavior"
      ]
    }
  ],
  "ai_decision_matrix": {
    "user_intent_to_pattern": {
      "新機能追加": {
        "pattern_category": "feature-slice",
        "confidence": 0.95,
        "trigger_keywords": ["機能", "追加", "実装", "画面", "できるように"],
        "examples": [
          "商品を作成する機能を追加してください → feature-create-entity",
          "検索画面を実装してください → feature-search-entity",
          "顧客を編集できるようにしてください → feature-update-entity"
        ],
        "decision_rule": "ユーザーが「新しい機能」を求めている場合、まず feature-slice を検討する"
      },
      "重複チェック・競合チェック": {
        "pattern_category": "domain-pattern",
        "confidence": 0.95,
        "trigger_keywords": ["重複", "競合", "チェック", "確認", "同時", "排他", "ダブル", "衝突", "予約", "引当", "在庫", "残高", "割当"],
        "examples": [
          "予約の重複をチェックしてください → domain-validation-service",
          "ダブルブッキングを防いでください → domain-validation-service + concurrency-control",
          "在庫の引当確認をしてください → domain-validation-service",
          "シフトの重複を検出してください → domain-validation-service",
          "口座残高を確認してから引き落とし → domain-validation-service"
        ],
        "decision_rule": "複数エンティティをまたぐビジネスルール検証は domain-validation-service"
      },
      "空き検索・複合検索": {
        "pattern_category": "query-pattern",
        "confidence": 0.90,
        "trigger_keywords": ["空き", "利用可能", "複合条件", "結合", "NOT EXISTS", "存在しない", "含まない", "除外", "未使用", "未割当", "空席", "空室"],
        "examples": [
          "空き会議室を検索してください → complex-query-service",
          "利用可能な時間帯を取得してください → complex-query-service",
          "在庫がある商品を検索してください → complex-query-service",
          "担当者が割り当てられていないタスクを取得 → complex-query-service",
          "予約が入っていない座席を検索 → complex-query-service"
        ],
        "decision_rule": "NOT EXISTS や複数テーブル結合を含むクエリは complex-query-service"
      },
      "システム全体の機能追加": {
        "pattern_category": "pipeline-behavior",
        "confidence": 0.90,
        "trigger_keywords": ["すべて", "全体", "システム", "共通", "横断的"],
        "examples": [
          "すべてのCommandに入力検証を追加してください → validation-behavior",
          "トランザクション管理を有効にしてください → transaction-behavior"
        ],
        "decision_rule": "「すべての〜」「システム全体の〜」という要求は pipeline-behavior"
      },
      "既存ファイルの修正": {
        "pattern_category": "layer-element",
        "confidence": 0.85,
        "trigger_keywords": ["修正", "変更", "最適化", "だけ", "のみ"],
        "examples": [
          "ProductEditStoreのLoadAsyncを最適化してください → layer-store",
          "PageActionsのキャンセル処理を修正してください → layer-pageactions"
        ],
        "decision_rule": "特定のファイル名が含まれ、修正を求めている場合は layer-element"
      },
      "パターン理解・学習": {
        "pattern_category": "layer-element",
        "confidence": 1.0,
        "trigger_keywords": ["例", "見せて", "教えて", "どう", "実装方法"],
        "examples": [
          "Storeパターンの実装例を見せてください → layer-store",
          "PageActionsの使い方を教えてください → layer-pageactions"
        ],
        "decision_rule": "学習目的の場合は layer-element を参照用として提示"
      },
      "認証・認可の実装": {
        "pattern_category": "feature-slice",
        "confidence": 0.95,
        "trigger_keywords": ["認証", "ログイン", "2FA", "二要素", "JWT", "トークン", "セッション", "サインイン", "サインアウト"],
        "examples": [
          "ログイン機能を実装してください → feature-authentication",
          "二要素認証を追加してください → feature-authentication",
          "JWTトークンで認証してください → feature-authentication"
        ],
        "decision_rule": "認証・ログイン関連の要求は feature-authentication"
      },
      "バルク操作": {
        "pattern_category": "feature-slice",
        "confidence": 0.90,
        "trigger_keywords": ["一括", "バルク", "大量", "まとめて", "複数", "バッチ"],
        "examples": [
          "商品を一括削除してください → feature-delete-entity (BulkDelete)",
          "価格を一括更新してください → feature-update-entity (BulkUpdate)",
          "CSVから一括インポートしてください → feature-import-csv"
        ],
        "decision_rule": "一括操作はCRUDの派生形として feature-slice を適用"
      },
      "キャッシュ・パフォーマンス最適化": {
        "pattern_category": "pipeline-behavior",
        "confidence": 0.85,
        "trigger_keywords": ["キャッシュ", "高速化", "負荷軽減", "パフォーマンス", "レスポンス", "遅い"],
        "examples": [
          "検索結果をキャッシュしてください → caching-behavior",
          "APIレスポンスを高速化してください → caching-behavior",
          "DBアクセスを減らしてください → caching-behavior"
        ],
        "decision_rule": "キャッシュ・パフォーマンス改善は caching-behavior"
      },
      "単一エンティティ取得": {
        "pattern_category": "query-pattern",
        "confidence": 0.90,
        "trigger_keywords": ["詳細", "単一", "1件", "ById", "ID指定", "取得"],
        "examples": [
          "商品詳細を表示してください → query-get-by-id",
          "IDで顧客情報を取得してください → query-get-by-id",
          "注文の詳細画面を作成してください → query-get-by-id"
        ],
        "decision_rule": "ID指定の単一取得は query-get-by-id"
      },
      "期間検索・日付範囲取得": {
        "pattern_category": "query-pattern",
        "confidence": 0.90,
        "trigger_keywords": ["期間", "日付範囲", "今日", "今週", "今月", "From〜To", "カレンダー", "スケジュール", "履歴"],
        "examples": [
          "今日の予約一覧を表示してください → query-get-by-period",
          "今週のシフトを取得してください → query-get-by-period",
          "日付範囲で売上履歴を検索してください → query-get-by-period",
          "カレンダー表示用にイベントを取得してください → query-get-by-period"
        ],
        "decision_rule": "日付/期間を指定してデータを取得する場合は query-get-by-period"
      },
      "時間枠・予約時間管理": {
        "pattern_category": "domain-pattern",
        "confidence": 0.95,
        "trigger_keywords": ["時間枠", "タイムスロット", "時間帯", "開始時刻", "終了時刻", "重複チェック", "ダブルブッキング", "予約時間"],
        "examples": [
          "予約の時間枠を管理してください → domain-timeslot",
          "時間帯の重複をチェックしてください → domain-timeslot + domain-validation-service",
          "シフトの時間枠を定義してください → domain-timeslot"
        ],
        "decision_rule": "開始/終了時刻を持つ時間枠の抽象化は domain-timeslot"
      },
      "型安全ID・集約ID": {
        "pattern_category": "domain-pattern",
        "confidence": 0.90,
        "trigger_keywords": ["ID型", "強型付け", "型安全", "GuidをラップしてID", "取り違え防止", "集約ID"],
        "examples": [
          "BookingIdとRoomIdを区別してください → domain-typed-id",
          "IDの取り違えを防止してください → domain-typed-id",
          "型安全なIDを作成してください → domain-typed-id"
        ],
        "decision_rule": "集約ごとに専用のID型が必要な場合は domain-typed-id"
      },
      "イベント配信・結果整合性": {
        "pattern_category": "infrastructure-pattern",
        "confidence": 0.95,
        "trigger_keywords": ["イベント配信", "結果整合性", "Outbox", "ドメインイベント", "マイクロサービス連携", "非同期メッセージング", "トランザクション保証"],
        "examples": [
          "ドメインイベントを確実に配信してください → outbox-pattern",
          "データベース更新とイベント発行を原子的に行いたい → outbox-pattern",
          "マイクロサービス間でイベントを連携したい → outbox-pattern"
        ],
        "decision_rule": "ドメインイベントの確実な配信・結果整合性が必要な場合は outbox-pattern"
      },
      "状態管理・Store": {
        "pattern_category": "ui-pattern",
        "confidence": 0.90,
        "trigger_keywords": ["状態管理", "Store", "Flux", "セッション", "テーマ", "通知", "トースト", "サイドバー"],
        "examples": [
          "商品一覧の状態を管理したい → layer-store",
          "ログイン状態を画面間で共有したい → layer-store",
          "ダークモード切り替えを実装したい → layer-store",
          "トースト通知を表示したい → layer-store"
        ],
        "decision_rule": "UIの状態管理（システムレベル/ドメイン固有）は layer-store"
      },
      "集計・レポート": {
        "pattern_category": "query-pattern",
        "confidence": 0.95,
        "trigger_keywords": ["集計", "レポート", "ランキング", "ダッシュボード", "売上分析", "KPI", "GROUP BY", "SUM", "COUNT", "Materialized View"],
        "examples": [
          "商品の売上レポートを作成したい → aggregation-reporting",
          "売れ筋ランキングを表示したい → aggregation-reporting",
          "ダッシュボードにKPIを表示したい → aggregation-reporting",
          "期間を指定して集計したい → aggregation-reporting"
        ],
        "decision_rule": "集計クエリ（GROUP BY、SUM、ランキング、ダッシュボード）は aggregation-reporting"
      },
      "順序管理・キュー": {
        "pattern_category": "domain-pattern",
        "confidence": 0.95,
        "trigger_keywords": ["順番", "キュー", "待ち行列", "Position", "予約順", "何番目", "先頭", "Ready状態", "順番待ち", "先着順", "繰り上げ"],
        "examples": [
          "予約の順番を管理したい → domain-ordered-queue",
          "待ち行列を実装したい → domain-ordered-queue",
          "順番が回ってきたらReady状態にしたい → domain-ordered-queue + domain-state-machine",
          "先頭の予約者に優先権を与えたい → domain-ordered-queue + boundary-pattern",
          "キャンセル時に後続の順番を繰り上げたい → domain-ordered-queue"
        ],
        "decision_rule": "順番（Position）を持つキュー管理は domain-ordered-queue。図書館ドッグフーディングFR-018対策。"
      },
      "複合前提条件チェック": {
        "pattern_category": "domain-pattern",
        "confidence": 0.90,
        "trigger_keywords": ["〜のみ", "〜の場合のみ", "前提条件", "すべて〜の場合", "全部〜なら", "利用可能なコピーがある場合"],
        "examples": [
          "全コピー貸出中のみ予約可能 → domain-validation-service（複合前提条件）",
          "在庫がある場合のみ注文可能 → domain-validation-service",
          "残高がある場合のみ決済可能 → domain-validation-service",
          "利用可能なコピーがあれば予約不可 → domain-validation-service"
        ],
        "decision_rule": "複数条件を組み合わせた前提条件チェックは domain-validation-service の composite_precondition_check パターン。図書館ドッグフーディングFR-017対策。"
      },
      "優先権のある操作可否": {
        "pattern_category": "domain-pattern",
        "confidence": 0.90,
        "trigger_keywords": ["優先権", "優先", "Ready状態の人", "先頭の人", "予約者のみ", "〜者優先", "優先的に"],
        "examples": [
          "Ready状態の予約者のみ貸出可能 → boundary-pattern（優先権）",
          "先頭の人のみ入場可能 → boundary-pattern + domain-ordered-queue",
          "予約者に優先的に貸出したい → boundary-pattern（優先権）"
        ],
        "decision_rule": "「特定の人のみ操作可能」という優先権判定は boundary-pattern の advanced_patterns.priority_based_decision を参照。図書館ドッグフーディングFR-021対策。"
      }
    },
    "selection_algorithm": {
      "step1": "ユーザーの要求からキーワードを抽出",
      "step2": "ai_decision_matrix でカテゴリを特定",
      "step3": "該当カテゴリ内でパターンを検索",
      "step4": "パターンのai_selection_hintsで最終確認",
      "step5": "confidence > 0.8 なら採用、そうでなければユーザーに確認"
    },
    "fallback_strategy": "判断に迷った場合は feature-slice をデフォルトで選択（垂直スライスが基本）"
  },
  "ai_usage_guide": {
    "how_to_reference": "AI は catalog/index.json を読み込み、必要なパターンの YAML ファイルを取得します",
    "pattern_selection_flow": [
      "1. ユーザーの要求を分析",
      "2. ai_decision_matrix で適切なカテゴリを判定",
      "3. catalog/index.json から該当パターンを検索",
      "4. パターンの YAML ファイルを読み込み",
      "5. ai_selection_hints で最終確認",
      "6. ★ domain_hints でドメイン固有の推奨パターンを確認",
      "7. テンプレートを実際のエンティティ名で置換",
      "8. 生成されたコードを提示"
    ],
    "domain_hints_usage": {
      "description": "Feature Sliceにはdomain_hintsが含まれ、ドメインに応じた追加パターンを自動推奨します",
      "flow": [
        "1. Feature Sliceを選択（例: feature-create-entity）",
        "2. ユーザーの要求からドメインキーワードを抽出（例: 予約、会議室）",
        "3. domain_hints.trigger_keywords でマッチするドメインを特定",
        "4. recommended_patterns の各パターンも合わせて適用",
        "5. ★ 非機能要件パターンも確認（下記参照）"
      ],
      "example": {
        "user_request": "会議室予約の作成機能を実装して",
        "primary_pattern": "feature-create-entity",
        "detected_domain": "予約・スケジュール系",
        "additional_patterns": [
          "domain-timeslot（時間枠の抽象化）",
          "domain-typed-id（BookingId, RoomIdの型安全性）",
          "domain-validation-service（重複チェック）",
          "query-get-by-period（期間での検索）",
          "concurrency-control（同時予約防止）"
        ]
      }
    },
    "nonfunctional_pattern_hints": {
      "description": "ドメイン特性に応じて推奨される非機能要件パターン。計画フェーズで必ず確認すること。",
      "domains": {
        "図書館・貸出管理": {
          "trigger_keywords": ["図書館", "貸出", "返却", "蔵書", "会員"],
          "recommended_behaviors": [
            {"id": "logging-behavior", "priority": "high", "reason": "運用トラブルシューティング"},
            {"id": "audit-log-behavior", "priority": "high", "reason": "貸出履歴の監査証跡（誰が何をいつ借りたか）"},
            {"id": "concurrency-control", "priority": "medium", "reason": "同一書籍の同時貸出競合防止"}
          ]
        },
        "金融・決済": {
          "trigger_keywords": ["決済", "支払い", "口座", "残高", "振込", "請求"],
          "recommended_behaviors": [
            {"id": "logging-behavior", "priority": "high", "reason": "取引ログ必須"},
            {"id": "audit-log-behavior", "priority": "critical", "reason": "金融規制コンプライアンス"},
            {"id": "idempotency-behavior", "priority": "critical", "reason": "二重決済防止"},
            {"id": "concurrency-control", "priority": "critical", "reason": "残高整合性"}
          ]
        },
        "医療・ヘルスケア": {
          "trigger_keywords": ["患者", "診療", "処方", "カルテ", "予約"],
          "recommended_behaviors": [
            {"id": "logging-behavior", "priority": "high", "reason": "診療記録追跡"},
            {"id": "audit-log-behavior", "priority": "critical", "reason": "医療法規制コンプライアンス"},
            {"id": "authorization-behavior", "priority": "critical", "reason": "患者情報アクセス制御"}
          ]
        },
        "EC・在庫管理": {
          "trigger_keywords": ["商品", "在庫", "注文", "カート", "出荷"],
          "recommended_behaviors": [
            {"id": "logging-behavior", "priority": "high", "reason": "注文追跡"},
            {"id": "concurrency-control", "priority": "high", "reason": "在庫引当競合防止"},
            {"id": "caching-behavior", "priority": "medium", "reason": "商品一覧の高速化"}
          ]
        },
        "汎用業務システム": {
          "trigger_keywords": [],
          "recommended_behaviors": [
            {"id": "logging-behavior", "priority": "high", "reason": "基本的な運用監視"},
            {"id": "validation-behavior", "priority": "critical", "reason": "入力検証は必須"},
            {"id": "transaction-behavior", "priority": "critical", "reason": "データ整合性"}
          ],
          "note": "キーワードに一致しない場合のデフォルト推奨"
        }
      },
      "usage_instruction": "計画フェーズで、ドメインキーワードから該当するdomainを特定し、recommended_behaviorsを確認すること"
    },
    "template_variables": {
      "EntityPascalCase": "エンティティ名（PascalCase）例: Product, Order, Customer",
      "EntityCamelCase": "エンティティ名（camelCase）例: product, order, customer",
      "BoundedContext": "境界コンテキスト名（PascalCase）例: ProductCatalog, PurchaseManagement"
    },
    "evidence_traceability": "各パターンの evidence フィールドに実装例のファイルパスが記載されています"
  },
  "version_policy": {
    "stability_levels": {
      "stable": "本番環境で使用可能。破壊的変更はメジャーバージョンアップ時のみ",
      "beta": "機能は動作するが、APIが変更される可能性あり",
      "alpha": "実験的機能。本番環境では使用非推奨",
      "deprecated": "非推奨。将来のバージョンで削除予定"
    },
    "versioning": "セマンティックバージョニング（major.minor.patch）に従います"
  }
}
