# Undiscretized Detection Guide

> **目的**: spec.yaml に含まれる「未離散化」の箇所を検出するためのガイド
>
> **バージョン**: v1.0.0
> **作成日**: 2025-12-14

---

## 概要

DSL（spec.yaml）に要求を書いても、以下の曖昧さが残っている場合がある:

| 曖昧さの種類 | DSLで解決可能か | 離散化で解決 |
|------------|:---------------:|:-----------:|
| 語彙の曖昧さ | △ | ✅ |
| 境界の曖昧さ | ✗ | ✅ |
| 価値判断の曖昧さ | ✗ | ✅ |
| 記述の曖昧さ | ✅ | - |

このガイドでは、spec.yaml を読んだ際に「未離散化」の箇所を検出するシグナルを定義する。

---

## 未離散化シグナル一覧

### 1. 語彙の曖昧さシグナル

| シグナル | 例 | 要アクション |
|---------|---|-------------|
| 形容詞の閾値未定義 | 「早い」「十分」「適切」「多い」 | しきい値テーブル化 |
| 程度の副詞 | 「なるべく」「できるだけ」「基本的に」 | 具体的な数値化 |
| 主観的な評価 | 「使いやすい」「わかりやすい」 | 測定可能な指標化 |
| 曖昧な頻度 | 「定期的に」「時々」「必要に応じて」 | スケジュール定義 |

**検出パターン（正規表現）**:
```regex
(適切|早い|十分|多い|少ない|重要|定期的|なるべく|できるだけ|基本的|使いやすい|わかりやすい)
```

---

### 2. 境界の曖昧さシグナル

| シグナル | 例 | 要アクション |
|---------|---|-------------|
| 範囲の未定義 | 「対象の〇〇」（範囲不明） | スコープ定義 |
| 閾値の未定義 | 「上限がある」（値不明） | 閾値定義 |
| 例外の羅列なし | 「例外はある」（具体例なし） | 例外の型化 |
| 条件の曖昧さ | 「〜の場合」（条件不明確） | 条件式の明示 |
| アクターの曖昧さ | 「〜できる」（誰が不明） | アクター定義 |

**検出パターン（正規表現）**:
```regex
(どこまで|範囲|上限|下限|例外|場合による|状況に応じて|〜できる$)
```

---

### 3. 価値判断の曖昧さシグナル

| シグナル | 例 | 要アクション |
|---------|---|-------------|
| 優先順位未定義 | 「バランスよく」「両立させる」 | 優先順位ルール化 |
| トレードオフ未定義 | 「コストとパフォーマンスを考慮」 | トレードオフ基準定義 |
| 柔軟性の程度不明 | 「柔軟に対応」「臨機応変に」 | ポリシー段階化 |
| 評価基準不明 | 「最適な」「ベストな」 | 評価指標定義 |

**検出パターン（正規表現）**:
```regex
(優先|バランス|両立|柔軟|臨機応変|最適|ベスト|考慮|トレードオフ)
```

---

### 4. 記述の曖昧さシグナル

| シグナル | 例 | 要アクション |
|---------|---|-------------|
| 主語抜け | 「〜できる」「〜する」 | 主語の補完 |
| 目的語抜け | 「検索する」（何を？） | 目的語の補完 |
| 参照抜け | 「上記のルール」「それに従う」 | 参照先の明示 |
| 矛盾 | 「3件まで」と「無制限」の共存 | 矛盾の解決 |

**検出パターン（正規表現）**:
```regex
(上記|下記|それ|これ|あれ|前述|後述|同様に)
```

---

## 検出ワークフロー

```
┌─────────────────────────────────────────────────────────────┐
│  1. spec.yaml を読み込む                                      │
│       ↓                                                     │
│  2. 各セクションを走査                                        │
│       ↓                                                     │
│  3. シグナルパターンでマッチング                               │
│       │                                                     │
│       ├─→ マッチあり → 曖昧さの種類を分類                     │
│       │       ↓                                             │
│       │   discretization-questions.yaml から質問生成          │
│       │       ↓                                             │
│       │   ユーザーに質問 → decisions.yaml に記録              │
│       │                                                     │
│       └─→ マッチなし → 次のセクションへ                       │
│       ↓                                                     │
│  4. 全セクション走査完了                                      │
│       ↓                                                     │
│  5. 検出結果レポート出力                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 検出結果レポートフォーマット

```markdown
## 未離散化検出レポート

### 検出サマリ

| 種類 | 検出数 | 解決済み | 未解決 |
|------|:------:|:-------:|:------:|
| 語彙の曖昧さ | 3 | 2 | 1 |
| 境界の曖昧さ | 2 | 2 | 0 |
| 価値判断の曖昧さ | 1 | 0 | 1 |
| 記述の曖昧さ | 0 | 0 | 0 |
| **合計** | **6** | **4** | **2** |

### 詳細

#### 語彙の曖昧さ

| 行 | 検出箇所 | シグナル | ステータス |
|----|---------|---------|-----------|
| 15 | 「早く返却処理したい」 | 「早く」 | ✅ 解決済み → D1 |
| 28 | 「十分な在庫」 | 「十分」 | ✅ 解決済み → D2 |
| 45 | 「適切な期間」 | 「適切」 | ⚠️ 未解決 |

#### 価値判断の曖昧さ

| 行 | 検出箇所 | シグナル | ステータス |
|----|---------|---------|-----------|
| 67 | 「柔軟に対応」 | 「柔軟」 | ⚠️ 未解決 |

### 未解決項目への推奨アクション

1. **L45「適切な期間」** → 閾値を定義（例: 7日、14日、30日から選択）
2. **L67「柔軟に対応」** → ポリシーレベルを定義（STRICT/BALANCED/LENIENT）
```

---

## 重大度レベル

未離散化の箇所には重大度を設定する:

| レベル | 説明 | 対応 |
|:------:|------|------|
| 🔴 Critical | 実装不可能 | 即時解決必須 |
| 🟠 High | 実装者判断で曖昧になる | 解決推奨 |
| 🟡 Medium | 将来の変更に影響 | 記録のみ可 |
| 🟢 Low | 影響軽微 | 省略可 |

### 重大度判定基準

```
🔴 Critical:
  - 閾値が不明で、実装者が任意の値を選ぶ必要がある
  - アクターが不明で、認可ロジックが書けない
  - 条件が矛盾していて、どちらを優先するか不明

🟠 High:
  - 「柔軟に」「状況に応じて」で、ポリシーが不明
  - 例外が「ある」と記載されているが、列挙されていない
  - 優先順位が「バランス」とだけ記載

🟡 Medium:
  - 「早い」「十分」で、SLAが未定義
  - 「定期的に」で、具体的なスケジュールが未定義

🟢 Low:
  - UIの文言で「わかりやすく」
  - ログの詳細度で「適切に」
```

---

## AI向けチェックリスト

spec.yaml を読んだ後、以下を確認:

### 必須チェック項目

- [ ] **閾値**: 数値が明記されているか？（「上限がある」ではなく「上限は3件」）
- [ ] **アクター**: 主語が明記されているか？（「〜できる」ではなく「会員は〜できる」）
- [ ] **条件**: 条件式が明記されているか？（「〜の場合」ではなく「延滞日数 >= 7日の場合」）
- [ ] **例外**: 例外が型化されているか？（「例外あり」ではなく「MATERIAL_TYPE, USER_ROLE」）
- [ ] **優先順位**: 衝突時のルールが明記されているか？

### 推奨チェック項目

- [ ] **SLA**: パフォーマンス目標が数値化されているか？
- [ ] **スケジュール**: 「定期的」が具体的な頻度になっているか？
- [ ] **ポリシー**: 「柔軟」がレベル化されているか？

---

## 関連ドキュメント

- `discretization-questions.yaml` - 離散化質問テンプレート
- `decisions-template.yaml` - 意思決定記録スキーマ
- `decision-guide.md` - 曖昧さ解決フロー

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0.0 | 2025-12-14 | 初版リリース |
